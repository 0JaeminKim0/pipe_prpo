<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRâ†’PO ìë™í™” AI Agent v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        .step-active { @apply bg-blue-600 text-white; }
        .step-completed { @apply bg-green-600 text-white; }
        .step-pending { @apply bg-gray-300 text-gray-600; }
        .urgency-urgent { @apply bg-red-50 border-l-4 border-red-500; }
        .urgency-normal { @apply bg-yellow-50 border-l-4 border-yellow-500; }
        .urgency-flexible { @apply bg-green-50 border-l-4 border-green-500; }
        .log-entry { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-item:hover { @apply bg-gray-100; }
        .sidebar-item.selected { @apply bg-blue-50 border-l-4 border-blue-600; }
        .tab-active { @apply bg-white border-b-2 border-blue-600 text-blue-600; }
        .tab-inactive { @apply bg-gray-100 text-gray-600 hover:bg-gray-200; }
        .card-stat { @apply bg-white rounded-lg shadow p-4 text-center; }
        .step-nav { @apply flex items-center cursor-pointer transition-all px-2 py-1 rounded-lg; }
        .step-nav:hover { @apply bg-blue-50; }
        .step-nav.active { @apply bg-blue-50; }
        .step-circle { @apply w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold transition-all flex-shrink-0; }
        .step-label { @apply text-xs ml-2 whitespace-nowrap hidden sm:block; }
        .step-line { @apply flex-shrink-0; }
        .mini-card { @apply bg-white rounded shadow p-3 text-center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">ğŸ¤–</span>
                    <h1 class="text-xl font-bold text-gray-800">PRâ†’PO ìë™í™” Agent <span class="text-sm font-normal text-gray-500">v2</span></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">ê¸°ì¤€ì¼: 2026-01-01</span>
                    <span id="llmStatus" class="text-sm px-2 py-1 rounded bg-gray-200">LLM í™•ì¸ì¤‘...</span>
                </div>
            </div>
        </header>

        <!-- 8-Step Progress Navigation -->
        <div class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex items-center">
                    <!-- Step 1 -->
                    <div class="step-nav" data-step="1" onclick="navigateToStep(1)" title="PR ë°ì´í„° ì ‘ìˆ˜ ë° í™•ì¸">
                        <div class="step-circle step-active" id="step-circle-1">1</div>
                        <span class="step-label">PR ì ‘ìˆ˜</span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="1"></div>
                    
                    <!-- Step 2 -->
                    <div class="step-nav" data-step="2" onclick="navigateToStep(2)" title="ê³„ì•½ ì—¬ë¶€ ë° ê¸´ê¸‰ë„ ë¶„ì„">
                        <div class="step-circle step-pending" id="step-circle-2">2</div>
                        <span class="step-label">ê³„ì•½/ê¸´ê¸‰ë„</span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="2"></div>
                    
                    <!-- Step 3 -->
                    <div class="step-nav" data-step="3" onclick="navigateToStep(3)" title="ìµœê·¼ ë‚©í’ˆ ì—…ì²´ ë° ë°œì£¼ ë°©ì‹ ê²€í† ">
                        <div class="step-circle step-pending" id="step-circle-3">3</div>
                        <span class="step-label">ì—…ì²´/ë°œì£¼</span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="3"></div>
                    
                    <!-- Step 4 -->
                    <div class="step-nav" data-step="4" onclick="navigateToStep(4)" title="ê²¬ì  ì˜ë¢°ì„œ ìƒì„±">
                        <div class="step-circle step-pending" id="step-circle-4">4</div>
                        <span class="step-label">ê²¬ì ì˜ë¢°</span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="4"></div>
                    
                    <!-- Step 5 -->
                    <div class="step-nav" data-step="5" onclick="navigateToStep(5)" title="ê²¬ì  ì˜ë¢° ì„¸ë¶€ ë‚´ìš© ê²€í† ">
                        <div class="step-circle step-pending" id="step-circle-5">5</div>
                        <span class="step-label">HITL ê²€í† </span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="5"></div>
                    
                    <!-- Step 6 -->
                    <div class="step-nav" data-step="6" onclick="navigateToStep(6)" title="ì…ì°° ì˜ˆì •ê°€ ì‚°ì¶œ">
                        <div class="step-circle step-pending" id="step-circle-6">6</div>
                        <span class="step-label">ì˜ˆì •ê°€</span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="6"></div>
                    
                    <!-- Step 7 -->
                    <div class="step-nav" data-step="7" onclick="navigateToStep(7)" title="ì—…ì²´ ê²¬ì  ìˆ˜ì‹  ê²°ê³¼">
                        <div class="step-circle step-pending" id="step-circle-7">7</div>
                        <span class="step-label">ê²¬ì ìˆ˜ì‹ </span>
                    </div>
                    <div class="w-6 h-0.5 bg-gray-300 step-line" data-line="7"></div>
                    
                    <!-- Step 8 -->
                    <div class="step-nav" data-step="8" onclick="navigateToStep(8)" title="ìµœì¢… ê²¬ì  ë¹„êµ">
                        <div class="step-circle step-pending" id="step-circle-8">8</div>
                        <span class="step-label">ê²¬ì ë¹„êµ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Dashboard (shows during processing) -->
        <div id="processingDashboard" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-spinner fa-spin text-xl"></i>
                        <div>
                            <p class="font-medium" id="dashboardStatus">AI ì²˜ë¦¬ ì¤‘...</p>
                            <p class="text-sm text-blue-100" id="dashboardStep">ë°ì´í„° ê²€ì¦</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6 text-sm">
                        <div class="text-center">
                            <p class="text-2xl font-bold" id="dashTotal">0</p>
                            <p class="text-blue-100">ì²˜ë¦¬ ê±´ìˆ˜</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-300" id="dashAuto">0</p>
                            <p class="text-blue-100">ìë™ì™„ë£Œ</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-orange-300" id="dashHITL">0</p>
                            <p class="text-blue-100">HITL</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold" id="dashLLM">0</p>
                            <p class="text-blue-100">LLM í˜¸ì¶œ</p>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="w-full bg-blue-400 rounded-full h-2">
                        <div id="dashProgress" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            
            <!-- ======================= STEP 1: PR ì ‘ìˆ˜ ê²€í†  ======================= -->
            <div id="step1" class="step-content">
                <div class="grid grid-cols-3 gap-6">
                    <!-- Left: Upload Panel -->
                    <div class="col-span-2 bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-bold mb-4">ğŸ“¥ PR ë°ì´í„° ì ‘ìˆ˜ ë° í™•ì¸</h2>
                        
                        <!-- Upload Area -->
                        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" class="hidden">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                            <p class="text-sm text-gray-400 mt-1">ğŸ“„ .xlsx, .xls ì§€ì›</p>
                        </div>

                        <!-- Quick Load -->
                        <div class="mt-4 text-center">
                            <button id="loadSampleBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                                ğŸ“‚ PR ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                            <p class="text-xs text-gray-400 mt-2">3ê°œ Excel íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ</p>
                        </div>

                        <!-- Uploaded Files -->
                        <div id="uploadedFiles" class="mt-4 hidden">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼</h3>
                            <div id="fileList" class="space-y-1 text-sm"></div>
                        </div>
                    </div>

                    <!-- Right: Summary Panel -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">ğŸ“Š ë°ì´í„° ìš”ì•½</h3>
                        
                        <div id="dataSummary" class="space-y-4">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</p>
                            </div>
                        </div>

                        <div id="summaryLoaded" class="hidden space-y-4">
                            <div class="mini-card border-l-4 border-blue-500">
                                <p class="text-2xl font-bold text-blue-600" id="prCount">0</p>
                                <p class="text-xs text-gray-600">PR ê±´ìˆ˜</p>
                            </div>
                            <div class="mini-card border-l-4 border-green-500">
                                <p class="text-2xl font-bold text-green-600" id="poCount">0</p>
                                <p class="text-xs text-gray-600">ë°œì£¼ì‹¤ì </p>
                            </div>
                            <div class="mini-card border-l-4 border-purple-500">
                                <p class="text-2xl font-bold text-purple-600" id="pzafCount">0</p>
                                <p class="text-xs text-gray-600">PZAF ìì¬</p>
                            </div>

                            <button id="startProcessBtn" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>
                                ğŸš€ AI ì²˜ë¦¬ ì‹œì‘
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Validation Results (after processing) -->
                <div id="validationResults" class="mt-6 hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">ğŸ“‹ ê²€ì¦ ê²°ê³¼</h3>
                            <div class="flex items-center space-x-4">
                                <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i><span id="validCount2">0</span>ê±´ ìœ íš¨</span>
                                <span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i><span id="invalidCount2">0</span>ê±´ ëˆ„ë½</span>
                            </div>
                        </div>
                        
                        <!-- Invalid PR Section -->
                        <div id="invalidSection" class="hidden">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-medium text-red-600">âš ï¸ ëˆ„ë½ PR (ì´ë©”ì¼ ë°œì†¡ í•„ìš”)</h4>
                                <button onclick="openBatchEmailModal()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-envelope mr-1"></i>ì¼ê´„ ë°œì†¡
                                </button>
                            </div>
                            <div class="border rounded overflow-hidden max-h-48 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                            <th class="px-3 py-2 text-left">ìì¬ë²ˆí˜¸</th>
                                            <th class="px-3 py-2 text-left">ëˆ„ë½í•­ëª©</th>
                                            <th class="px-3 py-2 text-left">ë‹´ë‹¹ì</th>
                                            <th class="px-3 py-2 text-left">ì•¡ì…˜</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invalidPRList"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-end">
                            <button onclick="goToStep(2)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ë‹¤ìŒ: ê³„ì•½ ì—¬ë¶€ ë° ê¸´ê¸‰ë„ ë¶„ì„ â†’
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= STEP 2: ê³„ì•½/ê¸´ê¸‰ë„ í™•ì¸ ======================= -->
            <div id="step2" class="step-content hidden">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left: ê³„ì•½ë¶„ë¥˜ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">ğŸ“‹ ê³„ì•½ ì—¬ë¶€ í™•ì¸ <span id="s2_contractFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all" onclick="filterContractList('í‘œì¤€ë‹¨ê°€')" id="card_standard">
                                <p class="text-xl font-bold text-blue-600" id="s2_standard">0</p>
                                <p class="text-xs text-gray-600">í‘œì¤€ë‹¨ê°€</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all" onclick="filterContractList('ë¹„í‘œì¤€ë‹¨ê°€')" id="card_nonStandard">
                                <p class="text-xl font-bold text-purple-600" id="s2_nonStandard">0</p>
                                <p class="text-xs text-gray-600">ë¹„í‘œì¤€ë‹¨ê°€</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-orange-300 transition-all" onclick="filterContractList('NA')" id="card_na">
                                <p class="text-xl font-bold text-orange-600" id="s2_na">0</p>
                                <p class="text-xs text-gray-600">ê²¬ì ëŒ€ìƒ</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í•„í„°ë§ | <button onclick="filterContractList('all')" class="text-blue-600 hover:underline">ì „ì²´ë³´ê¸°</button></span>
                            <span class="text-xs text-gray-400" id="s2_contractCount">0ê±´</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                        <th class="px-3 py-2 text-left">ê³„ì•½ë¶„ë¥˜</th>
                                        <th class="px-3 py-2 text-left">ë‹¨ê°€ê³„ì•½ë²ˆí˜¸</th>
                                    </tr>
                                </thead>
                                <tbody id="s2_contractList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right: ê¸´ê¸‰ë„ ë¶„ì„ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">â° ê¸´ê¸‰ë„ ë¶„ì„ <span class="text-xs font-normal text-gray-500">ê¸°ì¤€ì¼: 2026-01-01</span> <span id="s2_urgencyFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="mini-card border-l-4 border-red-500 cursor-pointer hover:ring-2 hover:ring-red-300 transition-all" onclick="filterUrgencyList('ê¸´ê¸‰')" id="card_urgent">
                                <p class="text-xl font-bold text-red-600" id="s2_urgent">0</p>
                                <p class="text-xs text-gray-600">ğŸ”´ ê¸´ê¸‰</p>
                            </div>
                            <div class="mini-card border-l-4 border-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-300 transition-all" onclick="filterUrgencyList('ì¼ë°˜')" id="card_normal">
                                <p class="text-xl font-bold text-yellow-600" id="s2_normal">0</p>
                                <p class="text-xs text-gray-600">ğŸŸ¡ ì¼ë°˜</p>
                            </div>
                            <div class="mini-card border-l-4 border-green-500 cursor-pointer hover:ring-2 hover:ring-green-300 transition-all" onclick="filterUrgencyList('ì—¬ìœ ')" id="card_flexible">
                                <p class="text-xl font-bold text-green-600" id="s2_flexible">0</p>
                                <p class="text-xs text-gray-600">ğŸŸ¢ ì—¬ìœ </p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í•„í„°ë§ | <button onclick="filterUrgencyList('all')" class="text-blue-600 hover:underline">ì „ì²´ë³´ê¸°</button></span>
                            <span class="text-xs text-gray-400" id="s2_urgencyCount">0ê±´</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                        <th class="px-3 py-2 text-left">ë‚©ê¸°ì¼</th>
                                        <th class="px-3 py-2 text-left">ì”ì—¬ì¼</th>
                                        <th class="px-3 py-2 text-left">ê¸´ê¸‰ë„</th>
                                    </tr>
                                </thead>
                                <tbody id="s2_urgencyList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(3)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ìµœê·¼ ë‚©í’ˆ ì—…ì²´ ë° ë°œì£¼ ë°©ì‹ ê²€í†  â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 3: ì—…ì²´/ë°œì£¼ë°©ì‹ íŒë‹¨ ======================= -->
            <div id="step3" class="step-content hidden">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left: ì—…ì²´ ë§¤ì¹­ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">ğŸ¢ ìµœê·¼ ë‚©í’ˆ ì—…ì²´ ê²€í†  <span id="s3_supplierFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="mini-card border-l-4 border-green-500 cursor-pointer hover:ring-2 hover:ring-green-300 transition-all" onclick="filterSupplierList('matched')" id="card_matched">
                                <p class="text-xl font-bold text-green-600" id="s3_matched">0</p>
                                <p class="text-xs text-gray-600">âœ… ë§¤ì¹­ì„±ê³µ</p>
                            </div>
                            <div class="mini-card border-l-4 border-red-500 cursor-pointer hover:ring-2 hover:ring-red-300 transition-all" onclick="filterSupplierList('unmatched')" id="card_unmatched">
                                <p class="text-xl font-bold text-red-600" id="s3_unmatched">0</p>
                                <p class="text-xs text-gray-600">âš ï¸ ì‹ ê·œì—…ì²´í•„ìš”</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í•„í„°ë§ | <button onclick="filterSupplierList('all')" class="text-blue-600 hover:underline">ì „ì²´ë³´ê¸°</button></span>
                            <span class="text-xs text-gray-400" id="s3_supplierCount">0ê±´</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                        <th class="px-3 py-2 text-left">ë§¤ì¹­ì—…ì²´</th>
                                        <th class="px-3 py-2 text-left">ìµœê·¼ë°œì£¼ë‹¨ê°€</th>
                                    </tr>
                                </thead>
                                <tbody id="s3_supplierList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right: ë°œì£¼ë°©ì‹ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">ğŸ“ ë°œì£¼ ë°©ì‹ ê²€í†  <span id="s3_methodFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all" onclick="filterMethodList('ìˆ˜ì˜ê³„ì•½')" id="card_direct">
                                <p class="text-xl font-bold text-blue-600" id="s3_direct">0</p>
                                <p class="text-xs text-gray-600">ìˆ˜ì˜ê³„ì•½</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all" onclick="filterMethodList('ì§€ëª…ê²½ìŸ')" id="card_bidding">
                                <p class="text-xl font-bold text-purple-600" id="s3_bidding">0</p>
                                <p class="text-xs text-gray-600">ì§€ëª…ê²½ìŸ</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í•„í„°ë§ | <button onclick="filterMethodList('all')" class="text-blue-600 hover:underline">ì „ì²´ë³´ê¸°</button></span>
                            <span class="text-xs text-gray-400" id="s3_methodCount">0ê±´</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                        <th class="px-3 py-2 text-left">ë°œì£¼ë°©ì‹</th>
                                        <th class="px-3 py-2 text-left">ì„ ì •ì‚¬ìœ </th>
                                    </tr>
                                </thead>
                                <tbody id="s3_methodList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(2)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(4)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ê²¬ì  ì˜ë¢°ì„œ ìƒì„± â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 4: ê²¬ì ì˜ë¢° ìƒì„± ======================= -->
            <div id="step4" class="step-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <!-- Header -->
                    <div class="p-4 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold">ğŸ“‹ ê²¬ì  ì˜ë¢°ì„œ ìƒì„±</h2>
                            <span class="text-gray-600">ì²˜ë¦¬í˜„í™©: <span id="quotationTotal">0</span>ê±´ ì¤‘ <span id="quotationAuto">0</span>ê±´ ìë™ì™„ë£Œ</span>
                        </div>
                        <!-- Filters -->
                        <div class="mt-3 flex space-x-3">
                            <select id="urgencyFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">ê¸´ê¸‰ë„: ì „ì²´</option>
                                <option value="ê¸´ê¸‰">ğŸ”´ ê¸´ê¸‰</option>
                                <option value="ì¼ë°˜">ğŸŸ¡ ì¼ë°˜</option>
                                <option value="ì—¬ìœ ">ğŸŸ¢ ì—¬ìœ </option>
                            </select>
                            <select id="contractFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">ê³„ì•½ë°©ì‹: ì „ì²´</option>
                                <option value="ìˆ˜ì˜ê³„ì•½">ìˆ˜ì˜ê³„ì•½</option>
                                <option value="ì§€ëª…ê²½ìŸ">ì§€ëª…ê²½ìŸ</option>
                            </select>
                            <select id="statusFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">ìƒíƒœ: ì „ì²´</option>
                                <option value="ìë™ì™„ë£Œ">âœ… ìë™ì™„ë£Œ</option>
                                <option value="ê²€í† í•„ìš”">âš ï¸ ê²€í† í•„ìš”</option>
                            </select>
                            <input type="text" id="searchInput" placeholder="ğŸ” ê²€ìƒ‰" class="text-sm border rounded px-3 py-2 flex-1">
                        </div>
                    </div>

                    <!-- Main Content: PR List + Detail -->
                    <div class="flex" style="min-height: 500px;">
                        <!-- Left: PR List -->
                        <div class="w-1/3 border-r">
                            <div id="prList" class="overflow-y-auto" style="max-height: 450px;"></div>
                            <div class="p-3 border-t bg-gray-50 text-sm">
                                <p>âœ… ìë™ì™„ë£Œ: <span id="autoCompleteCount">0</span>ê±´</p>
                                <p>âš ï¸ ê²€í† í•„ìš”: <span id="needReviewCount">0</span>ê±´</p>
                            </div>
                        </div>

                        <!-- Right: Detail View -->
                        <div class="w-2/3 overflow-y-auto" style="max-height: 500px;">
                            <div id="detailView" class="p-6">
                                <div class="text-center text-gray-500 py-16">
                                    <i class="fas fa-file-alt text-4xl mb-4"></i>
                                    <p>PRì„ ì„ íƒí•˜ë©´ ê²¬ì ì˜ë¢° ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(3)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(5)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ê²¬ì  ì˜ë¢° ì„¸ë¶€ ë‚´ìš© ê²€í†  â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 5: HITL ê²€í†  ======================= -->
            <div id="step5" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">âš ï¸ ê²¬ì  ì˜ë¢° ì„¸ë¶€ ë‚´ìš© ê²€í†  (HITL)</h2>
                        <div class="text-sm">
                            <span class="text-orange-600 font-medium"><span id="hitlTotalCount">0</span>ê±´</span> ê²€í†  í•„ìš”
                        </div>
                    </div>

                    <div id="hitlList" class="space-y-4">
                        <!-- HITL items will be rendered here -->
                    </div>

                    <div id="noHitlMessage" class="text-center py-12 text-gray-500 hidden">
                        <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                        <p class="text-lg">ê²€í† ê°€ í•„ìš”í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm">ëª¨ë“  PRì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(4)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(6)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ì…ì°° ì˜ˆì •ê°€ ì‚°ì¶œ â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 6: ì…ì°°ì˜ˆì •ê°€ ì‚°ì • ======================= -->
            <div id="step6" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-bold mb-4">ğŸ’° ì…ì°° ì˜ˆì •ê°€ ì‚°ì¶œ</h2>

                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="mini-card">
                            <p class="text-xl font-bold text-blue-600" id="s6_exact">0</p>
                            <p class="text-xs text-gray-600">ìì¬+ë‚´ì—­ ì¼ì¹˜</p>
                        </div>
                        <div class="mini-card">
                            <p class="text-xl font-bold text-green-600" id="s6_group">0</p>
                            <p class="text-xs text-gray-600">ê·¸ë£¹ í‰ê· </p>
                        </div>
                        <div class="mini-card">
                            <p class="text-xl font-bold text-purple-600" id="s6_llm">0</p>
                            <p class="text-xs text-gray-600">ğŸ§  LLM ì‚°ì •</p>
                        </div>
                        <div class="mini-card border-l-4 border-orange-500">
                            <p class="text-xl font-bold text-orange-600" id="s6_default">0</p>
                            <p class="text-xs text-gray-600">âš ï¸ ê¸°ë³¸ê°’</p>
                        </div>
                    </div>

                    <div class="border rounded max-h-80 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                    <th class="px-3 py-2 text-left">ìì¬ë‚´ì—­</th>
                                    <th class="px-3 py-2 text-left">ì‚°ì •ë°©ë²•</th>
                                    <th class="px-3 py-2 text-right">ì…ì°°ì˜ˆì •ê°€</th>
                                    <th class="px-3 py-2 text-center">ê°€ê²©ì¡°ì •</th>
                                </tr>
                            </thead>
                            <tbody id="s6_priceList"></tbody>
                        </table>
                    </div>

                    <div id="priceAlert" class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-700 hidden">
                        <i class="fas fa-info-circle mr-1"></i>ê¸°ë³¸ê°’ ì ìš© <span id="defaultCount">0</span>ê±´ â†’ ë‹´ë‹¹ì ì˜ˆì •ê°€ ì§ì ‘ ì…ë ¥ ê¶Œì¥
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(5)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(7)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ì—…ì²´ ê²¬ì  ìˆ˜ì‹  ê²°ê³¼ â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 7: ê²¬ì  ìˆ˜ì‹  í™•ì¸ (Mock) ======================= -->
            <div id="step7" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">ğŸ“¬ ì—…ì²´ ê²¬ì  ìˆ˜ì‹  ê²°ê³¼</h2>
                        <span class="text-sm text-gray-500">* Mock ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜</span>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="mini-card border-l-4 border-green-500">
                            <p class="text-2xl font-bold text-green-600" id="s7_received">0</p>
                            <p class="text-xs text-gray-600">âœ… ê²¬ì  ìˆ˜ì‹ </p>
                        </div>
                        <div class="mini-card border-l-4 border-yellow-500">
                            <p class="text-2xl font-bold text-yellow-600" id="s7_pending">0</p>
                            <p class="text-xs text-gray-600">â³ ëŒ€ê¸°ì¤‘</p>
                        </div>
                        <div class="mini-card border-l-4 border-red-500">
                            <p class="text-2xl font-bold text-red-600" id="s7_overdue">0</p>
                            <p class="text-xs text-gray-600">ğŸ”´ ë¯¸ì‘ë‹µ</p>
                        </div>
                    </div>

                    <div class="mb-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <button onclick="mockOpenQuotes()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                ğŸ“­ ê²¬ì  ì˜¤í”ˆ
                            </button>
                            <button onclick="sendReminderEmails()" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm">
                                ğŸ“§ ë…ë ¤ë©”ì¼ ë°œì†¡
                            </button>
                        </div>
                        <span class="text-sm text-gray-500">ì ‘ìˆ˜ê¸°í•œ: 2026-01-03</span>
                    </div>

                    <div class="border rounded max-h-72 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                    <th class="px-3 py-2 text-left">ì—…ì²´ëª…</th>
                                    <th class="px-3 py-2 text-left">ê²¬ì ìƒíƒœ</th>
                                    <th class="px-3 py-2 text-right">ê²¬ì ê¸ˆì•¡</th>
                                    <th class="px-3 py-2 text-left">ìˆ˜ì‹ ì¼ì‹œ</th>
                                </tr>
                            </thead>
                            <tbody id="s7_quoteList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(6)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(8)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ë‹¤ìŒ: ìµœì¢… ê²¬ì  ë¹„êµ â†’
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 8: ê²¬ì  ë¹„êµ ë¶„ì„ (Mock) ======================= -->
            <div id="step8" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">ğŸ“Š ìµœì¢… ê²¬ì  ë¹„êµ</h2>
                        <span class="text-sm text-gray-500">* Mock ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜</span>
                    </div>

                    <!-- Summary -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="mini-card border-l-4 border-green-500">
                            <p class="text-2xl font-bold text-green-600" id="s8_excellent">0</p>
                            <p class="text-xs text-gray-600">ğŸŸ¢ ìš°ìˆ˜</p>
                            <p class="text-xs text-green-500">ê²¬ì  â‰¤ ì˜ˆì •ê°€</p>
                        </div>
                        <div class="mini-card border-l-4 border-yellow-500">
                            <p class="text-2xl font-bold text-yellow-600" id="s8_normal">0</p>
                            <p class="text-xs text-gray-600">ğŸŸ¡ ë³´í†µ</p>
                            <p class="text-xs text-yellow-500">ì˜ˆì •ê°€ < ê²¬ì  â‰¤ ìµœê·¼ë°œì£¼ê°€</p>
                        </div>
                        <div class="mini-card border-l-4 border-red-500">
                            <p class="text-2xl font-bold text-red-600" id="s8_poor">0</p>
                            <p class="text-xs text-gray-600">ğŸ”´ ì—´ìœ„</p>
                            <p class="text-xs text-red-500">ê²¬ì  > ì˜ˆì •ê°€ & ìµœê·¼ë°œì£¼ê°€</p>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="mb-4">
                        <h3 class="font-medium mb-2">ğŸ† ê²¬ì  ê²½ìŸë ¥ ë¶„ì„</h3>
                        <div class="border rounded max-h-72 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PRë²ˆí˜¸</th>
                                        <th class="px-3 py-2 text-left">ì„ ì •ì—…ì²´</th>
                                        <th class="px-3 py-2 text-right">ê²¬ì ë‹¨ê°€</th>
                                        <th class="px-3 py-2 text-right">ì˜ˆì •ë‹¨ê°€</th>
                                        <th class="px-3 py-2 text-right">ìµœê·¼ë°œì£¼ë‹¨ê°€</th>
                                        <th class="px-3 py-2 text-center">ê²½ìŸë ¥</th>
                                    </tr>
                                </thead>
                                <tbody id="s8_comparisonList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Final Actions -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-green-800">ğŸ‰ ì²˜ë¦¬ ì™„ë£Œ</h3>
                                <p class="text-sm text-green-600 mt-1">ì²˜ë¦¬ì‹œê°„: <span id="s8_time">0</span>ì´ˆ | í† í°ì‚¬ìš©: <span id="s8_tokens">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(7)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        â† ì´ì „
                    </button>
                    <button onclick="goToStep(1)" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                        ì²˜ìŒìœ¼ë¡œ
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- HITL Review Modal -->
    <div id="hitlModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold">âš ï¸ ê²€í† í•„ìš” <span id="modalPrId"></span></h3>
            </div>
            <div class="p-6" id="modalContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeHitlModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
                <button onclick="submitHitlDecision()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">âœ… ê²°ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- Batch Email Modal -->
    <div id="batchEmailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold">ğŸ“§ ì´ë©”ì¼ ë°œì†¡ í™•ì¸</h3>
            </div>
            <div class="p-6" id="batchEmailContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeBatchEmailModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
                <button onclick="sendBatchEmails()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    <i class="fas fa-paper-plane mr-1"></i>ë°œì†¡
                </button>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div id="emailPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">ğŸ“§ ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
                <button onclick="closeEmailPreviewModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6" id="emailPreviewContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end">
                <button onclick="closeEmailPreviewModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-8 text-center">
                <div class="text-6xl mb-4">âœ…</div>
                <h3 class="text-xl font-bold mb-2" id="successTitle">ì™„ë£Œ</h3>
                <p class="text-gray-600 mb-6" id="successMessage">ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <button onclick="closeSuccessModal()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentStep = 1;
        let maxReachedStep = 1;
        let uploadedFiles = [];
        let quotationData = [];
        let selectedPR = null;
        let processingResults = null;
        let allPRData = [];
        let sentEmails = {};
        let mockQuoteStatus = {}; // For step 7 mock

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            setupDropZone();
            setupFilters();
        });

        async function checkHealth() {
            try {
                const res = await axios.get('/api/health');
                const llmStatus = document.getElementById('llmStatus');
                if (res.data.hasApiKey) {
                    llmStatus.textContent = 'ğŸ§  LLM í™œì„±í™”';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-green-100 text-green-800';
                } else {
                    llmStatus.textContent = 'âš ï¸ LLM ë¯¸ì„¤ì •';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function navigateToStep(step) {
            if (step > maxReachedStep && step > 1) {
                alert('AI ì²˜ë¦¬ë¥¼ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”.');
                return;
            }
            goToStep(step);
        }

        function goToStep(step) {
            currentStep = step;
            
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');

            // Update step indicators
            for (let i = 1; i <= 8; i++) {
                const circle = document.getElementById(`step-circle-${i}`);
                if (i < step) {
                    circle.className = 'step-circle step-completed';
                    circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
                } else if (i === step) {
                    circle.className = 'step-circle step-active';
                    circle.textContent = i;
                } else {
                    circle.className = 'step-circle step-pending';
                    circle.textContent = i;
                }
            }

            // Update step lines
            document.querySelectorAll('.step-line').forEach((el) => {
                const lineNum = parseInt(el.getAttribute('data-line'));
                if (lineNum < step) {
                    el.classList.remove('bg-gray-300');
                    el.classList.add('bg-green-500');
                } else {
                    el.classList.remove('bg-green-500');
                    el.classList.add('bg-gray-300');
                }
            });

            // Load data for specific steps
            if (step === 2) populateStep2();
            if (step === 3) populateStep3();
            if (step === 4) { renderPRList(); updateQuotationCounts(); }
            if (step === 5) populateStep5();
            if (step === 6) populateStep6();
            if (step === 7) populateStep7();
            if (step === 8) populateStep8();
        }

        // ============================================
        // STEP 1: FILE UPLOAD
        // ============================================
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                await handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', async (e) => {
                await handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            if (files.length === 0) return;
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            try {
                const res = await axios.post('/api/upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    updateDataSummary();
                    document.getElementById('startProcessBtn').disabled = false;
                }
            } catch (e) {
                alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
            }
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            const list = document.getElementById('fileList');
            container.classList.remove('hidden');
            list.innerHTML = uploadedFiles.map(f => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-file-excel text-green-600 mr-2"></i>
                        <span class="text-xs">${f.filename}</span>
                        <span class="text-xs text-gray-500 ml-1">(${f.rows.toLocaleString()}ê±´)</span>
                    </div>
                    <span class="text-green-600"><i class="fas fa-check"></i></span>
                </div>
            `).join('');
        }

        async function updateDataSummary() {
            try {
                const res = await axios.get('/api/summary');
                document.getElementById('dataSummary').classList.add('hidden');
                document.getElementById('summaryLoaded').classList.remove('hidden');
                document.getElementById('prCount').textContent = res.data.prTotal.toLocaleString();
                document.getElementById('poCount').textContent = res.data.poHistoryTotal.toLocaleString();
                document.getElementById('pzafCount').textContent = res.data.pzafCount.toLocaleString();
            } catch (e) {
                console.error('Summary fetch failed:', e);
            }
        }

        // Load Sample Data
        document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);

        async function loadSampleData() {
            const btn = document.getElementById('loadSampleBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const res = await axios.post('/api/load-sample');
                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    await updateDataSummary();
                    document.getElementById('startProcessBtn').disabled = false;
                    btn.innerHTML = '<i class="fas fa-check mr-1"></i>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-gray-400');
                }
            } catch (e) {
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“‚ PR ë¶ˆëŸ¬ì˜¤ê¸°';
            }
        }

        // Start Processing
        document.getElementById('startProcessBtn').addEventListener('click', startProcessing);

        async function startProcessing() {
            // Show processing dashboard
            document.getElementById('processingDashboard').classList.remove('hidden');
            document.getElementById('startProcessBtn').disabled = true;
            document.getElementById('startProcessBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ì²˜ë¦¬ì¤‘...';

            try {
                const res = await axios.post('/api/process');
                
                if (res.data.success) {
                    processingResults = res.data.results;
                    quotationData = res.data.results.quotationData || [];
                    allPRData = res.data.results.allPRData || quotationData;
                    
                    // Update dashboard with final stats
                    const summary = processingResults.summary;
                    document.getElementById('dashTotal').textContent = summary.total;
                    document.getElementById('dashAuto').textContent = summary.autoComplete;
                    document.getElementById('dashHITL').textContent = summary.needReview;
                    document.getElementById('dashLLM').textContent = summary.llmCalls;
                    document.getElementById('dashProgress').style.width = '100%';
                    document.getElementById('dashboardStatus').textContent = 'ì²˜ë¦¬ ì™„ë£Œ!';
                    document.getElementById('dashboardStep').textContent = `${summary.total}ê±´ ì²˜ë¦¬ ì™„ë£Œ`;
                    
                    maxReachedStep = 8; // All steps accessible
                    
                    // Show validation results in Step 1
                    showValidationResults();
                    
                    // Hide dashboard after delay
                    setTimeout(() => {
                        document.getElementById('processingDashboard').classList.add('hidden');
                    }, 3000);
                }
            } catch (e) {
                alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
            } finally {
                document.getElementById('startProcessBtn').innerHTML = 'ğŸš€ AI ì²˜ë¦¬ ì‹œì‘';
            }
        }

        function showValidationResults() {
            const results = document.getElementById('validationResults');
            results.classList.remove('hidden');
            
            const invalidPR = processingResults.invalidPR || [];
            const validCount = processingResults.summary.total;
            
            document.getElementById('validCount2').textContent = validCount.toLocaleString();
            document.getElementById('invalidCount2').textContent = invalidPR.length.toLocaleString();
            
            if (invalidPR.length > 0) {
                document.getElementById('invalidSection').classList.remove('hidden');
                document.getElementById('invalidPRList').innerHTML = invalidPR.slice(0, 30).map((pr, idx) => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">âš ï¸ ${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                        <td class="px-3 py-2">${pr['ìì¬ë²ˆí˜¸'] || '-'}</td>
                        <td class="px-3 py-2 text-red-600">${pr['ëˆ„ë½í•­ëª©'] || '-'}</td>
                        <td class="px-3 py-2">${pr['ë‹´ë‹¹ì'] || pr['êµ¬ë§¤ìš”ì²­ì'] || '-'}</td>
                        <td class="px-3 py-2">
                            <button onclick="openEmailPreview(${idx})" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                ğŸ“§ ë¯¸ë¦¬ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // ============================================
        // STEP 2: ê³„ì•½/ê¸´ê¸‰ë„ í™•ì¸
        // ============================================
        let s2ContractFilter = 'all';
        let s2UrgencyFilter = 'all';
        
        function populateStep2() {
            if (!processingResults) return;
            
            // Step 2ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš© (PZAF í•„í„°ë§ ì „)
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // ê³„ì•½ë¶„ë¥˜ ì¹´ìš´íŠ¸ ê³„ì‚°
            const standard = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'í‘œì¤€ë‹¨ê°€').length;
            const nonStandard = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'ë¹„í‘œì¤€ë‹¨ê°€').length;
            const na = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'NA' || !pr['ê³„ì•½ë¶„ë¥˜']).length;
            
            // ê¸´ê¸‰ë„ ì¹´ìš´íŠ¸ ê³„ì‚°
            const urgent = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰').length;
            const normal = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ì¼ë°˜').length;
            const flexible = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ì—¬ìœ ').length;
            
            document.getElementById('s2_standard').textContent = standard.toLocaleString();
            document.getElementById('s2_nonStandard').textContent = nonStandard.toLocaleString();
            document.getElementById('s2_na').textContent = na.toLocaleString();
            document.getElementById('s2_urgent').textContent = urgent.toLocaleString();
            document.getElementById('s2_normal').textContent = normal.toLocaleString();
            document.getElementById('s2_flexible').textContent = flexible.toLocaleString();
            
            // Initial render with all data
            filterContractList(s2ContractFilter);
            filterUrgencyList(s2UrgencyFilter);
        }
        
        function filterContractList(filterType) {
            s2ContractFilter = filterType;
            
            // Step 2ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš©
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_standard', 'card_nonStandard', 'card_na'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-blue-500', 'ring-purple-500', 'ring-orange-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === 'í‘œì¤€ë‹¨ê°€') {
                filtered = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'í‘œì¤€ë‹¨ê°€');
                document.getElementById('card_standard')?.classList.add('ring-2', 'ring-blue-500');
                filterLabel = '(í‘œì¤€ë‹¨ê°€)';
            } else if (filterType === 'ë¹„í‘œì¤€ë‹¨ê°€') {
                filtered = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'ë¹„í‘œì¤€ë‹¨ê°€');
                document.getElementById('card_nonStandard')?.classList.add('ring-2', 'ring-purple-500');
                filterLabel = '(ë¹„í‘œì¤€ë‹¨ê°€)';
            } else if (filterType === 'NA') {
                filtered = data.filter(pr => pr['ê³„ì•½ë¶„ë¥˜'] === 'NA' || !pr['ê³„ì•½ë¶„ë¥˜']);
                document.getElementById('card_na')?.classList.add('ring-2', 'ring-orange-500');
                filterLabel = '(ê²¬ì ëŒ€ìƒ)';
            }
            
            document.getElementById('s2_contractFilter').textContent = filterLabel;
            document.getElementById('s2_contractCount').textContent = `${filtered.length}ê±´`;
            
            document.getElementById('s2_contractList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-0.5 rounded text-xs ${pr['ê³„ì•½ë¶„ë¥˜'] === 'í‘œì¤€ë‹¨ê°€' ? 'bg-blue-100 text-blue-800' : pr['ê³„ì•½ë¶„ë¥˜'] === 'NA' ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800'}">
                            ${pr['ê³„ì•½ë¶„ë¥˜'] || '-'}
                        </span>
                    </td>
                    <td class="px-3 py-2">${pr['ë‹¨ê°€ê³„ì•½ë²ˆí˜¸'] || '-'}</td>
                </tr>
            `).join('');
        }
        
        function filterUrgencyList(filterType) {
            s2UrgencyFilter = filterType;
            
            // Step 2ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš©
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_urgent', 'card_normal', 'card_flexible'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-red-500', 'ring-yellow-500', 'ring-green-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === 'ê¸´ê¸‰') {
                filtered = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰');
                document.getElementById('card_urgent')?.classList.add('ring-2', 'ring-red-500');
                filterLabel = '(ê¸´ê¸‰)';
            } else if (filterType === 'ì¼ë°˜') {
                filtered = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ì¼ë°˜');
                document.getElementById('card_normal')?.classList.add('ring-2', 'ring-yellow-500');
                filterLabel = '(ì¼ë°˜)';
            } else if (filterType === 'ì—¬ìœ ') {
                filtered = data.filter(pr => pr['ê¸´ê¸‰ë„'] === 'ì—¬ìœ ');
                document.getElementById('card_flexible')?.classList.add('ring-2', 'ring-green-500');
                filterLabel = '(ì—¬ìœ )';
            }
            
            // Sort by ì‹¤ì œì”ì—¬ì¼ìˆ˜ ascending (most urgent first)
            filtered.sort((a, b) => {
                const aRemain = a['ì‹¤ì œì”ì—¬ì¼ìˆ˜'] ?? 999;
                const bRemain = b['ì‹¤ì œì”ì—¬ì¼ìˆ˜'] ?? 999;
                return aRemain - bRemain;
            });
            
            document.getElementById('s2_urgencyFilter').textContent = filterLabel;
            document.getElementById('s2_urgencyCount').textContent = `${filtered.length}ê±´`;
            
            document.getElementById('s2_urgencyList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50 ${pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰' ? 'bg-red-50' : ''}">
                    <td class="px-3 py-2">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸'] || 'ğŸŸ¡'} ${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                    <td class="px-3 py-2">${pr['PRë‚©ê¸°ì¼_ë³€í™˜'] || pr['PRë‚©ê¸°ì¼'] || '-'}</td>
                    <td class="px-3 py-2 ${(pr['ì‹¤ì œì”ì—¬ì¼ìˆ˜'] ?? 999) <= 0 ? 'text-red-600 font-bold' : ''}">${pr['ì‹¤ì œì”ì—¬ì¼ìˆ˜'] ?? '-'}ì¼</td>
                    <td class="px-3 py-2">
                        <span class="${pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰' ? 'text-red-600' : pr['ê¸´ê¸‰ë„'] === 'ì¼ë°˜' ? 'text-yellow-600' : 'text-green-600'}">${pr['ê¸´ê¸‰ë„'] || '-'}</span>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // STEP 3: ì—…ì²´/ë°œì£¼ë°©ì‹ íŒë‹¨
        // ============================================
        let s3SupplierFilter = 'all';
        let s3MethodFilter = 'all';
        
        function populateStep3() {
            if (!processingResults) return;
            
            // Step 3ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš© (PZAF í•„í„°ë§ ì „)
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            const matched = data.filter(pr => pr['ì—…ì²´ë§¤ì¹­ì—¬ë¶€']).length;
            const unmatched = data.length - matched;
            const direct = data.filter(pr => pr['ê³„ì•½ë°©ì‹'] === 'ìˆ˜ì˜ê³„ì•½').length;
            const bidding = data.filter(pr => pr['ê³„ì•½ë°©ì‹'] === 'ì§€ëª…ê²½ìŸ').length;
            
            document.getElementById('s3_matched').textContent = matched.toLocaleString();
            document.getElementById('s3_unmatched').textContent = unmatched.toLocaleString();
            document.getElementById('s3_direct').textContent = direct.toLocaleString();
            document.getElementById('s3_bidding').textContent = bidding.toLocaleString();
            
            // Initial render with current filter
            filterSupplierList(s3SupplierFilter);
            filterMethodList(s3MethodFilter);
        }
        
        function filterSupplierList(filterType) {
            s3SupplierFilter = filterType;
            
            // Step 3ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš©
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_matched', 'card_unmatched'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-green-500', 'ring-red-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === 'matched') {
                filtered = data.filter(pr => pr['ì—…ì²´ë§¤ì¹­ì—¬ë¶€']);
                document.getElementById('card_matched')?.classList.add('ring-2', 'ring-green-500');
                filterLabel = '(ë§¤ì¹­ì„±ê³µ)';
            } else if (filterType === 'unmatched') {
                filtered = data.filter(pr => !pr['ì—…ì²´ë§¤ì¹­ì—¬ë¶€']);
                document.getElementById('card_unmatched')?.classList.add('ring-2', 'ring-red-500');
                filterLabel = '(ì‹ ê·œì—…ì²´í•„ìš”)';
            }
            
            document.getElementById('s3_supplierFilter').textContent = filterLabel;
            document.getElementById('s3_supplierCount').textContent = `${filtered.length}ê±´`;
            
            document.getElementById('s3_supplierList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50 ${!pr['ì—…ì²´ë§¤ì¹­ì—¬ë¶€'] ? 'bg-red-50' : ''}">
                    <td class="px-3 py-2">${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                    <td class="px-3 py-2">${pr['ë§¤ì¹­ì—…ì²´ëª…'] || '<span class="text-red-500">ì‹ ê·œí•„ìš”</span>'}</td>
                    <td class="px-3 py-2">â‚©${(pr['ìµœê·¼ë°œì£¼ë‹¨ê°€'] || 0).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        function filterMethodList(filterType) {
            s3MethodFilter = filterType;
            
            // Step 3ëŠ” ì „ì²´ PR ë°ì´í„° ì‚¬ìš©
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_direct', 'card_bidding'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-blue-500', 'ring-purple-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === 'ìˆ˜ì˜ê³„ì•½') {
                filtered = data.filter(pr => pr['ê³„ì•½ë°©ì‹'] === 'ìˆ˜ì˜ê³„ì•½');
                document.getElementById('card_direct')?.classList.add('ring-2', 'ring-blue-500');
                filterLabel = '(ìˆ˜ì˜ê³„ì•½)';
            } else if (filterType === 'ì§€ëª…ê²½ìŸ') {
                filtered = data.filter(pr => pr['ê³„ì•½ë°©ì‹'] === 'ì§€ëª…ê²½ìŸ');
                document.getElementById('card_bidding')?.classList.add('ring-2', 'ring-purple-500');
                filterLabel = '(ì§€ëª…ê²½ìŸ)';
            }
            
            document.getElementById('s3_methodFilter').textContent = filterLabel;
            document.getElementById('s3_methodCount').textContent = `${filtered.length}ê±´`;
            
            document.getElementById('s3_methodList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                    <td class="px-3 py-2">
                        <span class="${pr['ê³„ì•½ë°©ì‹'] === 'ìˆ˜ì˜ê³„ì•½' ? 'text-blue-600' : 'text-purple-600'}">${pr['ê³„ì•½ë°©ì‹'] || '-'}</span>
                    </td>
                    <td class="px-3 py-2 text-xs truncate max-w-xs">${(pr['ê³„ì•½ë°©ì‹_ì„ ì •ì‚¬ìœ '] || '').substring(0, 30)}...</td>
                </tr>
            `).join('');
        }

        // ============================================
        // STEP 4: ê²¬ì ì˜ë¢° ê´€ë¦¬
        // ============================================
        function setupFilters() {
            document.getElementById('urgencyFilter').addEventListener('change', renderPRList);
            document.getElementById('contractFilter').addEventListener('change', renderPRList);
            document.getElementById('statusFilter').addEventListener('change', renderPRList);
            document.getElementById('searchInput').addEventListener('input', renderPRList);
        }

        function updateQuotationCounts() {
            document.getElementById('quotationTotal').textContent = quotationData.length;
            document.getElementById('quotationAuto').textContent = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ').length;
        }

        function renderPRList() {
            const urgencyFilter = document.getElementById('urgencyFilter').value;
            const contractFilter = document.getElementById('contractFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filtered = [...quotationData];
            if (urgencyFilter !== 'all') filtered = filtered.filter(pr => pr['ê¸´ê¸‰ë„'] === urgencyFilter);
            if (contractFilter !== 'all') filtered = filtered.filter(pr => pr['ê³„ì•½ë°©ì‹'] === contractFilter);
            if (statusFilter !== 'all') filtered = filtered.filter(pr => pr['ì²˜ë¦¬ìƒíƒœ'] === statusFilter);
            if (searchText) {
                filtered = filtered.filter(pr => 
                    (pr['êµ¬ë§¤ìš”ì²­'] || '').toLowerCase().includes(searchText) ||
                    (pr['ìì¬ë²ˆí˜¸'] || '').toLowerCase().includes(searchText) ||
                    (pr['ë‚´ì—­'] || '').toLowerCase().includes(searchText)
                );
            }

            const container = document.getElementById('prList');
            container.innerHTML = filtered.map(pr => {
                const urgencyClass = pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰' ? 'urgency-urgent' : 
                                    pr['ê¸´ê¸‰ë„'] === 'ì¼ë°˜' ? 'urgency-normal' : 'urgency-flexible';
                const statusIcon = pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'âœ…' : 'âš ï¸';
                
                return `
                    <div class="sidebar-item p-3 border-b cursor-pointer ${urgencyClass} ${selectedPR === pr['êµ¬ë§¤ìš”ì²­'] ? 'selected' : ''}"
                         onclick="selectPR('${pr['êµ¬ë§¤ìš”ì²­']}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-sm">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸'] || 'ğŸŸ¡'} ${pr['êµ¬ë§¤ìš”ì²­']}</p>
                                <p class="text-xs text-gray-600 truncate" style="max-width: 180px;">${pr['ë‚´ì—­'] || ''}</p>
                            </div>
                            <span class="text-sm">${statusIcon}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${pr['ê³„ì•½ë°©ì‹'] || ''} | ${pr['ê¸´ê¸‰ë„'] || ''}
                        </div>
                    </div>
                `;
            }).join('');

            const autoComplete = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ').length;
            const needReview = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ê²€í† í•„ìš”').length;
            document.getElementById('autoCompleteCount').textContent = autoComplete;
            document.getElementById('needReviewCount').textContent = needReview;
        }

        function selectPR(prId) {
            selectedPR = prId;
            renderPRList();
            renderDetailView(prId);
        }

        function renderDetailView(prId) {
            const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
            if (!pr) return;

            const container = document.getElementById('detailView');
            const estimatedPrice = pr['ì…ì°°ì˜ˆì •ê°€'] || 0;
            const exchangeRate = 1453;
            const estimatedPriceUSD = Math.round(estimatedPrice / exchangeRate);
            const randomVendors = pr['ì´ˆì²­í˜‘ë ¥íšŒì‚¬'] || generateRandomVendors(pr);

            container.innerHTML = `
                <div class="space-y-4">
                    <!-- Header -->
                    <div class="flex justify-between items-start pb-3 border-b">
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs">ê²¬ì ì˜ë¢°ë²ˆí˜¸</span>
                                <span class="font-bold">RFQ-${pr['êµ¬ë§¤ìš”ì²­']}</span>
                            </div>
                            <p class="text-gray-600 text-xs">ì°¨ìˆ˜: 1</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                        }">
                            ${pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'âœ… ìë™ì™„ë£Œ' : 'âš ï¸ ê²€í† í•„ìš”'}
                        </span>
                    </div>

                    <!-- ê¸°ë³¸ì •ë³´ -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">ê¸°ë³¸ì •ë³´</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">ì…ì°°ëª©ì ë¬¼</span><p class="font-medium truncate">${pr['ë‚´ì—­'] || '-'}</p></div>
                            <div><span class="text-gray-500">ì†Œì‹±ê·¸ë£¹</span><p class="font-medium">${pr['ì†Œì‹±ê·¸ë£¹'] || '-'}</p></div>
                            <div><span class="text-gray-500">êµ¬ë§¤ë‹´ë‹¹</span><p class="font-medium">${pr['êµ¬ë§¤ì›'] || '-'}</p></div>
                            <div><span class="text-gray-500">ì‹œë¦¬ì¦ˆí˜¸ì„ </span><p class="font-medium">${(pr['ìì¬ë²ˆí˜¸'] || '').substring(0, 4) || '-'}</p></div>
                            <div><span class="text-gray-500">ì¼ë°˜/ê¸´ê¸‰</span><p class="font-medium">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸'] || ''} ${pr['ê¸´ê¸‰ë„'] || '-'}</p></div>
                        </div>
                    </div>

                    <!-- ê³„ì•½ì •ë³´ -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">ê³„ì•½ì •ë³´</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">ê³„ì•½ë°©ì‹</span><p class="font-medium">${pr['ê³„ì•½ë°©ì‹'] || '-'}</p></div>
                            <div><span class="text-gray-500">ê³„ì•½ëŒ€ìƒìì„ ì •ë°©ì‹</span><p class="font-medium">ìµœì €ê°€</p></div>
                            <div><span class="text-gray-500">ë‹¨ê°€ê³„ì•½ì—¬ë¶€</span><p class="font-medium">${pr['ê³„ì•½ë¶„ë¥˜'] || '-'}</p></div>
                            <div><span class="text-gray-500">ë‹¨ê°€ê³„ì•½ë²ˆí˜¸</span><p class="font-medium">${pr['ë‹¨ê°€ê³„ì•½ë²ˆí˜¸'] || '-'}</p></div>
                        </div>
                    </div>

                    <!-- ì…ì°°ì¡°ê±´ -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">ì…ì°°ì¡°ê±´</h4>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">ì¡°ê±´ë³€ê²½</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div><span class="text-gray-500">ì—…ì²´ì„ ì •</span><p class="font-medium">ë¬¸ì„œë³„</p></div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">ë¶€ë¶„ì…ì°°</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">ì „ìê³„ì•½</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">AVLí’ˆëª©</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                        </div>
                    </div>

                    <!-- ìˆ˜ëŸ‰ì •ë³´ -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">ìˆ˜ëŸ‰ì •ë³´</h4>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div><span class="text-gray-500">ìš”ì²­ìˆ˜ëŸ‰</span><p class="font-medium">${pr['ìš”ì²­ìˆ˜ëŸ‰'] || '-'} ${pr['UOM'] || 'EA'}</p></div>
                            <div><span class="text-gray-500">ì´ì¤‘ëŸ‰(KG)</span><p class="font-medium">${pr['ë§¤ì¹­_ë°œì£¼ì¤‘ëŸ‰'] || pr['ì´ì¤‘ëŸ‰'] || '-'}</p></div>
                        </div>
                    </div>

                    <!-- í˜‘ë ¥íšŒì‚¬ -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">ì´ˆì²­í˜‘ë ¥íšŒì‚¬ <span class="text-gray-400">(2~3ê°œ ëœë¤)</span></h4>
                        <div class="space-y-1">
                            ${randomVendors.map(vendor => `
                                <label class="flex items-center text-xs">
                                    <input type="checkbox" checked class="mr-2">
                                    <span>${vendor.name} ${vendor.isMatched ? '<span class="text-blue-600">(ë§¤ì¹­)</span>' : ''}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="mt-2 p-2 bg-gray-200 rounded text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>ì´ì „ê²¬ì ì˜ë¢° ìµœê³ í‰ê°€í˜‘ë ¥ì‚¬ ëˆ„ë½ ì—¬ë¶€
                        </div>
                    </div>

                    <!-- AI íŒë‹¨ -->
                    <div class="bg-purple-50 border border-purple-200 rounded p-3">
                        <h4 class="font-medium text-purple-800 text-xs mb-2">ğŸ§  AI íŒë‹¨</h4>
                        <div class="space-y-1 text-xs">
                            <p><strong>ì˜ˆì •ê°€ ì‚°ì •:</strong> ${pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] || '-'}</p>
                            ${pr['HITLí•„ìš”'] ? '<p class="text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i>ë‹´ë‹¹ì ê²€í†  í•„ìš”</p>' : ''}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-end space-x-2 pt-3 border-t">
                        ${pr['HITLí•„ìš”'] ? `
                            <button onclick="openHitlModal('${pr['êµ¬ë§¤ìš”ì²­']}')" class="px-3 py-1.5 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">
                                âš ï¸ ê²€í† 
                            </button>
                        ` : ''}
                        <button onclick="approvePR('${pr['êµ¬ë§¤ìš”ì²­']}')" class="px-3 py-1.5 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            SRM ì „ì†¡
                        </button>
                    </div>
                </div>
            `;
        }

        function generateRandomVendors(pr) {
            const sampleVendors = ['(ì£¼)ëŒ€í•œë°°ê´€', 'ì‚¼ì„±ì¤‘ê³µì—…', 'í˜„ëŒ€ìŠ¤í‹¸', 'í¬ìŠ¤ì½”ê±´ì„¤', 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', 'STXì¤‘ê³µì—…', 'ëŒ€ìš°ì¡°ì„ í•´ì–‘', 'SKì—ì½”í”ŒëœíŠ¸', 'ë‘ì‚°ì¤‘ê³µì—…', 'GSê±´ì„¤'];
            const vendors = [];
            if (pr['ë§¤ì¹­ì—…ì²´ëª…']) vendors.push({ name: pr['ë§¤ì¹­ì—…ì²´ëª…'], isMatched: true });
            const count = pr['ë§¤ì¹­ì—…ì²´ëª…'] ? Math.floor(Math.random() * 2) + 1 : Math.floor(Math.random() * 2) + 2;
            const shuffled = sampleVendors.filter(v => v !== pr['ë§¤ì¹­ì—…ì²´ëª…']).sort(() => 0.5 - Math.random());
            for (let i = 0; i < count && i < shuffled.length; i++) {
                vendors.push({ name: shuffled[i], isMatched: false });
            }
            return vendors;
        }

        // ============================================
        // STEP 5: HITL ê²€í† 
        // ============================================
        function populateStep5() {
            if (!processingResults) return;
            
            const hitlItems = quotationData.filter(pr => pr['HITLí•„ìš”']);
            document.getElementById('hitlTotalCount').textContent = hitlItems.length;
            
            if (hitlItems.length === 0) {
                document.getElementById('noHitlMessage').classList.remove('hidden');
                document.getElementById('hitlList').classList.add('hidden');
                return;
            }
            
            document.getElementById('noHitlMessage').classList.add('hidden');
            document.getElementById('hitlList').classList.remove('hidden');
            
            document.getElementById('hitlList').innerHTML = hitlItems.map(pr => `
                <div class="border rounded-lg p-4 hover:shadow transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="font-bold">${pr['êµ¬ë§¤ìš”ì²­']}</span>
                            <span class="text-sm text-gray-500 ml-2">${pr['ê³„ì•½ë°©ì‹'] || '-'}</span>
                        </div>
                        <span class="px-2 py-1 rounded text-xs ${pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸']} ${pr['ê¸´ê¸‰ë„']}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2 truncate">${pr['ë‚´ì—­'] || '-'}</p>
                    <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                        <div><span class="text-gray-500">ì…ì°°ì˜ˆì •ê°€</span><p class="font-medium">â‚©${(pr['ì…ì°°ì˜ˆì •ê°€'] || 0).toLocaleString()}</p></div>
                        <div><span class="text-gray-500">ìµœê·¼ë°œì£¼ë‹¨ê°€</span><p class="font-medium">â‚©${(pr['ìµœê·¼ë°œì£¼ë‹¨ê°€'] || 0).toLocaleString()}</p></div>
                        <div><span class="text-gray-500">ë‹¨ê°€ë³€ë™ë¥ </span><p class="font-medium ${(pr['ë‹¨ê°€ë³€ë™ë¥ '] || 0) > 15 ? 'text-red-600' : ''}">${(pr['ë‹¨ê°€ë³€ë™ë¥ '] || 0).toFixed(1)}%</p></div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="openHitlModal('${pr['êµ¬ë§¤ìš”ì²­']}')" class="px-4 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">
                            ê²€í† í•˜ê¸° â†’
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // STEP 6: ì…ì°°ì˜ˆì •ê°€ ì‚°ì •
        // ============================================
        function populateStep6() {
            if (!processingResults) return;
            const priceMethods = processingResults.summary.priceMethodSummary || {};
            
            const exact = priceMethods['ìì¬+ë‚´ì—­ ì¼ì¹˜'] || 0;
            const group = priceMethods['ê·¸ë£¹ í‰ê· '] || 0;
            const llm = priceMethods['LLM ì‚°ì •'] || 0;
            const def = priceMethods['ê¸°ë³¸ê°’'] || 0;
            
            document.getElementById('s6_exact').textContent = exact.toLocaleString();
            document.getElementById('s6_group').textContent = group.toLocaleString();
            document.getElementById('s6_llm').textContent = llm.toLocaleString();
            document.getElementById('s6_default').textContent = def.toLocaleString();
            
            if (def > 0) {
                document.getElementById('priceAlert').classList.remove('hidden');
                document.getElementById('defaultCount').textContent = def;
            }
            
            document.getElementById('s6_priceList').innerHTML = quotationData.slice(0, 50).map((pr, idx) => `
                <tr class="border-b hover:bg-gray-50" id="price-row-${idx}">
                    <td class="px-3 py-2">${pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] === 'LLM ì‚°ì •' ? 'ğŸ§ ' : pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] === 'ê¸°ë³¸ê°’' ? 'âš ï¸' : 'âœ…'} ${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                    <td class="px-3 py-2 truncate max-w-xs">${(pr['ë‚´ì—­'] || '').substring(0, 25)}...</td>
                    <td class="px-3 py-2">
                        <span class="px-1 py-0.5 rounded text-xs ${
                            pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] === 'ìì¬+ë‚´ì—­ ì¼ì¹˜' ? 'bg-blue-100 text-blue-800' :
                            pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] === 'ê·¸ë£¹ í‰ê· ' ? 'bg-green-100 text-green-800' :
                            pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] === 'LLM ì‚°ì •' ? 'bg-purple-100 text-purple-800' :
                            'bg-orange-100 text-orange-800'
                        }">${pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] || '-'}</span>
                    </td>
                    <td class="px-3 py-2 text-right">
                        <span id="price-value-${idx}">â‚©${(pr['ì…ì°°ì˜ˆì •ê°€'] || 0).toLocaleString()}</span>
                        <span id="price-adjust-${idx}" class="text-xs text-gray-500 ml-1"></span>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <button onclick="adjustPrice(${idx}, -5)" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200" title="-5%">-5%</button>
                            <button onclick="adjustPrice(${idx}, 5)" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200" title="+5%">+5%</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // ê°€ê²© ì¡°ì • ì¶”ì  ê°ì²´
        let priceAdjustments = {};
        
        function adjustPrice(idx, percent) {
            const pr = quotationData[idx];
            if (!pr) return;
            
            const originalPrice = pr['ì…ì°°ì˜ˆì •ê°€_ì›ë³¸'] || pr['ì…ì°°ì˜ˆì •ê°€'] || 0;
            
            // ì›ë³¸ ê°€ê²© ì €ì¥ (ì²˜ìŒ ì¡°ì •ì‹œ)
            if (!pr['ì…ì°°ì˜ˆì •ê°€_ì›ë³¸']) {
                pr['ì…ì°°ì˜ˆì •ê°€_ì›ë³¸'] = pr['ì…ì°°ì˜ˆì •ê°€'] || 0;
            }
            
            // í˜„ì¬ ì¡°ì • ë¹„ìœ¨ ê³„ì‚°
            const currentAdjust = priceAdjustments[idx] || 0;
            const newAdjust = currentAdjust + percent;
            
            // ì¡°ì • ë¹„ìœ¨ ì œí•œ (-50% ~ +50%)
            if (newAdjust < -50 || newAdjust > 50) {
                alert('ê°€ê²© ì¡°ì • ë²”ìœ„ëŠ” -50% ~ +50% ì…ë‹ˆë‹¤.');
                return;
            }
            
            priceAdjustments[idx] = newAdjust;
            
            // ìƒˆ ê°€ê²© ê³„ì‚°
            const newPrice = Math.round(originalPrice * (1 + newAdjust / 100));
            pr['ì…ì°°ì˜ˆì •ê°€'] = newPrice;
            
            // UI ì—…ë°ì´íŠ¸
            const priceEl = document.getElementById(`price-value-${idx}`);
            const adjustEl = document.getElementById(`price-adjust-${idx}`);
            
            if (priceEl) {
                priceEl.textContent = `â‚©${newPrice.toLocaleString()}`;
                priceEl.className = newAdjust !== 0 ? 'font-bold text-blue-600' : '';
            }
            if (adjustEl) {
                if (newAdjust !== 0) {
                    adjustEl.textContent = `(${newAdjust > 0 ? '+' : ''}${newAdjust}%)`;
                    adjustEl.className = `text-xs ml-1 ${newAdjust > 0 ? 'text-green-600' : 'text-red-600'}`;
                } else {
                    adjustEl.textContent = '';
                }
            }
        }

        // ============================================
        // STEP 7: ê²¬ì  ìˆ˜ì‹  í™•ì¸ (Mock)
        // ============================================
        function populateStep7() {
            if (!quotationData.length) return;
            
            // Initialize mock status if not done
            if (Object.keys(mockQuoteStatus).length === 0) {
                quotationData.forEach((pr, idx) => {
                    const rand = Math.random();
                    mockQuoteStatus[pr['êµ¬ë§¤ìš”ì²­']] = {
                        status: rand < 0.7 ? 'received' : rand < 0.9 ? 'pending' : 'overdue',
                        amount: pr['ì…ì°°ì˜ˆì •ê°€'] ? Math.round(pr['ì…ì°°ì˜ˆì •ê°€'] * (0.85 + Math.random() * 0.2)) : 0,
                        date: rand < 0.7 ? '2026-01-02 14:' + String(Math.floor(Math.random() * 60)).padStart(2, '0') : '-'
                    };
                });
            }
            
            const received = Object.values(mockQuoteStatus).filter(s => s.status === 'received').length;
            const pending = Object.values(mockQuoteStatus).filter(s => s.status === 'pending').length;
            const overdue = Object.values(mockQuoteStatus).filter(s => s.status === 'overdue').length;
            
            document.getElementById('s7_received').textContent = received;
            document.getElementById('s7_pending').textContent = pending;
            document.getElementById('s7_overdue').textContent = overdue;
            
            document.getElementById('s7_quoteList').innerHTML = quotationData.slice(0, 30).map(pr => {
                const status = mockQuoteStatus[pr['êµ¬ë§¤ìš”ì²­']] || { status: 'pending', amount: 0, date: '-' };
                const statusBadge = status.status === 'received' ? '<span class="px-1 py-0.5 bg-green-100 text-green-800 rounded text-xs">âœ… ìˆ˜ì‹ </span>' :
                                   status.status === 'pending' ? '<span class="px-1 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">â³ ëŒ€ê¸°</span>' :
                                   '<span class="px-1 py-0.5 bg-red-100 text-red-800 rounded text-xs">ğŸ”´ ë¯¸ì‘ë‹µ</span>';
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                        <td class="px-3 py-2">${pr['ë§¤ì¹­ì—…ì²´ëª…'] || '-'}</td>
                        <td class="px-3 py-2">${statusBadge}</td>
                        <td class="px-3 py-2 text-right">${status.status === 'received' ? 'â‚©' + status.amount.toLocaleString() : '-'}</td>
                        <td class="px-3 py-2">${status.date}</td>
                    </tr>
                `;
            }).join('');
        }

        function mockOpenQuotes() {
            alert('ê²¬ì  ì˜¤í”ˆ ì™„ë£Œ! (Mock ì‹œë®¬ë ˆì´ì…˜)\n\n- ëŒ€ê¸°ì¤‘ ê²¬ì : ìˆ˜ì‹  ìƒíƒœë¡œ ë³€ê²½ë¨');
            Object.keys(mockQuoteStatus).forEach(key => {
                if (mockQuoteStatus[key].status === 'pending') {
                    mockQuoteStatus[key].status = 'received';
                    mockQuoteStatus[key].date = '2026-01-02 15:' + String(Math.floor(Math.random() * 60)).padStart(2, '0');
                }
            });
            populateStep7();
        }

        function sendReminderEmails() {
            const overdueCount = Object.values(mockQuoteStatus).filter(s => s.status === 'overdue').length;
            showSuccess('ë…ë ¤ë©”ì¼ ë°œì†¡ ì™„ë£Œ', `${overdueCount}ê°œ ì—…ì²´ì— ë…ë ¤ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (Mock)`);
        }

        // ============================================
        // STEP 8: ê²¬ì  ë¹„êµ ë¶„ì„ (Mock)
        // ============================================
        function populateStep8() {
            if (!processingResults) return;
            const summary = processingResults.summary;
            
            document.getElementById('s8_time').textContent = summary.processingTime || '0';
            document.getElementById('s8_tokens').textContent = (summary.llmCalls * 1200).toLocaleString();
            
            // ê²¬ì  ê²½ìŸë ¥ ê³„ì‚°
            let excellent = 0, normal = 0, poor = 0;
            
            const comparisonData = quotationData.map(pr => {
                const quoteStatus = mockQuoteStatus[pr['êµ¬ë§¤ìš”ì²­']] || { status: 'pending', amount: 0 };
                // ê²¬ì ë‹¨ê°€: Mock ìˆ˜ì‹ ëœ ê°€ê²© ë˜ëŠ” ì˜ˆì •ê°€ì˜ 85~105% ëœë¤
                const quotePrice = quoteStatus.status === 'received' ? quoteStatus.amount : 
                    Math.round((pr['ì…ì°°ì˜ˆì •ê°€'] || 0) * (0.85 + Math.random() * 0.2));
                const estimatedPrice = pr['ì…ì°°ì˜ˆì •ê°€'] || 0;  // ì˜ˆì •ë‹¨ê°€
                const recentOrderPrice = pr['ìµœê·¼ë°œì£¼ë‹¨ê°€'] || 0;  // ìµœê·¼ë°œì£¼ë‹¨ê°€
                
                // ê²½ìŸë ¥ íŒë‹¨
                let competitiveness, signal, bgClass;
                if (quotePrice <= estimatedPrice) {
                    // ê²¬ì ë‹¨ê°€ â‰¤ ì˜ˆì •ë‹¨ê°€: ìš°ìˆ˜
                    competitiveness = 'ìš°ìˆ˜';
                    signal = 'ğŸŸ¢';
                    bgClass = 'bg-green-100 text-green-800';
                    excellent++;
                } else if (recentOrderPrice > 0 && quotePrice <= recentOrderPrice) {
                    // ì˜ˆì •ë‹¨ê°€ < ê²¬ì ë‹¨ê°€ â‰¤ ìµœê·¼ë°œì£¼ë‹¨ê°€: ë³´í†µ
                    competitiveness = 'ë³´í†µ';
                    signal = 'ğŸŸ¡';
                    bgClass = 'bg-yellow-100 text-yellow-800';
                    normal++;
                } else {
                    // ê²¬ì ë‹¨ê°€ > ì˜ˆì •ë‹¨ê°€ & ìµœê·¼ë°œì£¼ë‹¨ê°€: ì—´ìœ„
                    competitiveness = 'ì—´ìœ„';
                    signal = 'ğŸ”´';
                    bgClass = 'bg-red-100 text-red-800';
                    poor++;
                }
                
                return { pr, quotePrice, estimatedPrice, recentOrderPrice, competitiveness, signal, bgClass };
            });
            
            // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('s8_excellent').textContent = excellent;
            document.getElementById('s8_normal').textContent = normal;
            document.getElementById('s8_poor').textContent = poor;
            
            // í…Œì´ë¸” ë Œë”ë§
            document.getElementById('s8_comparisonList').innerHTML = comparisonData.slice(0, 50).map(item => {
                const { pr, quotePrice, estimatedPrice, recentOrderPrice, competitiveness, signal, bgClass } = item;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</td>
                        <td class="px-3 py-2">${pr['ë§¤ì¹­ì—…ì²´ëª…'] || '-'}</td>
                        <td class="px-3 py-2 text-right font-medium">â‚©${quotePrice.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right">â‚©${estimatedPrice.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right">${recentOrderPrice > 0 ? 'â‚©' + recentOrderPrice.toLocaleString() : '-'}</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${bgClass}">${signal} ${competitiveness}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // MODALS
        // ============================================
        function openHitlModal(prId) {
            const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
            if (!pr) return;

            document.getElementById('modalPrId').textContent = prId;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h4 class="font-medium text-orange-800 mb-2">ğŸ“Œ ê²€í†  ì‚¬ìœ </h4>
                        <div class="bg-white rounded p-3 space-y-2 text-sm">
                            <div class="flex justify-between"><span>ê²¬ì ë‹¨ê°€</span><span class="font-medium">â‚©${Math.round(pr['ê²¬ì ë‹¨ê°€'] || pr['ì…ì°°ì˜ˆì •ê°€'] * 0.95 || 0).toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>ì…ì°°ì˜ˆì •ê°€</span><span class="font-medium">â‚©${(pr['ì…ì°°ì˜ˆì •ê°€'] || 0).toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>ìµœê·¼ë°œì£¼ë‹¨ê°€</span><span class="font-medium">â‚©${Math.round(pr['ìµœê·¼ë°œì£¼ë‹¨ê°€'] || 0).toLocaleString()}</span></div>
                            <hr>
                            <div class="flex justify-between"><span>ë‹¨ê°€ë³€ë™ë¥ </span><span class="font-medium ${(pr['ë‹¨ê°€ë³€ë™ë¥ '] || 0) > 15 ? 'text-red-600' : ''}">${(pr['ë‹¨ê°€ë³€ë™ë¥ '] || 0).toFixed(1)}%</span></div>
                        </div>
                        <div class="mt-3 p-3 bg-purple-50 rounded text-sm">
                            <p class="font-medium text-purple-800">ğŸ§  AI ë¶„ì„:</p>
                            <p class="text-gray-700 mt-1">ë‹¨ê°€ë³€ë™ë¥ ì´ í—ˆìš©ë²”ìœ„(15%)ë¥¼ ì´ˆê³¼í•˜ì—¬ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="border rounded-lg p-4">
                        <h4 class="font-medium mb-3">ë‹´ë‹¹ì ê²°ì •</h4>
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="radio" name="decision" value="approve" class="mr-2"><span>ì ì • (ì§„í–‰)</span></label>
                            <label class="flex items-center"><input type="radio" name="decision" value="renegotiate" class="mr-2"><span>ì¬ê²¬ì  ìš”ì²­</span></label>
                            <label class="flex items-center"><input type="radio" name="decision" value="conditional" class="mr-2" checked><span>ì¡°ê±´ë¶€ ìŠ¹ì¸</span></label>
                        </div>
                        <div class="mt-4">
                            <label class="text-sm text-gray-600">ì¡°ê±´/ì‚¬ìœ :</label>
                            <textarea id="decisionReason" class="w-full border rounded p-2 mt-1 text-sm" rows="2" placeholder="ê²°ì • ì‚¬ìœ ...">í’ˆì§ˆë³´ì¦ê¸°ê°„ 2ë…„ ì¡°ê±´ ì¶”ê°€ í›„ ì§„í–‰</textarea>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('hitlModal').classList.remove('hidden');
            document.getElementById('hitlModal').dataset.prId = prId;
        }

        function closeHitlModal() {
            document.getElementById('hitlModal').classList.add('hidden');
        }

        function submitHitlDecision() {
            const prId = document.getElementById('hitlModal').dataset.prId;
            const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
            if (pr) {
                pr['ì²˜ë¦¬ìƒíƒœ'] = 'ìë™ì™„ë£Œ';
                pr['HITLí•„ìš”'] = false;
            }
            closeHitlModal();
            renderPRList();
            populateStep5();
            showSuccess('ê²°ì • ì™„ë£Œ', 'ê²€í†  ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function approvePR(prId) {
            try {
                await axios.post(`/api/quotations/${prId}/approve`);
                const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
                if (pr) pr['ìŠ¹ì¸ìƒíƒœ'] = 'ìŠ¹ì¸ì™„ë£Œ';
                showSuccess('ìŠ¹ì¸ ì™„ë£Œ', `PR ${prId}ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                renderPRList();
                renderDetailView(prId);
            } catch (e) {
                alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
            }
        }

        // Email Modals
        function openBatchEmailModal() {
            const invalidPR = processingResults?.invalidPR || [];
            if (invalidPR.length === 0) { alert('ë°œì†¡í•  ëˆ„ë½ PRì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const grouped = {};
            invalidPR.forEach(pr => {
                const manager = pr['ë‹´ë‹¹ì'] || pr['êµ¬ë§¤ìš”ì²­ì'] || 'ë‹´ë‹¹ìë¯¸ì§€ì •';
                if (!grouped[manager]) grouped[manager] = [];
                grouped[manager].push(pr);
            });
            let managerList = '';
            Object.entries(grouped).forEach(([manager, prs]) => {
                managerList += `<p class="text-sm">â€¢ ${manager}: ${prs.length}ê±´</p>`;
            });
            document.getElementById('batchEmailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="font-medium mb-2">ë°œì†¡ ëŒ€ìƒ: ${Object.keys(grouped).length}ëª…</p>
                        ${managerList}
                    </div>
                    <p class="text-gray-600">ì´ <strong>${invalidPR.length}ê±´</strong>ì˜ ëˆ„ë½ PR ì•ˆë‚´ ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            document.getElementById('batchEmailModal').classList.remove('hidden');
        }

        function closeBatchEmailModal() {
            document.getElementById('batchEmailModal').classList.add('hidden');
        }

        function sendBatchEmails() {
            const invalidPR = processingResults?.invalidPR || [];
            const grouped = {};
            invalidPR.forEach(pr => {
                const manager = pr['ë‹´ë‹¹ì'] || pr['êµ¬ë§¤ìš”ì²­ì'] || 'ë‹´ë‹¹ìë¯¸ì§€ì •';
                if (!grouped[manager]) grouped[manager] = [];
                grouped[manager].push(pr);
            });
            invalidPR.forEach((pr, idx) => { sentEmails[idx] = { sentAt: new Date().toISOString() }; });
            closeBatchEmailModal();
            showSuccess('ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ', `${Object.keys(grouped).length}ëª…ì—ê²Œ ${invalidPR.length}ê±´ì˜ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function openEmailPreview(prIndex) {
            const invalidPR = processingResults?.invalidPR || [];
            const pr = invalidPR[prIndex];
            if (!pr) return;
            const manager = pr['ë‹´ë‹¹ì'] || pr['êµ¬ë§¤ìš”ì²­ì'] || 'ë‹´ë‹¹ìë¯¸ì§€ì •';
            document.getElementById('emailPreviewContent').innerHTML = `
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <p class="text-sm"><strong>To:</strong> ${manager}</p>
                        <p class="text-sm"><strong>Subject:</strong> [PR í•„ìˆ˜í•­ëª© ëˆ„ë½] ì •ë³´ ì—…ë°ì´íŠ¸ ìš”ì²­</p>
                    </div>
                    <div class="p-4 space-y-3 text-sm">
                        <p>ì•ˆë…•í•˜ì„¸ìš”, <strong>${manager}</strong>ë‹˜</p>
                        <p>ì•„ë˜ êµ¬ë§¤ìš”ì²­ ê±´ì— í•„ìˆ˜í•­ëª©ì´ ëˆ„ë½ë˜ì–´ ì²˜ë¦¬ê°€ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
                        <div class="bg-gray-50 border rounded p-3">
                            <p><strong>PRë²ˆí˜¸:</strong> ${pr['êµ¬ë§¤ìš”ì²­'] || '-'}</p>
                            <p><strong>ìì¬ë²ˆí˜¸:</strong> ${pr['ìì¬ë²ˆí˜¸'] || '-'}</p>
                            <p><strong>ëˆ„ë½í•­ëª©:</strong> <span class="text-red-600">${pr['ëˆ„ë½í•­ëª©'] || '-'}</span></p>
                        </div>
                        <p>ê°ì‚¬í•©ë‹ˆë‹¤.<br>êµ¬ë§¤íŒ€ AI Agent</p>
                    </div>
                </div>
            `;
            document.getElementById('emailPreviewModal').classList.remove('hidden');
        }

        function closeEmailPreviewModal() {
            document.getElementById('emailPreviewModal').classList.add('hidden');
        }

        function showSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        // Final Actions
        async function downloadExcel() {
            try {
                const response = await axios.get('/api/export', { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'PR_PO_Agent_Result.xlsx');
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (e) {
                alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        function batchSRMTransfer() {
            const autoCompletePRs = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ');
            if (!confirm(`${autoCompletePRs.length}ê±´ì„ SRMìœ¼ë¡œ ì¼ê´„ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            showSuccess('SRM ì „ì†¡ ì™„ë£Œ', `${autoCompletePRs.length}ê±´ì´ SRMìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)`);
        }
    </script>
</body>
</html>
