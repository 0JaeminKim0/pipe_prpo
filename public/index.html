<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRâ†’PO ìë™í™” AI Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        .step-active { @apply bg-blue-600 text-white; }
        .step-completed { @apply bg-green-600 text-white; }
        .step-pending { @apply bg-gray-300 text-gray-600; }
        .urgency-urgent { @apply bg-red-100 border-red-500; }
        .urgency-normal { @apply bg-yellow-100 border-yellow-500; }
        .urgency-flexible { @apply bg-green-100 border-green-500; }
        .log-entry { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-item:hover { @apply bg-gray-100; }
        .sidebar-item.selected { @apply bg-blue-50 border-l-4 border-blue-600; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">ğŸ¤–</span>
                    <h1 class="text-xl font-bold text-gray-800">PRâ†’PO ìë™í™” Agent</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">ê¸°ì¤€ì¼: 2026-01-01</span>
                    <span id="llmStatus" class="text-sm px-2 py-1 rounded bg-gray-200">LLM í™•ì¸ì¤‘...</span>
                </div>
            </div>
        </header>

        <!-- Progress Steps -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex items-center justify-center space-x-4">
                    <div class="step-item flex items-center" data-step="1">
                        <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center step-active">
                            <i class="fas fa-upload"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium">PR ì—…ë¡œë“œ</span>
                    </div>
                    <div class="w-12 h-1 bg-gray-300 step-line" data-line="1"></div>
                    <div class="step-item flex items-center" data-step="2">
                        <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center step-pending">
                            <i class="fas fa-robot"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium">AI ì²˜ë¦¬</span>
                    </div>
                    <div class="w-12 h-1 bg-gray-300 step-line" data-line="2"></div>
                    <div class="step-item flex items-center" data-step="3">
                        <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center step-pending">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium">ê²¬ì ì˜ë¢°</span>
                    </div>
                    <div class="w-12 h-1 bg-gray-300 step-line" data-line="3"></div>
                    <div class="step-item flex items-center" data-step="4">
                        <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center step-pending">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium">ìµœì¢…ê²€í† </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Step 1: Upload -->
            <div id="step1" class="step-content">
                <div class="bg-white rounded-lg shadow p-8">
                    <h2 class="text-xl font-bold text-center mb-6">ğŸ“¥ PR ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h2>
                    
                    <!-- Drop Zone -->
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                        <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" class="hidden">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="text-sm text-gray-400 mt-2">ğŸ“„ .xlsx, .xls ì§€ì›</p>
                    </div>

                    <!-- Uploaded Files -->
                    <div id="uploadedFiles" class="mt-6 hidden">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼</h3>
                        <div id="fileList" class="space-y-2"></div>
                    </div>

                    <!-- Data Summary -->
                    <div id="dataSummary" class="mt-6 hidden">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-blue-600" id="prCount">0</p>
                                    <p class="text-sm text-gray-600">PR ê±´ìˆ˜</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-600" id="poCount">0</p>
                                    <p class="text-sm text-gray-600">ë°œì£¼ì‹¤ì </p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-purple-600" id="pzafCount">0</p>
                                    <p class="text-sm text-gray-600">PZAF ìì¬</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Load PR Data Button -->
                    <div class="mt-6 text-center">
                        <button id="loadSampleBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors text-lg shadow-md">
                            ğŸ“‚ PR ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <p class="text-xs text-gray-500 mt-3">3ê°œ Excel íŒŒì¼ì—ì„œ PR ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</p>
                        <p class="text-xs text-gray-400">â€¢ DR_1P0K02_25.10~12.êµ¬ë§¤ìš”ì²­ì§„í–‰í˜„í™©.XLSX</p>
                        <p class="text-xs text-gray-400">â€¢ DR_1P0M01_25.10~12.êµ¬ë§¤ìš”ì²­ì§„í–‰í˜„í™©.XLSX</p>
                        <p class="text-xs text-gray-400">â€¢ DR_PZAF ë°œì£¼ì‹¤ì  ìƒì„¸_2025_2026.01.29_11.11.51.xlsx</p>
                    </div>

                    <!-- Start Button -->
                    <div class="mt-8 text-center">
                        <button id="startProcessBtn" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>
                            ğŸš€ AI ì²˜ë¦¬ ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="step2" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-8">
                    <h2 class="text-xl font-bold mb-6">ğŸ¤– AI Agentê°€ PRì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h2>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span id="currentStep">ë°ì´í„° ê²€ì¦ ì¤‘...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Processing Steps -->
                    <div id="processingSteps" class="space-y-3 mb-6">
                        <div class="step-item flex items-center" data-pstep="1">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <i class="fas fa-circle-notch fa-spin text-gray-400 hidden"></i>
                                <i class="fas fa-check text-green-600 hidden"></i>
                                <span class="step-num">1</span>
                            </span>
                            <span>ë°ì´í„° ê²€ì¦</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="2">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">2</span>
                            </span>
                            <span>ëˆ„ë½ PR ì´ë©”ì¼ ë°œì†¡ ì¤€ë¹„</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="3">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">3</span>
                            </span>
                            <span>ê³„ì•½ ë¶„ë¥˜</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="4">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">4</span>
                            </span>
                            <span>ê¸´ê¸‰ë„ ì‚°ì •</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="5">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">5</span>
                            </span>
                            <span>ì—…ì²´ ë§¤ì¹­</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="6">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">6</span>
                            </span>
                            <span>ê²¬ì ì˜ë¢° ìƒì„± ë° ì˜ˆì •ê°€ ì‚°ì •</span>
                        </div>
                        <div class="step-item flex items-center" data-pstep="7">
                            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="step-num">7</span>
                            </span>
                            <span>ì ì •ì„± ê²€í† </span>
                        </div>
                    </div>

                    <!-- Log Window -->
                    <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto">
                        <h3 class="text-green-400 text-sm font-mono mb-2">ğŸ’¬ AI ì‹¤ì‹œê°„ ë¡œê·¸</h3>
                        <div id="logContainer" class="text-sm font-mono space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Quotation Management -->
            <div id="step3" class="step-content hidden">
                <div class="flex gap-6">
                    <!-- Left: PR List -->
                    <div class="w-1/3 bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h3 class="font-bold">PR ëª©ë¡</h3>
                            <div class="mt-3 flex space-x-2">
                                <select id="urgencyFilter" class="text-sm border rounded px-2 py-1">
                                    <option value="all">ì „ì²´</option>
                                    <option value="ê¸´ê¸‰">ğŸ”´ ê¸´ê¸‰</option>
                                    <option value="ì¼ë°˜">ğŸŸ¡ ì¼ë°˜</option>
                                    <option value="ì—¬ìœ ">ğŸŸ¢ ì—¬ìœ </option>
                                </select>
                                <select id="statusFilter" class="text-sm border rounded px-2 py-1">
                                    <option value="all">ì „ì²´</option>
                                    <option value="ìë™ì™„ë£Œ">âœ… ìë™ì™„ë£Œ</option>
                                    <option value="ê²€í† í•„ìš”">âš ï¸ ê²€í† í•„ìš”</option>
                                </select>
                            </div>
                        </div>
                        <div id="prList" class="overflow-y-auto" style="max-height: 600px;"></div>
                        <div class="p-4 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                <p>âœ… ìë™ì™„ë£Œ: <span id="autoCompleteCount">0</span>ê±´</p>
                                <p>âš ï¸ ê²€í† í•„ìš”: <span id="needReviewCount">0</span>ê±´</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Detail View -->
                    <div class="w-2/3 bg-white rounded-lg shadow">
                        <div id="detailView" class="p-6">
                            <div class="text-center text-gray-500 py-20">
                                <i class="fas fa-file-alt text-4xl mb-4"></i>
                                <p>PRì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Final Report -->
            <div id="step4" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-8">
                    <div class="text-center mb-8">
                        <span class="text-6xl">ğŸ‰</span>
                        <h2 class="text-2xl font-bold mt-4">ì²˜ë¦¬ ì™„ë£Œ</h2>
                        <p class="text-gray-600 mt-2" id="totalProcessed">0ê±´ ì²˜ë¦¬ ì™„ë£Œ</p>
                    </div>

                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="font-bold mb-4">ì²˜ë¦¬ í˜„í™©</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>ìë™ì²˜ë¦¬</span>
                                    <span class="font-bold text-green-600" id="finalAutoCount">0ê±´</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="autoBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <span>HITL ê²€í† </span>
                                    <span class="font-bold text-orange-600" id="finalHitlCount">0ê±´</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="hitlBar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="font-bold mb-4">ìƒì„¸ í˜„í™©</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">ê¸´ê¸‰ë„</p>
                                    <p class="text-red-600">ğŸ”´ ê¸´ê¸‰: <span id="finalUrgent">0</span>ê±´</p>
                                    <p class="text-yellow-600">ğŸŸ¡ ì¼ë°˜: <span id="finalNormal">0</span>ê±´</p>
                                    <p class="text-green-600">ğŸŸ¢ ì—¬ìœ : <span id="finalFlexible">0</span>ê±´</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">AI ì²˜ë¦¬ í†µê³„</p>
                                    <p>LLM í˜¸ì¶œ: <span id="finalLlmCalls">0</span>íšŒ</p>
                                    <p>ì²˜ë¦¬ ì‹œê°„: <span id="finalTime">0</span>ì´ˆ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center space-x-4">
                        <button onclick="downloadExcel()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                            ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button onclick="goToStep(3)" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            ğŸ“‹ ê²¬ì ì˜ë¢° ê´€ë¦¬
                        </button>
                        <button onclick="batchApprove()" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                            ğŸš€ SRM ì¼ê´„ ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State
        let currentStep = 1;
        let uploadedFiles = [];
        let quotationData = [];
        let selectedPR = null;
        let processingResults = null;

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const startProcessBtn = document.getElementById('startProcessBtn');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            setupDropZone();
            setupFilters();
        });

        async function checkHealth() {
            try {
                const res = await axios.get('/api/health');
                const llmStatus = document.getElementById('llmStatus');
                if (res.data.hasApiKey) {
                    llmStatus.textContent = 'ğŸ§  LLM í™œì„±í™”';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-green-100 text-green-800';
                } else {
                    llmStatus.textContent = 'âš ï¸ LLM ë¯¸ì„¤ì •';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        function setupDropZone() {
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = e.dataTransfer.files;
                await handleFiles(files);
            });
            fileInput.addEventListener('change', async (e) => {
                await handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            try {
                const res = await axios.post('/api/upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });

                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    updateDataSummary();
                    startProcessBtn.disabled = false;
                }
            } catch (e) {
                alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
            }
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            const list = document.getElementById('fileList');
            container.classList.remove('hidden');

            list.innerHTML = uploadedFiles.map(f => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-file-excel text-green-600 mr-2"></i>
                        <span class="text-sm">${f.filename}</span>
                        <span class="text-xs text-gray-500 ml-2">(${f.rows.toLocaleString()}ê±´)</span>
                    </div>
                    <span class="text-green-600"><i class="fas fa-check"></i></span>
                </div>
            `).join('');
        }

        async function updateDataSummary() {
            try {
                const res = await axios.get('/api/summary');
                document.getElementById('dataSummary').classList.remove('hidden');
                document.getElementById('prCount').textContent = res.data.prTotal.toLocaleString();
                document.getElementById('poCount').textContent = res.data.poHistoryTotal.toLocaleString();
                document.getElementById('pzafCount').textContent = res.data.pzafCount.toLocaleString();
            } catch (e) {
                console.error('Summary fetch failed:', e);
            }
        }

        // Load Sample Data Button
        document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);

        async function loadSampleData() {
            const btn = document.getElementById('loadSampleBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                const res = await axios.post('/api/load-sample');
                
                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    await updateDataSummary();
                    startProcessBtn.disabled = false;
                    
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-gray-400');
                } else {
                    throw new Error(res.data.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“‚ PR ë¶ˆëŸ¬ì˜¤ê¸°';
            }
        }

        // Start Processing
        startProcessBtn.addEventListener('click', startProcessing);

        async function startProcessing() {
            goToStep(2);
            
            // Reset processing UI
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('logContainer').innerHTML = '';

            try {
                // Add loading indicator
                addLogEntry('AI Agent ì‹œì‘...', 'info');

                const res = await axios.post('/api/process');
                
                if (res.data.success) {
                    processingResults = res.data.results;
                    quotationData = res.data.results.quotationData || [];
                    
                    // Update progress to 100%
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressPercent').textContent = '100%';
                    document.getElementById('currentStep').textContent = 'ì²˜ë¦¬ ì™„ë£Œ!';

                    // Show completion logs
                    res.data.results.summary && displaySummaryLogs(res.data.results.summary);

                    // Auto transition to results after 2 seconds
                    setTimeout(() => {
                        goToStep(4);
                        updateFinalReport();
                    }, 2000);
                }
            } catch (e) {
                addLogEntry('ì˜¤ë¥˜ ë°œìƒ: ' + (e.response?.data?.error || e.message), 'error');
            }
        }

        function displaySummaryLogs(summary) {
            addLogEntry(`âœ… ì´ ì²˜ë¦¬ ê±´ìˆ˜: ${summary.total}ê±´`, 'success');
            addLogEntry(`ğŸ”´ ê¸´ê¸‰: ${summary.urgent}ê±´, ğŸŸ¡ ì¼ë°˜: ${summary.normal}ê±´, ğŸŸ¢ ì—¬ìœ : ${summary.flexible}ê±´`, 'info');
            addLogEntry(`ìë™ì™„ë£Œ: ${summary.autoComplete}ê±´, ê²€í† í•„ìš”: ${summary.needReview}ê±´`, 'info');
            addLogEntry(`LLM í˜¸ì¶œ: ${summary.llmCalls}íšŒ`, 'info');
            addLogEntry(`ì²˜ë¦¬ ì‹œê°„: ${summary.processingTime}ì´ˆ`, 'success');
        }

        function addLogEntry(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const colors = {
                info: 'text-gray-300',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400'
            };
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[type] || colors.info}`;
            entry.innerHTML = `<span class="text-gray-500">${time}</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // Step Navigation
        function goToStep(step) {
            currentStep = step;
            
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');

            // Update step indicators
            document.querySelectorAll('.step-item').forEach((el, idx) => {
                const circle = el.querySelector('.step-circle');
                if (idx + 1 < step) {
                    circle.className = 'step-circle w-10 h-10 rounded-full flex items-center justify-center step-completed';
                } else if (idx + 1 === step) {
                    circle.className = 'step-circle w-10 h-10 rounded-full flex items-center justify-center step-active';
                } else {
                    circle.className = 'step-circle w-10 h-10 rounded-full flex items-center justify-center step-pending';
                }
            });

            // Update step lines
            document.querySelectorAll('.step-line').forEach((el, idx) => {
                if (idx + 1 < step) {
                    el.classList.remove('bg-gray-300');
                    el.classList.add('bg-green-600');
                } else {
                    el.classList.remove('bg-green-600');
                    el.classList.add('bg-gray-300');
                }
            });

            // Load data for specific steps
            if (step === 3) {
                renderPRList();
            }
        }

        // PR List & Detail
        function setupFilters() {
            document.getElementById('urgencyFilter').addEventListener('change', renderPRList);
            document.getElementById('statusFilter').addEventListener('change', renderPRList);
        }

        function renderPRList() {
            const urgencyFilter = document.getElementById('urgencyFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = [...quotationData];

            if (urgencyFilter !== 'all') {
                filtered = filtered.filter(pr => pr['ê¸´ê¸‰ë„'] === urgencyFilter);
            }
            if (statusFilter !== 'all') {
                filtered = filtered.filter(pr => pr['ì²˜ë¦¬ìƒíƒœ'] === statusFilter);
            }

            const container = document.getElementById('prList');
            container.innerHTML = filtered.map(pr => {
                const urgencyClass = pr['ê¸´ê¸‰ë„'] === 'ê¸´ê¸‰' ? 'urgency-urgent' : 
                                    pr['ê¸´ê¸‰ë„'] === 'ì¼ë°˜' ? 'urgency-normal' : 'urgency-flexible';
                const statusIcon = pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'âœ…' : 'âš ï¸';
                
                return `
                    <div class="sidebar-item p-3 border-b cursor-pointer ${urgencyClass} ${selectedPR === pr['êµ¬ë§¤ìš”ì²­'] ? 'selected' : ''}"
                         onclick="selectPR('${pr['êµ¬ë§¤ìš”ì²­']}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸'] || 'ğŸŸ¡'} ${pr['êµ¬ë§¤ìš”ì²­']}</p>
                                <p class="text-xs text-gray-600 truncate" style="max-width: 200px;">${pr['ë‚´ì—­'] || ''}</p>
                            </div>
                            <span class="text-sm">${statusIcon}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${pr['ê³„ì•½ë°©ì‹'] || ''} | ${pr['ê¸´ê¸‰ë„'] || ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Update counts
            const autoComplete = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ').length;
            const needReview = quotationData.filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ê²€í† í•„ìš”').length;
            document.getElementById('autoCompleteCount').textContent = autoComplete;
            document.getElementById('needReviewCount').textContent = needReview;
        }

        function selectPR(prId) {
            selectedPR = prId;
            renderPRList();
            renderDetailView(prId);
        }

        function renderDetailView(prId) {
            const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
            if (!pr) return;

            const container = document.getElementById('detailView');
            const estimatedPrice = pr['ì…ì°°ì˜ˆì •ê°€'] || 0;
            const quotedPrice = pr['Mock_ê²¬ì ê¸ˆì•¡'] || 0;

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold">${pr['êµ¬ë§¤ìš”ì²­']}</h2>
                            <p class="text-gray-600">${pr['ë‚´ì—­'] || ''}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                        }">
                            ${pr['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ' ? 'âœ… ìë™ì™„ë£Œ' : 'âš ï¸ ê²€í† í•„ìš”'}
                        </span>
                    </div>

                    <!-- Basic Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-medium mb-3 text-sm text-gray-600">ê¸°ë³¸ì •ë³´</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>ìì¬ë²ˆí˜¸</span><span class="font-medium">${pr['ìì¬ë²ˆí˜¸'] || '-'}</span></div>
                                <div class="flex justify-between"><span>ìš”ì²­ìˆ˜ëŸ‰</span><span class="font-medium">${pr['ìš”ì²­ìˆ˜ëŸ‰'] || 0} ${pr['UOM'] || ''}</span></div>
                                <div class="flex justify-between"><span>ì†Œì‹±ê·¸ë£¹</span><span class="font-medium">${pr['ì†Œì‹±ê·¸ë£¹'] || '-'}</span></div>
                                <div class="flex justify-between"><span>ê¸´ê¸‰ë„</span><span class="font-medium">${pr['ê¸´ê¸‰ë„_ì‹ í˜¸'] || ''} ${pr['ê¸´ê¸‰ë„'] || ''}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-medium mb-3 text-sm text-gray-600">ê³„ì•½ì •ë³´</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>ê³„ì•½ë°©ì‹</span><span class="font-medium">${pr['ê³„ì•½ë°©ì‹'] || '-'}</span></div>
                                <div class="flex justify-between"><span>ì ‘ìˆ˜ê¸°ê°„</span><span class="font-medium">${pr['ì ‘ìˆ˜ê¸°ê°„_ì¼'] || 3}ì¼</span></div>
                                <div class="flex justify-between"><span>ê¸°ìˆ í‰ê°€ëŒ€ìƒ</span><span class="font-medium">${pr['ê¸°ìˆ í‰ê°€ëŒ€ìƒ'] || 'N'}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Info -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3 text-sm text-gray-600">ê¸ˆì•¡ì •ë³´</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-xs text-gray-500">ì…ì°°ì˜ˆì •ê°€</p>
                                <p class="text-lg font-bold text-blue-600">â‚©${estimatedPrice.toLocaleString()}</p>
                                <p class="text-xs text-gray-500">${pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] || ''}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">ê²¬ì ê¸ˆì•¡</p>
                                <p class="text-lg font-bold">â‚©${Math.round(quotedPrice).toLocaleString()}</p>
                                <p class="text-xs ${pr['ê²¬ì ê²½ìŸë ¥'] === 'ìš°ìˆ˜' ? 'text-green-600' : pr['ê²¬ì ê²½ìŸë ¥'] === 'ì—´ìœ„' ? 'text-red-600' : 'text-yellow-600'}">
                                    ${pr['ê²¬ì ê²½ìŸë ¥_ì‹ í˜¸'] || ''} ${pr['ê²¬ì ê²½ìŸë ¥'] || ''}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">ìµœê·¼ë°œì£¼ë‹¨ê°€</p>
                                <p class="text-lg font-bold">â‚©${(pr['ìµœê·¼ë°œì£¼ë‹¨ê°€'] || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Supplier Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3 text-sm text-gray-600">í˜‘ë ¥íšŒì‚¬</h3>
                        <div class="flex items-center">
                            <input type="checkbox" checked class="mr-2" disabled>
                            <span>${pr['ë§¤ì¹­ì—…ì²´ëª…'] || 'ë§¤ì¹­ ì—…ì²´ ì—†ìŒ'}</span>
                            ${pr['ë§¤ì¹­ì—…ì²´ì½”ë“œ'] ? `<span class="text-xs text-gray-500 ml-2">(${pr['ë§¤ì¹­ì—…ì²´ì½”ë“œ']})</span>` : ''}
                        </div>
                    </div>

                    <!-- AI Judgment -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h3 class="font-medium mb-3 text-purple-800">ğŸ§  AI íŒë‹¨</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>ì˜ˆì •ê°€ ì‚°ì •:</strong> ${pr['ì˜ˆì •ê°€_ì‚°ì •ë°©ë²•'] || '-'}</p>
                            ${pr['ê³„ì•½ë°©ì‹'] === 'ìˆ˜ì˜ê³„ì•½' ? `
                                <p><strong>ìˆ˜ì˜ê³„ì•½ ì ì •ì„±:</strong> ${pr['ìˆ˜ì˜ê³„ì•½_ì ì •ì„±'] || '-'}</p>
                                <p><strong>ë‹¨ê°€ë³€ë™ë¥ :</strong> ${(pr['ë‹¨ê°€ë³€ë™ë¥ '] || 0).toFixed(1)}%</p>
                            ` : `
                                <p><strong>ìµœì €ê°€ ì ì •ì„±:</strong> ${pr['ìµœì €ê°€_ì ì •ì„±'] || '-'}</p>
                            `}
                            ${pr['HITLí•„ìš”'] ? '<p class="text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i>ë‹´ë‹¹ì ê²€í†  í•„ìš”</p>' : ''}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3">
                        <button onclick="approvePR('${pr['êµ¬ë§¤ìš”ì²­']}')" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            ìˆ˜ì •
                        </button>
                    </div>
                </div>
            `;
        }

        async function approvePR(prId) {
            try {
                await axios.post(`/api/quotations/${prId}/approve`);
                const pr = quotationData.find(p => p['êµ¬ë§¤ìš”ì²­'] === prId);
                if (pr) {
                    pr['ìŠ¹ì¸ìƒíƒœ'] = 'ìŠ¹ì¸ì™„ë£Œ';
                }
                alert('ìŠ¹ì¸ ì™„ë£Œ');
                renderPRList();
                renderDetailView(prId);
            } catch (e) {
                alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (e.response?.data?.error || e.message));
            }
        }

        // Final Report
        function updateFinalReport() {
            if (!processingResults || !processingResults.summary) return;

            const summary = processingResults.summary;
            
            document.getElementById('totalProcessed').textContent = `${summary.total}ê±´ ì²˜ë¦¬ ì™„ë£Œ`;
            document.getElementById('finalAutoCount').textContent = `${summary.autoComplete}ê±´`;
            document.getElementById('finalHitlCount').textContent = `${summary.needReview}ê±´`;
            document.getElementById('finalUrgent').textContent = summary.urgent;
            document.getElementById('finalNormal').textContent = summary.normal;
            document.getElementById('finalFlexible').textContent = summary.flexible;
            document.getElementById('finalLlmCalls').textContent = summary.llmCalls;
            document.getElementById('finalTime').textContent = summary.processingTime;

            const autoPercent = summary.total > 0 ? (summary.autoComplete / summary.total) * 100 : 0;
            const hitlPercent = summary.total > 0 ? (summary.needReview / summary.total) * 100 : 0;
            
            document.getElementById('autoBar').style.width = `${autoPercent}%`;
            document.getElementById('hitlBar').style.width = `${hitlPercent}%`;
        }

        async function downloadExcel() {
            try {
                const response = await axios.get('/api/export', { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'PR_PO_Agent_Result.xlsx');
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (e) {
                alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function batchApprove() {
            const autoCompletePRs = quotationData
                .filter(p => p['ì²˜ë¦¬ìƒíƒœ'] === 'ìë™ì™„ë£Œ')
                .map(p => p['êµ¬ë§¤ìš”ì²­']);

            if (autoCompletePRs.length === 0) {
                alert('ìŠ¹ì¸í•  PRì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`${autoCompletePRs.length}ê±´ì„ ì¼ê´„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                await axios.post('/api/quotations/batch-approve', { ids: autoCompletePRs });
                alert(`${autoCompletePRs.length}ê±´ ì¼ê´„ ìŠ¹ì¸ ì™„ë£Œ (SRM ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜)`);
            } catch (e) {
                alert('ì¼ê´„ ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message);
            }
        }
    </script>
</body>
</html>
