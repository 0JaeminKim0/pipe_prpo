<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR→PO 자동화 AI Agent v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        .step-active { @apply bg-blue-600 text-white; }
        .step-completed { @apply bg-green-600 text-white; }
        .step-pending { @apply bg-gray-300 text-gray-600; }
        .urgency-urgent { @apply bg-red-50 border-l-4 border-red-500; }
        .urgency-normal { @apply bg-yellow-50 border-l-4 border-yellow-500; }
        .urgency-flexible { @apply bg-green-50 border-l-4 border-green-500; }
        .log-entry { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-item:hover { @apply bg-gray-100; }
        .sidebar-item.selected { @apply bg-blue-50 border-l-4 border-blue-600; }
        .tab-active { @apply bg-white border-b-2 border-blue-600 text-blue-600; }
        .tab-inactive { @apply bg-gray-100 text-gray-600 hover:bg-gray-200; }
        .card-stat { @apply bg-white rounded-lg shadow p-4 text-center; }
        .step-nav { 
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 4px;
            min-width: 80px;
            transition: all 0.2s;
        }
        .step-nav:hover { background-color: #f0f9ff; border-radius: 8px; }
        .step-circle { 
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-label { 
            font-size: 11px;
            margin-top: 6px;
            text-align: center;
            color: #4b5563;
            line-height: 1.4;
            max-width: 75px;
            word-break: keep-all;
        }
        .step-line { 
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, #d1d5db, #e5e7eb);
            margin: 0 2px;
            margin-bottom: 20px;
        }
        .step-line.completed { background: linear-gradient(to right, #22c55e, #16a34a); }
        .mini-card { @apply bg-white rounded shadow p-3 text-center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">🤖</span>
                    <h1 class="text-xl font-bold text-gray-800">PR→PO 자동화 Agent <span class="text-sm font-normal text-gray-500">v2</span></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">기준일: 2026-01-01</span>
                    <span id="llmStatus" class="text-sm px-2 py-1 rounded bg-gray-200">LLM 확인중...</span>
                </div>
            </div>
        </header>

        <!-- 8-Step Progress Navigation -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Step 1 -->
                    <div class="step-nav" data-step="1" onclick="navigateToStep(1)">
                        <div class="step-circle step-active" id="step-circle-1">1</div>
                        <span class="step-label">PR 데이터<br>접수 및 확인</span>
                    </div>
                    <div class="step-line" data-line="1"></div>
                    
                    <!-- Step 2 -->
                    <div class="step-nav" data-step="2" onclick="navigateToStep(2)">
                        <div class="step-circle step-pending" id="step-circle-2">2</div>
                        <span class="step-label">계약 여부 및<br>긴급도 분석</span>
                    </div>
                    <div class="step-line" data-line="2"></div>
                    
                    <!-- Step 3 -->
                    <div class="step-nav" data-step="3" onclick="navigateToStep(3)">
                        <div class="step-circle step-pending" id="step-circle-3">3</div>
                        <span class="step-label">납품업체 및<br>발주방식 검토</span>
                    </div>
                    <div class="step-line" data-line="3"></div>
                    
                    <!-- Step 4 -->
                    <div class="step-nav" data-step="4" onclick="navigateToStep(4)">
                        <div class="step-circle step-pending" id="step-circle-4">4</div>
                        <span class="step-label">견적 의뢰서<br>생성</span>
                    </div>
                    <div class="step-line" data-line="4"></div>
                    
                    <!-- Step 5 -->
                    <div class="step-nav" data-step="5" onclick="navigateToStep(5)">
                        <div class="step-circle step-pending" id="step-circle-5">5</div>
                        <span class="step-label">입찰 예정가<br>산출</span>
                    </div>
                    <div class="step-line" data-line="5"></div>
                    
                    <!-- Step 6 -->
                    <div class="step-nav" data-step="6" onclick="navigateToStep(6)">
                        <div class="step-circle step-pending" id="step-circle-6">6</div>
                        <span class="step-label">업체 견적<br>수신 결과</span>
                    </div>
                    <div class="step-line" data-line="6"></div>
                    
                    <!-- Step 7 -->
                    <div class="step-nav" data-step="7" onclick="navigateToStep(7)">
                        <div class="step-circle step-pending" id="step-circle-7">7</div>
                        <span class="step-label">견적의뢰 세부<br>내용 검토</span>
                    </div>
                    <div class="step-line" data-line="7"></div>
                    
                    <!-- Step 8 -->
                    <div class="step-nav" data-step="8" onclick="navigateToStep(8)">
                        <div class="step-circle step-pending" id="step-circle-8">8</div>
                        <span class="step-label">최종 견적<br>비교</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Dashboard (shows during processing) -->
        <div id="processingDashboard" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-spinner fa-spin text-xl"></i>
                        <div>
                            <p class="font-medium" id="dashboardStatus">AI 처리 중...</p>
                            <p class="text-sm text-blue-100" id="dashboardStep">데이터 검증</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6 text-sm">
                        <div class="text-center">
                            <p class="text-2xl font-bold" id="dashTotal">0</p>
                            <p class="text-blue-100">처리 건수</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-300" id="dashAuto">0</p>
                            <p class="text-blue-100">자동완료</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-orange-300" id="dashHITL">0</p>
                            <p class="text-blue-100">HITL</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold" id="dashLLM">0</p>
                            <p class="text-blue-100">LLM 호출</p>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="w-full bg-blue-400 rounded-full h-2">
                        <div id="dashProgress" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            
            <!-- ======================= STEP 1: PR 접수 검토 ======================= -->
            <div id="step1" class="step-content">
                <div class="grid grid-cols-3 gap-6">
                    <!-- Left: Upload Panel -->
                    <div class="col-span-2 bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-bold mb-4">📥 PR 데이터 접수 및 확인</h2>
                        
                        <!-- Upload Area -->
                        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" class="hidden">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600">파일을 드래그하거나 클릭하여 업로드</p>
                            <p class="text-sm text-gray-400 mt-1">📄 .xlsx, .xls 지원</p>
                        </div>

                        <!-- Quick Load -->
                        <div class="mt-4 text-center">
                            <button id="loadSampleBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                                📂 PR 불러오기
                            </button>
                            <p class="text-xs text-gray-400 mt-2">3개 Excel 파일에서 데이터 로드</p>
                        </div>

                        <!-- Uploaded Files -->
                        <div id="uploadedFiles" class="mt-4 hidden">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">📁 업로드된 파일</h3>
                            <div id="fileList" class="space-y-1 text-sm"></div>
                        </div>
                    </div>

                    <!-- Right: Summary Panel -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">📊 데이터 요약</h3>
                        
                        <div id="dataSummary" class="space-y-4">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>데이터를 불러오세요</p>
                            </div>
                        </div>

                        <div id="summaryLoaded" class="hidden space-y-4">
                            <div class="mini-card border-l-4 border-blue-500">
                                <p class="text-2xl font-bold text-blue-600" id="prCount">0</p>
                                <p class="text-xs text-gray-600">PR 건수 (원본)</p>
                            </div>
                            <div class="mini-card border-l-4 border-green-500">
                                <p class="text-2xl font-bold text-green-600" id="poCount">0</p>
                                <p class="text-xs text-gray-600">발주실적</p>
                            </div>
                            <div class="mini-card border-l-4 border-purple-500">
                                <p class="text-2xl font-bold text-purple-600" id="pzafCount">0</p>
                                <p class="text-xs text-gray-600">PZAF 자재</p>
                            </div>

                            <button id="startProcessBtn" class="w-full mt-4 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>
                                🚀 AI 처리 시작
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Validation Results (after processing) -->
                <div id="validationResults" class="mt-6 hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">📋 PR 데이터 확인 및 검증</h3>
                            <div class="flex items-center space-x-4">
                                <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i><span id="validCount2">0</span>건 유효</span>
                                <span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i><span id="invalidCount2">0</span>건 누락</span>
                            </div>
                        </div>
                        
                        <!-- Invalid PR Section -->
                        <div id="invalidSection" class="hidden">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-medium text-red-600">⚠️ PR 세부 내역 누락 건</h4>
                                <button onclick="openBatchEmailModal()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-envelope mr-1"></i>일괄 발송
                                </button>
                            </div>
                            <div class="border rounded overflow-hidden max-h-64 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-2 text-left text-xs">PR번호</th>
                                            <th class="px-2 py-2 text-center text-xs">자재번호</th>
                                            <th class="px-2 py-2 text-center text-xs">자재내역</th>
                                            <th class="px-2 py-2 text-center text-xs">구매요청일</th>
                                            <th class="px-2 py-2 text-center text-xs">PR납기일</th>
                                            <th class="px-2 py-2 text-center text-xs">리드타임</th>
                                            <th class="px-2 py-2 text-center text-xs">소싱그룹</th>
                                            <th class="px-2 py-2 text-center text-xs">자재그룹</th>
                                            <th class="px-2 py-2 text-left text-xs">담당자</th>
                                            <th class="px-2 py-2 text-center text-xs">액션</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invalidPRList"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-end">
                            <button onclick="goToStep(2)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                다음: 계약 여부 및 긴급도 분석 →
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= STEP 2: 계약/긴급도 확인 ======================= -->
            <div id="step2" class="step-content hidden">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left: 계약분류 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">📋 계약 여부 확인 <span id="s2_contractFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all" onclick="filterContractList('표준단가')" id="card_standard">
                                <p class="text-xl font-bold text-blue-600" id="s2_standard">0</p>
                                <p class="text-xs text-gray-600">표준단가</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all" onclick="filterContractList('비표준단가')" id="card_nonStandard">
                                <p class="text-xl font-bold text-purple-600" id="s2_nonStandard">0</p>
                                <p class="text-xs text-gray-600">비표준단가</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-orange-300 transition-all" onclick="filterContractList('NA')" id="card_na">
                                <p class="text-xl font-bold text-orange-600" id="s2_na">0</p>
                                <p class="text-xs text-gray-600">견적대상</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">클릭하여 필터링 | <button onclick="filterContractList('all')" class="text-blue-600 hover:underline">전체보기</button></span>
                            <span class="text-xs text-gray-400" id="s2_contractCount">0건</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs">PR번호</th>
                                        <th class="px-2 py-2 text-left text-xs">자재번호</th>
                                        <th class="px-2 py-2 text-left text-xs">자재내역</th>
                                        <th class="px-2 py-2 text-left text-xs">계약분류</th>
                                        <th class="px-2 py-2 text-left text-xs">단가계약번호</th>
                                        <th class="px-2 py-2 text-left text-xs">자동배량그룹</th>
                                    </tr>
                                </thead>
                                <tbody id="s2_contractList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right: 긴급도 분석 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">⏰ 긴급도 분석 <span class="text-xs font-normal text-gray-500">기준일: 2026-01-01</span> <span id="s2_urgencyFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="mini-card border-l-4 border-red-500 cursor-pointer hover:ring-2 hover:ring-red-300 transition-all" onclick="filterUrgencyList('긴급')" id="card_urgent">
                                <p class="text-xl font-bold text-red-600" id="s2_urgent">0</p>
                                <p class="text-xs text-gray-600">🔴 긴급</p>
                            </div>
                            <div class="mini-card border-l-4 border-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-300 transition-all" onclick="filterUrgencyList('일반')" id="card_normal">
                                <p class="text-xl font-bold text-yellow-600" id="s2_normal">0</p>
                                <p class="text-xs text-gray-600">🟡 일반</p>
                            </div>
                            <div class="mini-card border-l-4 border-green-500 cursor-pointer hover:ring-2 hover:ring-green-300 transition-all" onclick="filterUrgencyList('여유')" id="card_flexible">
                                <p class="text-xl font-bold text-green-600" id="s2_flexible">0</p>
                                <p class="text-xs text-gray-600">🟢 여유</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">클릭하여 필터링 | <button onclick="filterUrgencyList('all')" class="text-blue-600 hover:underline">전체보기</button></span>
                            <span class="text-xs text-gray-400" id="s2_urgencyCount">0건</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs">PR번호</th>
                                        <th class="px-2 py-2 text-left text-xs">자재번호</th>
                                        <th class="px-2 py-2 text-left text-xs">자재내역</th>
                                        <th class="px-2 py-2 text-left text-xs">PR납기일</th>
                                        <th class="px-2 py-2 text-left text-xs">LEAD_TIME</th>
                                        <th class="px-2 py-2 text-left text-xs">잔여일</th>
                                        <th class="px-2 py-2 text-left text-xs">긴급도</th>
                                    </tr>
                                </thead>
                                <tbody id="s2_urgencyList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="goToStep(3)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        다음: 최근 납품 업체 및 발주 방식 검토 →
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 3: 업체/발주방식 판단 ======================= -->
            <div id="step3" class="step-content hidden">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left: 업체 매칭 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">🏢 최근 납품 업체 검토 <span id="s3_supplierFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="mini-card border-l-4 border-green-500 cursor-pointer hover:ring-2 hover:ring-green-300 transition-all" onclick="filterSupplierList('matched')" id="card_matched">
                                <p class="text-xl font-bold text-green-600" id="s3_matched">0</p>
                                <p class="text-xs text-gray-600">✅ 매칭성공</p>
                            </div>
                            <div class="mini-card border-l-4 border-red-500 cursor-pointer hover:ring-2 hover:ring-red-300 transition-all" onclick="filterSupplierList('unmatched')" id="card_unmatched">
                                <p class="text-xl font-bold text-red-600" id="s3_unmatched">0</p>
                                <p class="text-xs text-gray-600">⚠️ 신규업체필요</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="text" id="s3_supplierSearch" placeholder="검색 (PR번호, 자재번호, 자재내역...)" 
                                class="flex-1 text-xs border rounded px-2 py-1" oninput="filterSupplierList(s3SupplierFilter)">
                            <label class="flex items-center text-xs">
                                <input type="checkbox" id="s3_pzafOnly" class="mr-1" onchange="filterSupplierList(s3SupplierFilter)">
                                PZAF만
                            </label>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">클릭하여 필터링 | <button onclick="filterSupplierList('all')" class="text-blue-600 hover:underline">전체보기</button></span>
                            <span class="text-xs text-gray-400" id="s3_supplierCount">0건</span>
                        </div>
                        <div class="border rounded max-h-56 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left">PR번호</th>
                                        <th class="px-2 py-2 text-left">자재번호</th>
                                        <th class="px-2 py-2 text-left">자재내역</th>
                                        <th class="px-2 py-2 text-left">매칭업체</th>
                                        <th class="px-2 py-2 text-center">최근발주일</th>
                                        <th class="px-2 py-2 text-right">최근발주단가</th>
                                    </tr>
                                </thead>
                                <tbody id="s3_supplierList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right: 발주방식 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">📝 발주 방식 검토 <span id="s3_methodFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all" onclick="filterMethodList('배량 후 발주')" id="card_direct">
                                <p class="text-xl font-bold text-blue-600" id="s3_direct">0</p>
                                <p class="text-xs text-gray-600">배량 후 발주</p>
                            </div>
                            <div class="mini-card cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all" onclick="filterMethodList('입찰(견적)진행')" id="card_bidding">
                                <p class="text-xl font-bold text-purple-600" id="s3_bidding">0</p>
                                <p class="text-xs text-gray-600">입찰(견적)진행</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">클릭하여 필터링 | <button onclick="filterMethodList('all')" class="text-blue-600 hover:underline">전체보기</button></span>
                            <span class="text-xs text-gray-400" id="s3_methodCount">0건</span>
                        </div>
                        <div class="border rounded max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left">PR번호</th>
                                        <th class="px-2 py-2 text-left">자재번호</th>
                                        <th class="px-2 py-2 text-left">자재내역</th>
                                        <th class="px-2 py-2 text-left">발주방식</th>
                                        <th class="px-2 py-2 text-left">선정사유</th>
                                    </tr>
                                </thead>
                                <tbody id="s3_methodList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(2)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="goToStep(4)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        다음: 견적 의뢰서 생성 →
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 4: 견적의뢰 생성 ======================= -->
            <div id="step4" class="step-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <!-- Header -->
                    <div class="p-4 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold">📋 견적 의뢰서 생성</h2>
                            <span class="text-gray-600">처리현황: <span id="quotationTotal">0</span>건 중 <span id="quotationAuto">0</span>건 자동완료</span>
                        </div>
                        <!-- Filters -->
                        <div class="mt-3 flex space-x-3">
                            <select id="urgencyFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">긴급도: 전체</option>
                                <option value="긴급">🔴 긴급</option>
                                <option value="일반">🟡 일반</option>
                                <option value="여유">🟢 여유</option>
                            </select>
                            <select id="contractFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">계약방식: 전체</option>
                                <option value="수의계약">수의계약</option>
                                <option value="지명경쟁">지명경쟁</option>
                            </select>
                            <select id="statusFilter" class="text-sm border rounded px-3 py-2">
                                <option value="all">상태: 전체</option>
                                <option value="자동완료">✅ 자동완료</option>
                                <option value="검토필요">⚠️ 검토필요</option>
                            </select>
                            <input type="text" id="searchInput" placeholder="🔍 검색" class="text-sm border rounded px-3 py-2 flex-1">
                        </div>
                    </div>

                    <!-- Main Content: PR List + Detail -->
                    <div class="flex" style="min-height: 500px;">
                        <!-- Left: PR List -->
                        <div class="w-1/3 border-r">
                            <div id="prList" class="overflow-y-auto" style="max-height: 450px;"></div>
                            <div class="p-3 border-t bg-gray-50 text-sm">
                                <p>✅ 자동완료: <span id="autoCompleteCount">0</span>건</p>
                                <p>⚠️ 검토필요: <span id="needReviewCount">0</span>건</p>
                            </div>
                        </div>

                        <!-- Right: Detail View -->
                        <div class="w-2/3 overflow-y-auto" style="max-height: 500px;">
                            <div id="detailView" class="p-6">
                                <div class="text-center text-gray-500 py-16">
                                    <i class="fas fa-file-alt text-4xl mb-4"></i>
                                    <p>PR을 선택하면 견적의뢰 상세 정보가 표시됩니다</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(3)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="goToStep(5)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        다음: 입찰 예정가 산출 →
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 5: 입찰예정가 산정 ======================= -->
            <div id="step5" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">💰 입찰 예정가 산출 <span id="s5_priceFilter" class="text-sm font-normal text-blue-600 ml-2"></span></h2>
                        <span class="text-xs text-gray-400" id="s5_priceCount">0건</span>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div class="mini-card cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all" onclick="filterPriceList('자재+내역 일치')" id="card_exact">
                            <p class="text-xl font-bold text-blue-600" id="s5_exact">0</p>
                            <p class="text-xs text-gray-600">자재+내역 일치</p>
                        </div>
                        <div class="mini-card cursor-pointer hover:ring-2 hover:ring-green-300 transition-all" onclick="filterPriceList('자재별 그룹 단가 평균')" id="card_group">
                            <p class="text-xl font-bold text-green-600" id="s5_group">0</p>
                            <p class="text-xs text-gray-600">자재별 그룹 단가 평균</p>
                        </div>
                        <div class="mini-card cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all" onclick="filterPriceList('도면 유사')" id="card_llm">
                            <p class="text-xl font-bold text-purple-600" id="s5_llm">0</p>
                            <p class="text-xs text-gray-600">도면 유사 사양가</p>
                            <p class="text-[10px] text-purple-400">AI 기반 유사 매칭</p>
                        </div>
                        <div class="mini-card border-l-4 border-orange-500 cursor-pointer hover:ring-2 hover:ring-orange-300 transition-all" onclick="filterPriceList('기본값')" id="card_default">
                            <p class="text-xl font-bold text-orange-600" id="s5_default">0</p>
                            <p class="text-xs text-gray-600">기본값</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" id="s5_priceSearch" placeholder="검색 (PR번호, 자재번호, 내역...)" 
                            class="flex-1 text-xs border rounded px-2 py-1" oninput="filterPriceList(s5PriceFilter)">
                        <button onclick="filterPriceList('all')" class="text-xs text-blue-600 hover:underline">전체보기</button>
                    </div>

                    <div class="border rounded max-h-72 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2 text-left">PR번호</th>
                                    <th class="px-2 py-2 text-left">자재번호</th>
                                    <th class="px-2 py-2 text-left">자재내역</th>
                                    <th class="px-2 py-2 text-left">산정방법</th>
                                    <th class="px-2 py-2 text-center">최근발주일</th>
                                    <th class="px-2 py-2 text-right">최근발주가(총액)</th>
                                    <th class="px-2 py-2 text-right">입찰예정가(총액)</th>
                                    <th class="px-2 py-2 text-center">가격조정</th>
                                </tr>
                            </thead>
                            <tbody id="s5_priceList"></tbody>
                        </table>
                    </div>

                    <div id="priceAlert" class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-700 hidden">
                        <i class="fas fa-info-circle mr-1"></i>기본값 적용 <span id="defaultCount">0</span>건 → 담당자 예정가 직접 입력 권장
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(4)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <div class="flex gap-2">
                        <button onclick="sendQuotationRequest()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            📨 견적 요청
                        </button>
                        <button onclick="goToStep(6)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            다음: 업체 견적 수신 결과 →
                        </button>
                    </div>
                </div>
            </div>

            <!-- ======================= STEP 6: 견적 수신 확인 (Mock) ======================= -->
            <div id="step6" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">📬 업체 견적 수신 결과</h2>
                        <span class="text-sm text-gray-500">* Mock 데이터 시뮬레이션</span>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="mini-card border-l-4 border-green-500">
                            <p class="text-2xl font-bold text-green-600" id="s6_received">0</p>
                            <p class="text-xs text-gray-600">✅ 견적 수신</p>
                        </div>
                        <div class="mini-card border-l-4 border-yellow-500">
                            <p class="text-2xl font-bold text-yellow-600" id="s6_pending">0</p>
                            <p class="text-xs text-gray-600">⏳ 대기중</p>
                        </div>
                        <div class="mini-card border-l-4 border-red-500">
                            <p class="text-2xl font-bold text-red-600" id="s6_overdue">0</p>
                            <p class="text-xs text-gray-600">🔴 미응답</p>
                        </div>
                    </div>

                    <div class="mb-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <button onclick="mockOpenQuotes()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                📭 견적 오픈
                            </button>
                            <button onclick="sendReminderEmails()" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm">
                                📧 독려메일 발송
                            </button>
                        </div>
                        <span class="text-sm text-gray-500">접수기한: 2026-01-03</span>
                    </div>

                    <div class="border rounded max-h-72 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">PR번호</th>
                                    <th class="px-3 py-2 text-left">업체명</th>
                                    <th class="px-3 py-2 text-left">견적상태</th>
                                    <th class="px-3 py-2 text-right">견적금액</th>
                                    <th class="px-3 py-2 text-left">수신일시</th>
                                </tr>
                            </thead>
                            <tbody id="s6_quoteList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(5)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="goToStep(7)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        다음: 견적의뢰 세부 내용 검토 →
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 7: HITL 검토 ======================= -->
            <div id="step7" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">견적 의뢰 세부 내용 검토 (HITL)</h2>
                        <div class="flex items-center gap-3">
                            <select id="s7_viewFilter" class="text-sm border rounded px-3 py-1" onchange="filterHitlList(this.value)">
                                <option value="all">전체 (<span id="s7_allCount">0</span>건)</option>
                                <option value="review" selected>검토필요 (<span id="s7_reviewCount">0</span>건)</option>
                                <option value="appropriate">적정 (<span id="s7_appropriateCount">0</span>건)</option>
                                <option value="requote">재견적 요청 (<span id="s7_requoteCount">0</span>건)</option>
                                <option value="conditional">조건부 승인 (<span id="s7_conditionalCount">0</span>건)</option>
                            </select>
                            <span class="text-sm text-orange-600 font-medium"><span id="hitlTotalCount">0</span>건 검토 필요</span>
                        </div>
                    </div>

                    <div id="hitlList" class="space-y-4">
                        <!-- HITL items will be rendered here -->
                    </div>

                    <div id="noHitlMessage" class="text-center py-12 text-gray-500 hidden">
                        <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                        <p class="text-lg">검토가 필요한 항목이 없습니다.</p>
                        <p class="text-sm">모든 PR이 자동으로 처리되었습니다.</p>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(6)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="goToStep(8)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        다음: 최종 견적 비교 →
                    </button>
                </div>
            </div>

            <!-- ======================= STEP 8: 견적 비교 분석 (Mock) ======================= -->
            <div id="step8" class="step-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">📊 최종 견적 비교</h2>
                        <div class="flex items-center gap-3">
                            <button onclick="requestQuotationAnalysis()" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                🧠 AI 종합 분석
                            </button>
                            <span class="text-sm text-gray-500">* Mock 데이터 시뮬레이션</span>
                        </div>
                    </div>
                    
                    <!-- LLM Analysis Section -->
                    <div id="llmAnalysisSection" class="hidden mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="font-medium text-purple-800 mb-3">🧠 AI 종합 분석 결과</h3>
                        <div id="llmAnalysisContent" class="text-sm space-y-3">
                            <!-- LLM 분석 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="mini-card border-l-4 border-green-500">
                            <p class="text-2xl font-bold text-green-600" id="s8_excellent">0</p>
                            <p class="text-xs text-gray-600">우수</p>
                            <p class="text-xs text-green-500">견적 ≤ 예정가</p>
                        </div>
                        <div class="mini-card border-l-4 border-yellow-500">
                            <p class="text-2xl font-bold text-yellow-600" id="s8_normal">0</p>
                            <p class="text-xs text-gray-600">보통</p>
                            <p class="text-xs text-yellow-500">예정가 < 견적 ≤ 최근발주가</p>
                        </div>
                        <div class="mini-card border-l-4 border-red-500">
                            <p class="text-2xl font-bold text-red-600" id="s8_poor">0</p>
                            <p class="text-xs text-gray-600">열위</p>
                            <p class="text-xs text-red-500">견적 > 예정가 & 최근발주가</p>
                        </div>
                    </div>
                    
                    <!-- 검토결과 카드 -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="mini-card border-l-4 border-blue-500">
                            <p class="text-2xl font-bold text-blue-600" id="s8_appropriate">0</p>
                            <p class="text-xs text-gray-600">적정</p>
                            <p class="text-xs text-blue-500">검토 완료 승인</p>
                        </div>
                        <div class="mini-card border-l-4 border-orange-500">
                            <p class="text-2xl font-bold text-orange-600" id="s8_requote">0</p>
                            <p class="text-xs text-gray-600">재견적</p>
                            <p class="text-xs text-orange-500">가격 협상 필요</p>
                        </div>
                        <div class="mini-card border-l-4 border-purple-500">
                            <p class="text-2xl font-bold text-purple-600" id="s8_conditional">0</p>
                            <p class="text-xs text-gray-600">조건부 승인</p>
                            <p class="text-xs text-purple-500">조건 충족 시 승인</p>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="mb-4">
                        <h3 class="font-medium mb-2">🏆 견적 경쟁력 분석</h3>
                        <div class="border rounded max-h-72 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left">PR번호</th>
                                        <th class="px-3 py-2 text-left">자재번호</th>
                                        <th class="px-3 py-2 text-left">자재내역</th>
                                        <th class="px-3 py-2 text-left">선정업체</th>
                                        <th class="px-3 py-2 text-center">최근발주일</th>
                                        <th class="px-3 py-2 text-right">최근발주단가</th>
                                        <th class="px-3 py-2 text-right">예정단가</th>
                                        <th class="px-3 py-2 text-right">견적단가</th>
                                        <th class="px-3 py-2 text-right">절감율</th>
                                        <th class="px-3 py-2 text-center">경쟁력</th>
                                        <th class="px-3 py-2 text-center">검토결과</th>
                                    </tr>
                                </thead>
                                <tbody id="s8_comparisonList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Final Actions -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-green-800">🎉 처리 완료</h3>
                                <p class="text-sm text-green-600 mt-1">처리시간: <span id="s8_time">0</span>초 | 토큰사용: <span id="s8_tokens">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-between">
                    <button onclick="goToStep(7)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        ← 이전
                    </button>
                    <button onclick="issuePurchaseOrders()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                        📋 PO 발행
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- PO 발행 결과 Modal -->
    <div id="poIssueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">PO 발행 완료</h3>
                <div id="poIssueContent" class="text-gray-600 mb-6">
                    <!-- 발행 결과가 여기에 표시됩니다 -->
                </div>
                <div class="flex gap-3 justify-center">
                    <button onclick="closePoIssueModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        닫기
                    </button>
                    <button onclick="closePoIssueModal(); goToStep(1);" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        처음으로
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HITL Review Modal -->
    <div id="hitlModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold">⚠️ 검토필요 <span id="modalPrId"></span></h3>
            </div>
            <div class="p-6" id="modalContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeHitlModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">취소</button>
                <button onclick="submitHitlDecision()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">✅ 결정 완료</button>
            </div>
        </div>
    </div>

    <!-- Batch Email Modal -->
    <div id="batchEmailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold">📧 이메일 발송 확인</h3>
            </div>
            <div class="p-6" id="batchEmailContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeBatchEmailModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">취소</button>
                <button onclick="sendBatchEmails()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    <i class="fas fa-paper-plane mr-1"></i>발송
                </button>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div id="emailPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">📧 이메일 미리보기</h3>
                <button onclick="closeEmailPreviewModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6" id="emailPreviewContent"></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end">
                <button onclick="closeEmailPreviewModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">닫기</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-8 text-center">
                <div class="text-6xl mb-4">✅</div>
                <h3 class="text-xl font-bold mb-2" id="successTitle">완료</h3>
                <p class="text-gray-600 mb-6" id="successMessage">작업이 완료되었습니다.</p>
                <button onclick="closeSuccessModal()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">확인</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentStep = 1;
        let maxReachedStep = 1;
        let uploadedFiles = [];
        let quotationData = [];
        let selectedPR = null;
        let processingResults = null;
        let allPRData = [];
        let sentEmails = {};
        let mockQuoteStatus = {}; // For step 7 mock

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        // Excel 시리얼 날짜를 YYYY-MM-DD 형식으로 변환
        function formatExcelDate(serial) {
            if (!serial || typeof serial !== 'number') return null;
            // Excel 시리얼 날짜: 1900-01-01 기준 (단, Excel은 1900-02-29를 잘못 계산하므로 -2 보정)
            const excelEpoch = new Date(1899, 11, 30); // 1899-12-30
            const date = new Date(excelEpoch.getTime() + serial * 24 * 60 * 60 * 1000);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            setupDropZone();
            setupFilters();
        });

        async function checkHealth() {
            try {
                const res = await axios.get('/api/health');
                const llmStatus = document.getElementById('llmStatus');
                if (res.data.hasApiKey) {
                    llmStatus.textContent = '🧠 LLM 활성화';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-green-100 text-green-800';
                } else {
                    llmStatus.textContent = '⚠️ LLM 미설정';
                    llmStatus.className = 'text-sm px-2 py-1 rounded bg-yellow-100 text-yellow-800';
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function navigateToStep(step) {
            if (step > maxReachedStep && step > 1) {
                alert('AI 처리를 먼저 완료하세요.');
                return;
            }
            goToStep(step);
        }

        function goToStep(step) {
            currentStep = step;
            
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');

            // Update step indicators
            for (let i = 1; i <= 8; i++) {
                const circle = document.getElementById(`step-circle-${i}`);
                if (i < step) {
                    circle.className = 'step-circle step-completed';
                    circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
                } else if (i === step) {
                    circle.className = 'step-circle step-active';
                    circle.textContent = i;
                } else {
                    circle.className = 'step-circle step-pending';
                    circle.textContent = i;
                }
            }

            // Update step lines
            document.querySelectorAll('.step-line').forEach((el) => {
                const lineNum = parseInt(el.getAttribute('data-line'));
                if (lineNum < step) {
                    el.classList.remove('bg-gray-300');
                    el.classList.add('bg-green-500');
                } else {
                    el.classList.remove('bg-green-500');
                    el.classList.add('bg-gray-300');
                }
            });

            // Load data for specific steps
            if (step === 2) populateStep2();
            if (step === 3) populateStep3();
            if (step === 4) { renderPRList(); updateQuotationCounts(); }
            if (step === 5) populateStep5();
            if (step === 6) populateStep6();
            if (step === 7) populateStep7();
            if (step === 8) populateStep8();
        }

        // ============================================
        // STEP 1: FILE UPLOAD
        // ============================================
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                await handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', async (e) => {
                await handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            if (files.length === 0) return;
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            try {
                const res = await axios.post('/api/upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    updateDataSummary();
                    document.getElementById('startProcessBtn').disabled = false;
                }
            } catch (e) {
                alert('파일 업로드 실패: ' + (e.response?.data?.error || e.message));
            }
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            const list = document.getElementById('fileList');
            container.classList.remove('hidden');
            list.innerHTML = uploadedFiles.map(f => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-file-excel text-green-600 mr-2"></i>
                        <span class="text-xs">${f.filename}</span>
                        <span class="text-xs text-gray-500 ml-1">(${f.rows.toLocaleString()}건)</span>
                    </div>
                    <span class="text-green-600"><i class="fas fa-check"></i></span>
                </div>
            `).join('');
        }

        async function updateDataSummary() {
            try {
                const res = await axios.get('/api/summary');
                document.getElementById('dataSummary').classList.add('hidden');
                document.getElementById('summaryLoaded').classList.remove('hidden');
                document.getElementById('prCount').textContent = res.data.prTotal.toLocaleString();
                document.getElementById('poCount').textContent = res.data.poHistoryTotal.toLocaleString();
                document.getElementById('pzafCount').textContent = res.data.pzafCount.toLocaleString();
            } catch (e) {
                console.error('Summary fetch failed:', e);
            }
        }

        // Load Sample Data
        document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);

        async function loadSampleData() {
            const btn = document.getElementById('loadSampleBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>불러오는 중...';
            try {
                const res = await axios.post('/api/load-sample');
                if (res.data.success) {
                    uploadedFiles = res.data.files;
                    displayUploadedFiles();
                    await updateDataSummary();
                    document.getElementById('startProcessBtn').disabled = false;
                    btn.innerHTML = '<i class="fas fa-check mr-1"></i>불러오기 완료';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-gray-400');
                }
            } catch (e) {
                alert('데이터 로드 실패: ' + (e.response?.data?.error || e.message));
                btn.disabled = false;
                btn.innerHTML = '📂 PR 불러오기';
            }
        }

        // Start Processing
        document.getElementById('startProcessBtn').addEventListener('click', startProcessing);

        async function startProcessing() {
            // Show processing dashboard
            document.getElementById('processingDashboard').classList.remove('hidden');
            document.getElementById('startProcessBtn').disabled = true;
            document.getElementById('startProcessBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>처리중...';

            try {
                const res = await axios.post('/api/process');
                
                if (res.data.success) {
                    processingResults = res.data.results;
                    quotationData = res.data.results.quotationData || [];
                    allPRData = res.data.results.allPRData || quotationData;
                    
                    // Update dashboard with final stats
                    const summary = processingResults.summary;
                    document.getElementById('dashTotal').textContent = summary.total;
                    document.getElementById('dashAuto').textContent = summary.autoComplete;
                    document.getElementById('dashHITL').textContent = summary.needReview;
                    document.getElementById('dashLLM').textContent = summary.llmCalls;
                    document.getElementById('dashProgress').style.width = '100%';
                    document.getElementById('dashboardStatus').textContent = '처리 완료!';
                    document.getElementById('dashboardStep').textContent = `${summary.total}건 처리 완료`;
                    
                    maxReachedStep = 8; // All steps accessible
                    
                    // Show validation results in Step 1
                    showValidationResults();
                    
                    // Hide dashboard after delay
                    setTimeout(() => {
                        document.getElementById('processingDashboard').classList.add('hidden');
                    }, 3000);
                }
            } catch (e) {
                alert('처리 실패: ' + (e.response?.data?.error || e.message));
            } finally {
                document.getElementById('startProcessBtn').innerHTML = '🚀 AI 처리 시작';
            }
        }

        function showValidationResults() {
            const results = document.getElementById('validationResults');
            results.classList.remove('hidden');
            
            const invalidPR = processingResults.invalidPR || [];
            const validCount = processingResults.summary.totalPR || allPRData.length || 0;
            
            document.getElementById('validCount2').textContent = validCount.toLocaleString();
            document.getElementById('invalidCount2').textContent = invalidPR.length.toLocaleString();
            
            if (invalidPR.length > 0) {
                document.getElementById('invalidSection').classList.remove('hidden');
                document.getElementById('invalidPRList').innerHTML = invalidPR.slice(0, 30).map((pr, idx) => {
                    // 각 필드 유효/누락 체크
                    const checkField = (field) => pr[field] ? '✅' : '❌';
                    return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-2 text-xs">⚠️ ${pr['구매요청'] || '-'}</td>
                        <td class="px-2 py-2 text-center">${checkField('자재번호')}</td>
                        <td class="px-2 py-2 text-center">${checkField('내역')}</td>
                        <td class="px-2 py-2 text-center">${checkField('구매요청일')}</td>
                        <td class="px-2 py-2 text-center">${checkField('PR납기일')}</td>
                        <td class="px-2 py-2 text-center">${checkField('LEAD_TIME')}</td>
                        <td class="px-2 py-2 text-center">${checkField('소싱그룹')}</td>
                        <td class="px-2 py-2 text-center">${checkField('자재그룹')}</td>
                        <td class="px-2 py-2 text-xs">${pr['담당자'] || pr['구매요청자'] || '-'}</td>
                        <td class="px-2 py-2 text-center">
                            <button onclick="openEmailPreview(${idx})" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                📧
                            </button>
                        </td>
                    </tr>
                `}).join('');
            }
        }

        // ============================================
        // STEP 2: 계약/긴급도 확인
        // ============================================
        let s2ContractFilter = 'all';
        let s2UrgencyFilter = 'all';
        
        function populateStep2() {
            if (!processingResults) return;
            
            // Step 2는 전체 PR 데이터 사용 (PZAF 필터링 전)
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // 계약분류 카운트 계산
            const standard = data.filter(pr => pr['계약분류'] === '표준단가').length;
            const nonStandard = data.filter(pr => pr['계약분류'] === '비표준단가').length;
            const na = data.filter(pr => pr['계약분류'] === 'NA' || !pr['계약분류']).length;
            
            // 긴급도 카운트 계산
            const urgent = data.filter(pr => pr['긴급도'] === '긴급').length;
            const normal = data.filter(pr => pr['긴급도'] === '일반').length;
            const flexible = data.filter(pr => pr['긴급도'] === '여유').length;
            
            document.getElementById('s2_standard').textContent = standard.toLocaleString();
            document.getElementById('s2_nonStandard').textContent = nonStandard.toLocaleString();
            document.getElementById('s2_na').textContent = na.toLocaleString();
            document.getElementById('s2_urgent').textContent = urgent.toLocaleString();
            document.getElementById('s2_normal').textContent = normal.toLocaleString();
            document.getElementById('s2_flexible').textContent = flexible.toLocaleString();
            
            // Initial render with all data
            filterContractList(s2ContractFilter);
            filterUrgencyList(s2UrgencyFilter);
        }
        
        function filterContractList(filterType) {
            s2ContractFilter = filterType;
            
            // Step 2는 전체 PR 데이터 사용
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_standard', 'card_nonStandard', 'card_na'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-blue-500', 'ring-purple-500', 'ring-orange-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === '표준단가') {
                filtered = data.filter(pr => pr['계약분류'] === '표준단가');
                document.getElementById('card_standard')?.classList.add('ring-2', 'ring-blue-500');
                filterLabel = '(표준단가)';
            } else if (filterType === '비표준단가') {
                filtered = data.filter(pr => pr['계약분류'] === '비표준단가');
                document.getElementById('card_nonStandard')?.classList.add('ring-2', 'ring-purple-500');
                filterLabel = '(비표준단가)';
            } else if (filterType === 'NA') {
                filtered = data.filter(pr => pr['계약분류'] === 'NA' || !pr['계약분류']);
                document.getElementById('card_na')?.classList.add('ring-2', 'ring-orange-500');
                filterLabel = '(견적대상)';
            }
            
            document.getElementById('s2_contractFilter').textContent = filterLabel;
            document.getElementById('s2_contractCount').textContent = `${filtered.length}건`;
            
            document.getElementById('s2_contractList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-2 py-2 text-xs">${pr['구매요청'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600" title="${pr['자재번호'] || ''}">${(pr['자재번호'] || '-').substring(0, 12)}${(pr['자재번호']?.length > 12) ? '...' : ''}</td>
                    <td class="px-2 py-2 text-xs truncate max-w-[80px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 10)}${(pr['내역']?.length > 10) ? '...' : ''}</td>
                    <td class="px-2 py-2">
                        <span class="px-1.5 py-0.5 rounded text-xs ${pr['계약분류'] === '표준단가' ? 'bg-blue-100 text-blue-800' : pr['계약분류'] === 'NA' ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800'}">
                            ${pr['계약분류'] || '-'}
                        </span>
                    </td>
                    <td class="px-2 py-2 text-xs text-gray-600">${pr['단가계약번호'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600">${pr['자동배량그룹'] || '-'}</td>
                </tr>
            `).join('');
        }
        
        function filterUrgencyList(filterType) {
            s2UrgencyFilter = filterType;
            
            // Step 2는 전체 PR 데이터 사용
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_urgent', 'card_normal', 'card_flexible'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-red-500', 'ring-yellow-500', 'ring-green-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === '긴급') {
                filtered = data.filter(pr => pr['긴급도'] === '긴급');
                document.getElementById('card_urgent')?.classList.add('ring-2', 'ring-red-500');
                filterLabel = '(긴급)';
            } else if (filterType === '일반') {
                filtered = data.filter(pr => pr['긴급도'] === '일반');
                document.getElementById('card_normal')?.classList.add('ring-2', 'ring-yellow-500');
                filterLabel = '(일반)';
            } else if (filterType === '여유') {
                filtered = data.filter(pr => pr['긴급도'] === '여유');
                document.getElementById('card_flexible')?.classList.add('ring-2', 'ring-green-500');
                filterLabel = '(여유)';
            }
            
            // Sort by 실제잔여일수 ascending (most urgent first)
            filtered.sort((a, b) => {
                const aRemain = a['실제잔여일수'] ?? 999;
                const bRemain = b['실제잔여일수'] ?? 999;
                return aRemain - bRemain;
            });
            
            document.getElementById('s2_urgencyFilter').textContent = filterLabel;
            document.getElementById('s2_urgencyCount').textContent = `${filtered.length}건`;
            
            document.getElementById('s2_urgencyList').innerHTML = filtered.map(pr => `
                <tr class="border-b hover:bg-gray-50 ${pr['긴급도'] === '긴급' ? 'bg-red-50' : ''}">
                    <td class="px-2 py-2 text-xs">${pr['긴급도_신호'] || '🟡'} ${pr['구매요청'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600" title="${pr['자재번호'] || ''}">${(pr['자재번호'] || '-').substring(0, 12)}${(pr['자재번호']?.length > 12) ? '...' : ''}</td>
                    <td class="px-2 py-2 text-xs truncate max-w-[80px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 10)}${(pr['내역']?.length > 10) ? '...' : ''}</td>
                    <td class="px-2 py-2 text-xs">${pr['PR납기일_변환'] || formatExcelDate(pr['PR납기일']) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${pr['LEAD_TIME'] || '-'}</td>
                    <td class="px-2 py-2 text-xs ${(pr['실제잔여일수'] ?? 999) <= 0 ? 'text-red-600 font-bold' : ''}">${pr['실제잔여일수'] ?? '-'}일</td>
                    <td class="px-2 py-2">
                        <span class="text-xs ${pr['긴급도'] === '긴급' ? 'text-red-600' : pr['긴급도'] === '일반' ? 'text-yellow-600' : 'text-green-600'}">${pr['긴급도'] || '-'}</span>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // STEP 3: 업체/발주방식 판단
        // ============================================
        let s3SupplierFilter = 'all';
        let s3MethodFilter = 'all';
        
        function populateStep3() {
            if (!processingResults) return;
            
            // Step 3: 업체 검토는 전체 PR, 발주방식은 PZAF(336건)만
            const allData = allPRData.length > 0 ? allPRData : quotationData;
            const pzafData = quotationData; // PZAF 대상 336건
            
            const matched = allData.filter(pr => pr['업체매칭여부']).length;
            const unmatched = allData.length - matched;
            // 발주방식은 PZAF 데이터만 사용 (견적대상 336건)
            const direct = pzafData.filter(pr => pr['계약분류'] === '표준단가').length;
            const bidding = pzafData.filter(pr => pr['계약분류'] !== '표준단가').length;
            
            document.getElementById('s3_matched').textContent = matched.toLocaleString();
            document.getElementById('s3_unmatched').textContent = unmatched.toLocaleString();
            document.getElementById('s3_direct').textContent = direct.toLocaleString();
            document.getElementById('s3_bidding').textContent = bidding.toLocaleString();
            
            // Initial render with current filter
            filterSupplierList(s3SupplierFilter);
            filterMethodList(s3MethodFilter);
        }
        
        function filterSupplierList(filterType) {
            s3SupplierFilter = filterType;
            
            // Step 3는 전체 PR 데이터 사용
            const data = allPRData.length > 0 ? allPRData : quotationData;
            
            // Update card selection styles
            ['card_matched', 'card_unmatched'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-green-500', 'ring-red-500');
            });
            
            // PZAF 필터링 먼저 확인
            const pzafOnly = document.getElementById('s3_pzafOnly')?.checked;
            let baseData = [...data];
            if (pzafOnly) {
                baseData = data.filter(pr => pr['PZAF여부'] || (pr['자재번호'] && pr['자재번호'].includes('PZAF')));
            }
            
            // PZAF 필터에 따른 카드 숫자 업데이트
            const matchedCount = baseData.filter(pr => pr['업체매칭여부']).length;
            const unmatchedCount = baseData.filter(pr => !pr['업체매칭여부']).length;
            document.getElementById('s3_matched').textContent = matchedCount.toLocaleString();
            document.getElementById('s3_unmatched').textContent = unmatchedCount.toLocaleString();
            
            let filtered = [...baseData];
            let filterLabel = pzafOnly ? 'PZAF ' : '';
            
            // 카드 필터링
            if (filterType === 'matched') {
                filtered = baseData.filter(pr => pr['업체매칭여부']);
                document.getElementById('card_matched')?.classList.add('ring-2', 'ring-green-500');
                filterLabel += '(매칭성공)';
            } else if (filterType === 'unmatched') {
                filtered = baseData.filter(pr => !pr['업체매칭여부']);
                document.getElementById('card_unmatched')?.classList.add('ring-2', 'ring-red-500');
                filterLabel += '(신규업체필요)';
            }
            
            // 검색 필터링
            const searchTerm = (document.getElementById('s3_supplierSearch')?.value || '').toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(pr => 
                    (pr['구매요청'] || '').toLowerCase().includes(searchTerm) ||
                    (pr['자재번호'] || '').toLowerCase().includes(searchTerm) ||
                    (pr['내역'] || '').toLowerCase().includes(searchTerm) ||
                    (pr['매칭업체명'] || '').toLowerCase().includes(searchTerm)
                );
            }
            
            document.getElementById('s3_supplierFilter').textContent = filterLabel;
            document.getElementById('s3_supplierCount').textContent = `${filtered.length}건`;
            
            document.getElementById('s3_supplierList').innerHTML = filtered.map(pr => {
                const orderDate = pr['최근발주일'] || '2025-12-15';  // Mock 발주일
                const isMatched = pr['업체매칭여부'];
                return `
                <tr class="border-b hover:bg-gray-50 ${!isMatched ? 'bg-red-50' : ''}">
                    <td class="px-2 py-2 text-xs">${pr['구매요청'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600">${pr['자재번호'] || '-'}</td>
                    <td class="px-2 py-2 text-xs truncate max-w-[100px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 12)}${(pr['내역']?.length > 12) ? '...' : ''}</td>
                    <td class="px-2 py-2 text-xs">${pr['매칭업체명'] || '<span class="text-red-500">신규필요</span>'}</td>
                    <td class="px-2 py-2 text-xs text-center text-gray-500">${isMatched ? orderDate : '-'}</td>
                    <td class="px-2 py-2 text-xs text-right">${isMatched && pr['최근발주단가'] > 0 ? '₩' + pr['최근발주단가'].toLocaleString() : '-'}</td>
                </tr>
            `}).join('');
        }
        
        function filterMethodList(filterType) {
            s3MethodFilter = filterType;
            
            // 발주방식은 PZAF 대상(336건)만 사용
            const data = quotationData;
            
            // Update card selection styles
            ['card_direct', 'card_bidding'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-blue-500', 'ring-purple-500');
            });
            
            let filtered = [...data];
            let filterLabel = '';
            
            if (filterType === '배량 후 발주') {
                filtered = data.filter(pr => pr['계약분류'] === '표준단가');
                document.getElementById('card_direct')?.classList.add('ring-2', 'ring-blue-500');
                filterLabel = '(배량 후 발주)';
            } else if (filterType === '입찰(견적)진행') {
                filtered = data.filter(pr => pr['계약분류'] !== '표준단가');
                document.getElementById('card_bidding')?.classList.add('ring-2', 'ring-purple-500');
                filterLabel = '(입찰(견적)진행)';
            }
            
            document.getElementById('s3_methodFilter').textContent = filterLabel;
            document.getElementById('s3_methodCount').textContent = `${filtered.length}건`;
            
            document.getElementById('s3_methodList').innerHTML = filtered.map(pr => {
                const isStandard = pr['계약분류'] === '표준단가';
                const selectionReason = isStandard ? '배량그룹 존재 표준 단가 계약 품목' : '배량 그룹 미존재 견적 대상 품목';
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-2 py-2 text-xs">${pr['구매요청'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600">${pr['자재번호'] || '-'}</td>
                    <td class="px-2 py-2 text-xs truncate max-w-[100px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 12)}${(pr['내역']?.length > 12) ? '...' : ''}</td>
                    <td class="px-2 py-2">
                        <span class="text-xs ${isStandard ? 'text-blue-600' : 'text-purple-600'}">${isStandard ? '배량 후 발주' : '입찰(견적)진행'}</span>
                    </td>
                    <td class="px-2 py-2 text-xs truncate max-w-[150px]" title="${selectionReason}">${selectionReason}</td>
                </tr>
            `}).join('');
        }

        // ============================================
        // STEP 4: 견적의뢰 관리
        // ============================================
        function setupFilters() {
            document.getElementById('urgencyFilter').addEventListener('change', renderPRList);
            document.getElementById('contractFilter').addEventListener('change', renderPRList);
            document.getElementById('statusFilter').addEventListener('change', renderPRList);
            document.getElementById('searchInput').addEventListener('input', renderPRList);
        }

        function updateQuotationCounts() {
            document.getElementById('quotationTotal').textContent = quotationData.length;
            document.getElementById('quotationAuto').textContent = quotationData.filter(p => p['처리상태'] === '자동완료').length;
        }

        function renderPRList() {
            const urgencyFilter = document.getElementById('urgencyFilter').value;
            const contractFilter = document.getElementById('contractFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filtered = [...quotationData];
            if (urgencyFilter !== 'all') filtered = filtered.filter(pr => pr['긴급도'] === urgencyFilter);
            if (contractFilter !== 'all') filtered = filtered.filter(pr => pr['계약방식'] === contractFilter);
            if (statusFilter !== 'all') filtered = filtered.filter(pr => pr['처리상태'] === statusFilter);
            if (searchText) {
                filtered = filtered.filter(pr => 
                    (pr['구매요청'] || '').toLowerCase().includes(searchText) ||
                    (pr['자재번호'] || '').toLowerCase().includes(searchText) ||
                    (pr['내역'] || '').toLowerCase().includes(searchText)
                );
            }

            const container = document.getElementById('prList');
            container.innerHTML = filtered.map(pr => {
                const urgencyClass = pr['긴급도'] === '긴급' ? 'urgency-urgent' : 
                                    pr['긴급도'] === '일반' ? 'urgency-normal' : 'urgency-flexible';
                const isExcluded = pr['견적제외'] === true;
                
                return `
                    <div class="sidebar-item p-3 border-b cursor-pointer ${urgencyClass} ${selectedPR === pr['구매요청'] ? 'selected' : ''} ${isExcluded ? 'opacity-50' : ''}"
                         onclick="selectPR('${pr['구매요청']}')">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start gap-2">
                                <input type="checkbox" ${!isExcluded ? 'checked' : ''} 
                                    onclick="event.stopPropagation(); toggleQuotationExclude('${pr['구매요청']}')" 
                                    class="mt-1" title="체크 해제 시 견적의뢰 제외">
                                <div>
                                    <p class="font-medium text-sm">${pr['구매요청']}</p>
                                    <p class="text-xs text-gray-600 truncate" style="max-width: 160px;">${pr['내역'] || ''}</p>
                                </div>
                            </div>
                            <span class="text-xs px-1 py-0.5 rounded ${pr['처리상태'] === '자동완료' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">${pr['처리상태'] === '자동완료' ? '자동' : '검토'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 ml-6">
                            ${pr['계약방식'] || ''} | ${pr['긴급도'] || ''}
                        </div>
                    </div>
                `;
            }).join('');

            const autoComplete = quotationData.filter(p => p['처리상태'] === '자동완료').length;
            const needReview = quotationData.filter(p => p['처리상태'] === '검토필요').length;
            document.getElementById('autoCompleteCount').textContent = autoComplete;
            document.getElementById('needReviewCount').textContent = needReview;
        }

        function selectPR(prId) {
            selectedPR = prId;
            renderPRList();
            renderDetailView(prId);
        }

        // 견적의뢰 제외 토글
        function toggleQuotationExclude(prId) {
            const pr = quotationData.find(p => p['구매요청'] === prId);
            if (pr) {
                pr['견적제외'] = !pr['견적제외'];
                renderPRList();
                if (selectedPR === prId) {
                    renderDetailView(prId);
                }
            }
        }

        function renderDetailView(prId) {
            const pr = quotationData.find(p => p['구매요청'] === prId);
            if (!pr) return;

            const container = document.getElementById('detailView');
            const estimatedPrice = pr['입찰예정가'] || 0;
            const exchangeRate = 1453;
            const estimatedPriceUSD = Math.round(estimatedPrice / exchangeRate);
            const randomVendors = pr['초청협력회사'] || generateRandomVendors(pr);

            container.innerHTML = `
                <div class="space-y-4">
                    <!-- Header -->
                    <div class="flex justify-between items-start pb-3 border-b">
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs">견적의뢰번호</span>
                                <span class="font-bold">RFQ-${pr['구매요청']}</span>
                            </div>
                            <p class="text-gray-600 text-xs">차수: 1</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            pr['처리상태'] === '자동완료' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                        }">
                            ${pr['처리상태'] === '자동완료' ? '✅ 자동완료' : '⚠️ 검토필요'}
                        </span>
                    </div>

                    <!-- 기본정보 -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">기본정보</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">입찰목적물</span><p class="font-medium truncate">${pr['내역'] || '-'}</p></div>
                            <div><span class="text-gray-500">소싱그룹</span><p class="font-medium">${pr['소싱그룹'] || '-'}</p></div>
                            <div><span class="text-gray-500">구매담당</span><p class="font-medium">${pr['구매원'] || '-'}</p></div>
                            <div><span class="text-gray-500">시리즈호선</span><p class="font-medium">${(pr['자재번호'] || '').substring(0, 4) || '-'}</p></div>
                            <div><span class="text-gray-500">일반/긴급</span><p class="font-medium">${pr['긴급도_신호'] || ''} ${pr['긴급도'] || '-'}</p></div>
                        </div>
                    </div>

                    <!-- 계약정보 -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">계약정보</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">계약방식</span><p class="font-medium">${pr['계약방식'] || '-'}</p></div>
                            <div><span class="text-gray-500">계약대상자선정방식</span><p class="font-medium">최저가</p></div>
                            <div><span class="text-gray-500">단가계약여부</span><p class="font-medium">${pr['계약분류'] || '-'}</p></div>
                            <div><span class="text-gray-500">단가계약번호</span><p class="font-medium">${pr['단가계약번호'] || '-'}</p></div>
                        </div>
                        ${pr['계약방식_선정사유'] ? `
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <span class="text-gray-500 text-xs">선정사유</span>
                            <p class="font-medium text-xs mt-1 text-blue-700 leading-relaxed">${pr['계약방식_선정사유']}</p>
                        </div>
                        ` : ''}
                    </div>

                    <!-- 입찰조건 -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">입찰조건</h4>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">조건변경</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div><span class="text-gray-500">업체선정</span><p class="font-medium">문서별</p></div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">부분입찰</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">전자계약</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">AVL품목</span>
                                <select class="text-xs border rounded px-1 py-0.5 bg-white"><option value="Y" selected>Y</option><option value="N">N</option></select>
                            </div>
                        </div>
                    </div>

                    <!-- 수량정보 -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">수량정보</h4>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div><span class="text-gray-500">요청수량</span><p class="font-medium">${pr['요청수량'] || '-'} ${pr['UOM'] || 'EA'}</p></div>
                            <div><span class="text-gray-500">총중량(KG)</span><p class="font-medium">${pr['매칭_발주중량'] || pr['총중량'] || '-'}</p></div>
                        </div>
                    </div>

                    <!-- 협력회사 -->
                    <div class="bg-gray-50 rounded p-3">
                        <h4 class="font-medium text-xs text-gray-700 mb-2">초청협력회사 <span class="text-gray-400">(2~3개 랜덤)</span></h4>
                        <div class="space-y-1">
                            ${randomVendors.map(vendor => `
                                <label class="flex items-center text-xs">
                                    <input type="checkbox" checked class="mr-2">
                                    <span>${vendor.name} ${vendor.isMatched ? '<span class="text-blue-600">(매칭)</span>' : ''}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="mt-2 p-2 bg-gray-200 rounded text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>이전견적의뢰 최고평가협력사 누락 여부
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-end space-x-2 pt-3 border-t">
                        ${pr['HITL필요'] ? `
                            <button onclick="openHitlModal('${pr['구매요청']}')" class="px-3 py-1.5 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">
                                검토하기
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function generateRandomVendors(pr) {
            const sampleVendors = ['(주)대한배관', '삼성중공업', '현대스틸', '포스코건설', '한화에어로스페이스', 'STX중공업', '대우조선해양', 'SK에코플랜트', '두산중공업', 'GS건설'];
            const vendors = [];
            if (pr['매칭업체명']) vendors.push({ name: pr['매칭업체명'], isMatched: true });
            const count = pr['매칭업체명'] ? Math.floor(Math.random() * 2) + 1 : Math.floor(Math.random() * 2) + 2;
            const shuffled = sampleVendors.filter(v => v !== pr['매칭업체명']).sort(() => 0.5 - Math.random());
            for (let i = 0; i < count && i < shuffled.length; i++) {
                vendors.push({ name: shuffled[i], isMatched: false });
            }
            return vendors;
        }

        // ============================================
        // STEP 5: 입찰예정가 산정
        // ============================================
        let s5PriceFilter = 'all';
        
        function populateStep5() {
            if (!processingResults) return;
            const priceMethods = processingResults.summary.priceMethodSummary || {};
            
            const exact = priceMethods['자재+내역 일치'] || 0;
            const group = priceMethods['자재별 그룹 단가 평균'] || 0;
            const llm = priceMethods['도면 유사 사양가'] || 0;
            const def = priceMethods['기본값'] || 0;
            
            document.getElementById('s5_exact').textContent = exact.toLocaleString();
            document.getElementById('s5_group').textContent = group.toLocaleString();
            document.getElementById('s5_llm').textContent = llm.toLocaleString();
            document.getElementById('s5_default').textContent = def.toLocaleString();
            
            if (def > 0) {
                document.getElementById('priceAlert').classList.remove('hidden');
                document.getElementById('defaultCount').textContent = def;
            }
            
            // Initial render
            filterPriceList(s5PriceFilter);
        }
        
        // 예정가 산정 근거 보기 함수
        async function showPriceReasoning(prId) {
            try {
                const response = await fetch(`/api/price-reasoning/${prId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    alert('근거 정보를 가져올 수 없습니다.');
                    return;
                }
                
                let detailHtml = '';
                
                if (data.method === '도면 유사 사양가' && data.detail?.similarInfo) {
                    const info = data.detail.similarInfo;
                    detailHtml = `
                        <!-- Step 1: 왜 도면 유사 사양가를 사용했는지 -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-yellow-600 font-bold mr-2">Step 1</span>
                                <div>
                                    <p class="font-medium text-yellow-800">실적가 없음 → 도면 유사 사양가 적용</p>
                                    <p class="text-xs text-yellow-700 mt-1">해당 자재의 동일 자재번호+내역 기준 과거 발주 실적이 없어, AI가 유사 도면 기반으로 예상가를 산정했습니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: 자재속성 + 패턴 추출 -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-blue-600 font-bold mr-2">Step 2</span>
                                <div class="flex-1">
                                    <p class="font-medium text-blue-800">자재 속성 분석 및 패턴 추출</p>
                                    <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                                        <div class="bg-white p-2 rounded">
                                            <p class="text-gray-500">자재번호</p>
                                            <p class="font-mono font-bold">${data.materialNo || '-'}</p>
                                        </div>
                                        <div class="bg-white p-2 rounded">
                                            <p class="text-gray-500">추출된 패턴</p>
                                            <p class="font-mono font-bold text-blue-600">${info.prefix || '-'}</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-blue-700 mt-2">→ 자재번호에서 호선번호(5자리)를 제외하고 자재그룹 패턴(${info.prefix})을 추출했습니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: 유사 도면 매칭 -->
                        <div class="bg-purple-50 border-l-4 border-purple-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-purple-600 font-bold mr-2">Step 3</span>
                                <div class="flex-1">
                                    <p class="font-medium text-purple-800">유사 도면 매칭 (${info.drawingInfo?.length || 0}건 발견)</p>
                                    ${info.drawingInfo?.length > 0 ? `
                                    <div class="mt-2 text-xs bg-white p-2 rounded max-h-24 overflow-y-auto">
                                        ${info.drawingInfo.map(d => `
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="font-mono">${d.stockNumber}</span>
                                                <span class="text-gray-600">${d.standardName} | ${d.material} | ${d.weightPerUnit}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-purple-700 mt-2">→ 패턴 <strong>${info.prefix}</strong>와 일치하는 도면 ${info.drawingInfo?.length || 0}건을 DB에서 검색했습니다.</p>
                                    ` : '<p class="text-xs text-purple-700 mt-2">→ 도면 DB에서 유사 패턴을 검색했습니다.</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: 과거 PO 실적 조회 -->
                        <div class="bg-green-50 border-l-4 border-green-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-green-600 font-bold mr-2">Step 4</span>
                                <div class="flex-1">
                                    <p class="font-medium text-green-800">과거 PO 발주 실적 조회 (${info.similarCount || 0}건)</p>
                                    ${info.priceDetails?.length > 0 ? `
                                    <div class="mt-2 text-xs bg-white rounded overflow-hidden">
                                        <table class="w-full">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="text-left p-1">자재번호</th>
                                                    <th class="text-right p-1">발주금액</th>
                                                    <th class="text-right p-1">중량</th>
                                                    <th class="text-right p-1">kg당 단가</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            ${info.priceDetails.slice(0, 5).map(p => `
                                                <tr class="border-t border-gray-100">
                                                    <td class="p-1 font-mono text-xs">${p.materialNo}</td>
                                                    <td class="text-right p-1">₩${p.amount.toLocaleString()}</td>
                                                    <td class="text-right p-1">${p.weight}kg</td>
                                                    <td class="text-right p-1 font-bold">₩${p.pricePerKg.toLocaleString()}</td>
                                                </tr>
                                            `).join('')}
                                            </tbody>
                                        </table>
                                        ${info.priceDetails.length > 5 ? `<p class="text-center text-gray-400 py-1">... 외 ${info.priceDetails.length - 5}건</p>` : ''}
                                    </div>
                                    ` : ''}
                                    <p class="text-xs text-green-700 mt-2">→ 동일 패턴(${info.prefix}) 자재의 과거 발주 실적 <strong>${info.similarCount}건</strong>을 조회하여 평균 단가를 산출했습니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: 최종 예상가 산출 -->
                        <div class="bg-indigo-100 border-l-4 border-indigo-500 p-3 rounded">
                            <div class="flex items-start">
                                <span class="text-indigo-600 font-bold mr-2">Step 5</span>
                                <div class="flex-1">
                                    <p class="font-medium text-indigo-800">최종 예상가 산출</p>
                                    <div class="mt-2 bg-white p-3 rounded text-sm">
                                        <div class="grid grid-cols-3 gap-2 text-center mb-3">
                                            <div>
                                                <p class="text-xs text-gray-500">평균 kg당 단가</p>
                                                <p class="font-bold text-indigo-600">₩${(info.avgPricePerKg || 0).toLocaleString()}</p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500">추정 중량</p>
                                                <p class="font-bold text-indigo-600">${info.estimatedWeight || info.avgUnitWeight || '-'}kg</p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500">요청수량</p>
                                                <p class="font-bold text-indigo-600">${data.quantity || 1}EA</p>
                                            </div>
                                        </div>
                                        <div class="bg-indigo-50 p-2 rounded text-center">
                                            <p class="text-xs text-gray-600 mb-1">산정 공식</p>
                                            <p class="font-mono text-sm">
                                                <span class="text-indigo-600">₩${(info.avgPricePerKg || 0).toLocaleString()}</span>/kg × 
                                                <span class="text-indigo-600">${info.estimatedWeight || info.avgUnitWeight || 0}</span>kg × 
                                                <span class="text-indigo-600">${data.quantity || 1}</span>EA
                                            </p>
                                            <p class="text-lg font-bold text-indigo-800 mt-1">= ₩${(data.estimatedPrice || 0).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (data.method === '자재별 그룹 단가 평균') {
                    detailHtml = `
                        <!-- Step 1: 왜 자재별 그룹 단가 평균을 사용했는지 -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-yellow-600 font-bold mr-2">Step 1</span>
                                <div>
                                    <p class="font-medium text-yellow-800">실적가 없음 + 도면 미매칭 → 그룹 평균 단가 적용</p>
                                    <p class="text-xs text-yellow-700 mt-1">해당 자재의 과거 발주 실적이 없고, 유사 도면도 찾지 못해 자재그룹 기준 평균 단가로 예상가를 산정했습니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: 자재그룹 분류 -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-blue-600 font-bold mr-2">Step 2</span>
                                <div class="flex-1">
                                    <p class="font-medium text-blue-800">자재그룹 분류</p>
                                    <div class="mt-2 bg-white p-2 rounded">
                                        <p class="text-xs text-gray-500">해당 자재그룹</p>
                                        <p class="font-mono font-bold text-blue-600">${data.detail?.group || data.materialGroup || '-'}</p>
                                    </div>
                                    <p class="text-xs text-blue-700 mt-2">→ PR 데이터의 자재그룹 필드를 기준으로 분류했습니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: 그룹 평균 단가 산출 -->
                        <div class="bg-green-50 border-l-4 border-green-400 p-3 rounded mb-4">
                            <div class="flex items-start">
                                <span class="text-green-600 font-bold mr-2">Step 3</span>
                                <div class="flex-1">
                                    <p class="font-medium text-green-800">그룹 내 과거 PO 실적 기반 평균 단가</p>
                                    <div class="mt-2 bg-white p-2 rounded text-sm">
                                        <p class="text-xs text-gray-500 mb-1">산출 방식</p>
                                        <p class="text-gray-700">동일 자재그룹의 과거 PO 실적에서 <strong>총 발주금액 ÷ 총 발주중량</strong>으로 kg당 평균 단가를 산출</p>
                                    </div>
                                    <p class="text-xs text-green-700 mt-2">→ 그룹 평균 kg당 단가: <strong>₩${(data.detail?.avgPricePerKg || 0).toLocaleString()}/kg</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: 최종 예상가 산출 -->
                        <div class="bg-indigo-100 border-l-4 border-indigo-500 p-3 rounded">
                            <div class="flex items-start">
                                <span class="text-indigo-600 font-bold mr-2">Step 4</span>
                                <div class="flex-1">
                                    <p class="font-medium text-indigo-800">최종 예상가 산출</p>
                                    <div class="mt-2 bg-white p-3 rounded text-sm">
                                        <div class="grid grid-cols-3 gap-2 text-center mb-3">
                                            <div>
                                                <p class="text-xs text-gray-500">그룹 평균 kg당 단가</p>
                                                <p class="font-bold text-indigo-600">₩${(data.detail?.avgPricePerKg || 0).toLocaleString()}</p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500">단중(kg)</p>
                                                <p class="font-bold text-indigo-600">${data.unitWeight || '-'}kg</p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500">요청수량</p>
                                                <p class="font-bold text-indigo-600">${data.quantity || 1}EA</p>
                                            </div>
                                        </div>
                                        <div class="bg-indigo-50 p-2 rounded text-center">
                                            <p class="text-xs text-gray-600 mb-1">산정 공식</p>
                                            <p class="font-mono text-sm">
                                                <span class="text-indigo-600">₩${(data.detail?.avgPricePerKg || 0).toLocaleString()}</span>/kg × 
                                                <span class="text-indigo-600">${data.unitWeight || 0}</span>kg × 
                                                <span class="text-indigo-600">${data.quantity || 1}</span>EA
                                            </p>
                                            <p class="text-lg font-bold text-indigo-800 mt-1">= ₩${(data.estimatedPrice || 0).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    detailHtml = `
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm">${data.detail?.description || '상세 정보 없음'}</p>
                        </div>
                    `;
                }
                
                // 모달 표시
                const modalHtml = `
                    <div id="priceReasoningModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this) this.remove()">
                        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                                <h3 class="font-bold text-lg">📋 예정가 산정 근거</h3>
                                <button onclick="document.getElementById('priceReasoningModal').remove()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                            </div>
                            <div class="p-4">
                                <div class="mb-4 pb-3 border-b">
                                    <p class="text-sm text-gray-500">PR번호: <span class="font-bold text-gray-800">${data.prId}</span></p>
                                    <p class="text-sm text-gray-500">자재번호: <span class="font-bold text-gray-800">${data.materialNo}</span></p>
                                    <p class="text-sm text-gray-500 truncate" title="${data.description}">내역: ${(data.description || '').substring(0, 40)}...</p>
                                </div>
                                <div class="mb-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded text-sm font-bold ${
                                            data.method === '자재+내역 일치' ? 'bg-blue-100 text-blue-800' :
                                            data.method === '도면 유사 사양가' ? 'bg-purple-100 text-purple-800' :
                                            data.method === '자재별 그룹 단가 평균' ? 'bg-green-100 text-green-800' :
                                            'bg-orange-100 text-orange-800'
                                        }">${data.method}</span>
                                        <span class="text-lg font-bold">₩${(data.estimatedPrice || 0).toLocaleString()}</span>
                                    </div>
                                </div>
                                ${detailHtml}
                            </div>
                            <div class="p-4 border-t bg-gray-50">
                                <button onclick="document.getElementById('priceReasoningModal').remove()" class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700">닫기</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 기존 모달 제거 후 새 모달 추가
                document.getElementById('priceReasoningModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error fetching price reasoning:', error);
                alert('근거 정보를 가져오는 중 오류가 발생했습니다.');
            }
        }
        
        function filterPriceList(filterType) {
            s5PriceFilter = filterType;
            
            // Update card selection styles
            ['card_exact', 'card_group', 'card_llm', 'card_default'].forEach(id => {
                document.getElementById(id)?.classList.remove('ring-2', 'ring-blue-500', 'ring-green-500', 'ring-purple-500', 'ring-orange-500');
            });
            
            let filtered = [...quotationData];
            let filterLabel = '';
            
            if (filterType === '자재+내역 일치') {
                filtered = quotationData.filter(pr => pr['예정가_산정방법'] === '자재+내역 일치');
                document.getElementById('card_exact')?.classList.add('ring-2', 'ring-blue-500');
                filterLabel = '(자재+내역 일치)';
            } else if (filterType === '자재별 그룹 단가 평균') {
                filtered = quotationData.filter(pr => pr['예정가_산정방법'] === '자재별 그룹 단가 평균');
                document.getElementById('card_group')?.classList.add('ring-2', 'ring-green-500');
                filterLabel = '(자재별 그룹 단가 평균)';
            } else if (filterType === '도면 유사') {
                filtered = quotationData.filter(pr => pr['예정가_산정방법'] === '도면 유사 사양가');
                document.getElementById('card_llm')?.classList.add('ring-2', 'ring-purple-500');
                filterLabel = '(도면 유사 사양가)';
            } else if (filterType === '기본값') {
                filtered = quotationData.filter(pr => pr['예정가_산정방법'] === '기본값');
                document.getElementById('card_default')?.classList.add('ring-2', 'ring-orange-500');
                filterLabel = '(기본값)';
            }
            
            // 검색 필터링
            const searchTerm = (document.getElementById('s5_priceSearch')?.value || '').toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(pr => 
                    (pr['구매요청'] || '').toLowerCase().includes(searchTerm) ||
                    (pr['자재번호'] || '').toLowerCase().includes(searchTerm) ||
                    (pr['내역'] || '').toLowerCase().includes(searchTerm)
                );
            }
            
            document.getElementById('s5_priceFilter').textContent = filterLabel;
            document.getElementById('s5_priceCount').textContent = `${filtered.length}건`;
            
            document.getElementById('s5_priceList').innerHTML = filtered.map((pr, idx) => {
                const originalIdx = quotationData.indexOf(pr);
                const recentPrice = pr['최근발주단가'] || 0;
                const method = pr['예정가_산정방법'] || '-';
                const showReasonBtn = method === '도면 유사 사양가' || method === '자재별 그룹 단가 평균';
                return `
                <tr class="border-b hover:bg-gray-50 ${pr['예정가_산정방법'] === '기본값' ? 'bg-orange-50' : ''}" id="price-row-${originalIdx}">
                    <td class="px-2 py-2 text-xs">${pr['예정가_산정방법'] === '기본값' ? '⚠️' : '✅'} ${pr['구매요청'] || '-'}</td>
                    <td class="px-2 py-2 text-xs text-gray-600">${pr['자재번호'] || '-'}</td>
                    <td class="px-2 py-2 text-xs truncate max-w-[100px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 12)}${(pr['내역']?.length > 12) ? '...' : ''}</td>
                    <td class="px-2 py-2">
                        <div class="flex items-center gap-1">
                            <span class="px-1 py-0.5 rounded text-xs ${
                                pr['예정가_산정방법'] === '자재+내역 일치' ? 'bg-blue-100 text-blue-800' :
                                pr['예정가_산정방법'] === '도면 유사 사양가' ? 'bg-purple-100 text-purple-800' :
                                pr['예정가_산정방법'] === '자재별 그룹 단가 평균' ? 'bg-green-100 text-green-800' :
                                'bg-orange-100 text-orange-800'
                            }">${method}</span>
                            ${showReasonBtn ? `<button onclick="showPriceReasoning('${pr['구매요청']}')" class="px-1 py-0.5 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200" title="산정 근거 보기">📋</button>` : ''}
                        </div>
                    </td>
                    <td class="px-2 py-2 text-center text-xs text-gray-500">
                        ${pr['최근발주일'] || '2025-12-15'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs text-gray-600">
                        ${recentPrice > 0 ? '₩' + recentPrice.toLocaleString() : '-'}
                    </td>
                    <td class="px-2 py-2 text-right text-xs">
                        <span id="price-value-${originalIdx}" class="font-semibold">₩${(pr['입찰예정가'] || 0).toLocaleString()}</span>
                        <span id="price-adjust-${originalIdx}" class="text-xs text-gray-500 ml-1"></span>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <button onclick="adjustPrice(${originalIdx}, -5)" class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">-5%</button>
                            <button onclick="adjustPrice(${originalIdx}, 5)" class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200">+5%</button>
                            <input type="number" id="manual-price-${originalIdx}" placeholder="직접입력" 
                                class="w-20 px-1 py-0.5 text-xs border rounded text-right"
                                onchange="setManualPrice(${originalIdx}, this.value)">
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        // 가격 조정 추적 객체
        let priceAdjustments = {};
        
        function adjustPrice(idx, percent) {
            const pr = quotationData[idx];
            if (!pr) return;
            
            const originalPrice = pr['입찰예정가_원본'] || pr['입찰예정가'] || 0;
            
            // 원본 가격 저장 (처음 조정시)
            if (!pr['입찰예정가_원본']) {
                pr['입찰예정가_원본'] = pr['입찰예정가'] || 0;
            }
            
            // 현재 조정 비율 계산
            const currentAdjust = priceAdjustments[idx] || 0;
            const newAdjust = currentAdjust + percent;
            
            // 조정 비율 제한 (-50% ~ +50%)
            if (newAdjust < -50 || newAdjust > 50) {
                alert('가격 조정 범위는 -50% ~ +50% 입니다.');
                return;
            }
            
            priceAdjustments[idx] = newAdjust;
            
            // 새 가격 계산
            const newPrice = Math.round(originalPrice * (1 + newAdjust / 100));
            pr['입찰예정가'] = newPrice;
            
            // UI 업데이트
            const priceEl = document.getElementById(`price-value-${idx}`);
            const adjustEl = document.getElementById(`price-adjust-${idx}`);
            
            if (priceEl) {
                priceEl.textContent = `₩${newPrice.toLocaleString()}`;
                priceEl.className = newAdjust !== 0 ? 'font-bold text-blue-600' : '';
            }
            if (adjustEl) {
                if (newAdjust !== 0) {
                    adjustEl.textContent = `(${newAdjust > 0 ? '+' : ''}${newAdjust}%)`;
                    adjustEl.className = `text-xs ml-1 ${newAdjust > 0 ? 'text-green-600' : 'text-red-600'}`;
                } else {
                    adjustEl.textContent = '';
                }
            }
        }

        // 수기 가격 입력
        function setManualPrice(idx, value) {
            const pr = quotationData[idx];
            if (!pr) return;
            
            const newPrice = parseInt(value) || 0;
            if (newPrice <= 0) return;
            
            // 원본 가격 저장
            if (!pr['입찰예정가_원본']) {
                pr['입찰예정가_원본'] = pr['입찰예정가'] || 0;
            }
            
            pr['입찰예정가'] = newPrice;
            priceAdjustments[idx] = 'manual';
            
            // UI 업데이트
            const priceEl = document.getElementById(`price-value-${idx}`);
            const adjustEl = document.getElementById(`price-adjust-${idx}`);
            
            if (priceEl) {
                priceEl.textContent = `₩${newPrice.toLocaleString()}`;
                priceEl.className = 'font-bold text-purple-600';
            }
            if (adjustEl) {
                adjustEl.textContent = '(수기)';
                adjustEl.className = 'text-xs ml-1 text-purple-600';
            }
        }

        // 견적 요청 발송
        function sendQuotationRequest() {
            const eligibleCount = quotationData.filter(pr => !pr['견적제외']).length;
            alert(`${eligibleCount}건이 견적 의뢰되었습니다.`);
        }

        // ============================================
        // STEP 6: 견적 수신 확인 (Mock)
        // ============================================
        function populateStep6() {
            if (!quotationData.length) return;
            
            // Initialize mock status if not done
            if (Object.keys(mockQuoteStatus).length === 0) {
                quotationData.forEach((pr, idx) => {
                    const rand = Math.random();
                    mockQuoteStatus[pr['구매요청']] = {
                        status: rand < 0.7 ? 'received' : rand < 0.9 ? 'pending' : 'overdue',
                        amount: pr['입찰예정가'] ? Math.round(pr['입찰예정가'] * (0.85 + Math.random() * 0.2)) : 0,
                        date: rand < 0.7 ? '2026-01-02 14:' + String(Math.floor(Math.random() * 60)).padStart(2, '0') : '-'
                    };
                });
            }
            
            const received = Object.values(mockQuoteStatus).filter(s => s.status === 'received').length;
            const pending = Object.values(mockQuoteStatus).filter(s => s.status === 'pending').length;
            const overdue = Object.values(mockQuoteStatus).filter(s => s.status === 'overdue').length;
            
            document.getElementById('s6_received').textContent = received;
            document.getElementById('s6_pending').textContent = pending;
            document.getElementById('s6_overdue').textContent = overdue;
            
            document.getElementById('s6_quoteList').innerHTML = quotationData.slice(0, 30).map(pr => {
                const status = mockQuoteStatus[pr['구매요청']] || { status: 'pending', amount: 0, date: '-' };
                const statusBadge = status.status === 'received' ? '<span class="px-1 py-0.5 bg-green-100 text-green-800 rounded text-xs">✅ 수신</span>' :
                                   status.status === 'pending' ? '<span class="px-1 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">⏳ 대기</span>' :
                                   '<span class="px-1 py-0.5 bg-red-100 text-red-800 rounded text-xs">🔴 미응답</span>';
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">${pr['구매요청'] || '-'}</td>
                        <td class="px-3 py-2">${pr['매칭업체명'] || '-'}</td>
                        <td class="px-3 py-2">${statusBadge}</td>
                        <td class="px-3 py-2 text-right">${status.status === 'received' ? '₩' + status.amount.toLocaleString() : '-'}</td>
                        <td class="px-3 py-2">${status.date}</td>
                    </tr>
                `;
            }).join('');
        }

        function mockOpenQuotes() {
            alert('견적 오픈 완료! (Mock 시뮬레이션)\n\n- 대기중 견적: 수신 상태로 변경됨');
            Object.keys(mockQuoteStatus).forEach(key => {
                if (mockQuoteStatus[key].status === 'pending') {
                    mockQuoteStatus[key].status = 'received';
                    mockQuoteStatus[key].date = '2026-01-02 15:' + String(Math.floor(Math.random() * 60)).padStart(2, '0');
                }
            });
            populateStep6();
        }

        function sendReminderEmails() {
            const overdueCount = Object.values(mockQuoteStatus).filter(s => s.status === 'overdue').length;
            showSuccess('독려메일 발송 완료', `${overdueCount}개 업체에 독려메일이 발송되었습니다. (Mock)`);
        }

        // ============================================
        // STEP 7: HITL 검토
        // ============================================
        let s7ViewFilter = 'review';  // 디폴트: 검토필요
        
        function populateStep7() {
            if (!processingResults) return;
            
            // 자동완료 항목은 자동으로 "적정" 처리
            quotationData.forEach(pr => {
                if (!pr['HITL필요'] && !pr['검토결과']) {
                    pr['검토결과'] = '적정';
                }
            });
            
            const allItems = quotationData;
            const hitlItems = quotationData.filter(pr => pr['HITL필요'] && !pr['검토결과']);
            const appropriateItems = quotationData.filter(pr => pr['검토결과'] === '적정');
            const requoteItems = quotationData.filter(pr => pr['검토결과'] === '재견적');
            const conditionalItems = quotationData.filter(pr => pr['검토결과'] === '조건부 승인');
            
            document.getElementById('hitlTotalCount').textContent = hitlItems.length;
            
            // Drop List 카운트 업데이트 (자동완료 삭제)
            const selectEl = document.getElementById('s7_viewFilter');
            if (selectEl) {
                selectEl.innerHTML = `
                    <option value="all">전체 (${allItems.length}건)</option>
                    <option value="review">검토필요 (${hitlItems.length}건)</option>
                    <option value="appropriate">적정 (${appropriateItems.length}건)</option>
                    <option value="requote">재견적 요청 (${requoteItems.length}건)</option>
                    <option value="conditional">조건부 승인 (${conditionalItems.length}건)</option>
                `;
                selectEl.value = s7ViewFilter;
            }
            
            filterHitlList(s7ViewFilter);
        }
        
        function filterHitlList(filterType) {
            s7ViewFilter = filterType;
            
            let filteredItems;
            if (filterType === 'review') {
                filteredItems = quotationData.filter(pr => pr['HITL필요'] && !pr['검토결과']);
            } else if (filterType === 'appropriate') {
                filteredItems = quotationData.filter(pr => pr['검토결과'] === '적정');
            } else if (filterType === 'requote') {
                filteredItems = quotationData.filter(pr => pr['검토결과'] === '재견적');
            } else if (filterType === 'conditional') {
                filteredItems = quotationData.filter(pr => pr['검토결과'] === '조건부 승인');
            } else {
                filteredItems = quotationData;
            }
            
            if (filteredItems.length === 0) {
                document.getElementById('noHitlMessage').classList.remove('hidden');
                document.getElementById('hitlList').classList.add('hidden');
                return;
            }
            
            document.getElementById('noHitlMessage').classList.add('hidden');
            document.getElementById('hitlList').classList.remove('hidden');
            
            document.getElementById('hitlList').innerHTML = filteredItems.map(pr => {
                const orderDate = pr['최근발주일'] || '2025-12-15';
                const reviewResult = pr['검토결과'] || (pr['HITL필요'] ? '검토 필요' : '적정');
                const resultBgClass = reviewResult === '적정' ? 'bg-green-100 text-green-800' :
                                      reviewResult === '재견적' ? 'bg-red-100 text-red-800' :
                                      reviewResult === '조건부 승인' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-orange-100 text-orange-800';
                
                return `
                <div class="border rounded-lg p-4 hover:shadow transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="font-bold">${pr['구매요청']}</span>
                            <span class="text-sm text-gray-500 ml-2">${pr['계약방식'] || '-'}</span>
                        </div>
                        <span class="px-2 py-1 rounded text-xs ${resultBgClass}">${reviewResult}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2 truncate">${pr['내역'] || '-'}</p>
                    <div class="grid grid-cols-5 gap-2 text-xs mb-3">
                        <div><span class="text-gray-500">견적가</span><p class="font-medium">₩${(pr['Mock_견적금액'] || pr['입찰예정가'] || 0).toLocaleString()}</p></div>
                        <div><span class="text-gray-500">최근발주일</span><p class="font-medium">${orderDate}</p></div>
                        <div><span class="text-gray-500">발주단가</span><p class="font-medium">₩${(pr['최근발주단가'] || 0).toLocaleString()}</p></div>
                        <div><span class="text-gray-500">입찰예정가</span><p class="font-medium">₩${(pr['입찰예정가'] || 0).toLocaleString()}</p></div>
                        <div><span class="text-gray-500">단가변동률</span><p class="font-medium ${(pr['단가변동률'] || 0) > 15 ? 'text-red-600' : ''}">${(pr['단가변동률'] || 0).toFixed(1)}%</p></div>
                    </div>
                    <div class="flex justify-end">
                        ${pr['HITL필요'] ? `
                        <button onclick="openHitlModal('${pr['구매요청']}')" class="px-4 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">
                            검토하기 →
                        </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // ============================================
        // STEP 8: 견적 비교 분석 (Mock)
        // ============================================
        function populateStep8() {
            if (!processingResults) return;
            const summary = processingResults.summary;
            
            document.getElementById('s8_time').textContent = summary.processingTime || '0';
            document.getElementById('s8_tokens').textContent = (summary.llmCalls * 1200).toLocaleString();
            
            // 견적 경쟁력 계산
            let excellent = 0, normal = 0, poor = 0;
            
            const comparisonData = quotationData.map(pr => {
                const quoteStatus = mockQuoteStatus[pr['구매요청']] || { status: 'pending', amount: 0 };
                // 견적단가: Mock 수신된 가격 또는 예정가의 85~105% 랜덤
                const quotePrice = quoteStatus.status === 'received' ? quoteStatus.amount : 
                    Math.round((pr['입찰예정가'] || 0) * (0.85 + Math.random() * 0.2));
                const estimatedPrice = pr['입찰예정가'] || 0;  // 예정단가
                const recentOrderPrice = pr['최근발주단가'] || 0;  // 최근발주단가
                
                // 경쟁력 판단
                let competitiveness, signal, bgClass;
                if (quotePrice <= estimatedPrice) {
                    // 견적단가 ≤ 예정단가: 우수
                    competitiveness = '우수';
                    signal = '🟢';
                    bgClass = 'bg-green-100 text-green-800';
                    excellent++;
                } else if (recentOrderPrice > 0 && quotePrice <= recentOrderPrice) {
                    // 예정단가 < 견적단가 ≤ 최근발주단가: 보통
                    competitiveness = '보통';
                    signal = '🟡';
                    bgClass = 'bg-yellow-100 text-yellow-800';
                    normal++;
                } else {
                    // 견적단가 > 예정단가 & 최근발주단가: 열위
                    competitiveness = '열위';
                    signal = '🔴';
                    bgClass = 'bg-red-100 text-red-800';
                    poor++;
                }
                
                return { pr, quotePrice, estimatedPrice, recentOrderPrice, competitiveness, signal, bgClass };
            });
            
            // 요약 카드 업데이트
            document.getElementById('s8_excellent').textContent = excellent;
            document.getElementById('s8_normal').textContent = normal;
            document.getElementById('s8_poor').textContent = poor;
            
            // 검토결과별 집계 - 실제 검토 데이터 기반 (자동완료는 적정으로 처리됨)
            let appropriate = 0, requote = 0, conditional = 0;
            let needReview = 0;
            quotationData.forEach(pr => {
                const result = pr['검토결과'];
                if (result === '적정') {
                    appropriate++;
                } else if (result === '재견적') {
                    requote++;
                } else if (result === '조건부 승인') {
                    conditional++;
                } else if (pr['HITL필요']) {
                    needReview++;  // 아직 검토되지 않은 항목
                } else {
                    // 자동완료 항목도 적정으로 카운트
                    appropriate++;
                }
            });
            
            // 검토결과 카드 업데이트
            document.getElementById('s8_appropriate').textContent = appropriate;
            document.getElementById('s8_requote').textContent = requote;
            document.getElementById('s8_conditional').textContent = conditional;
            
            // 테이블 렌더링 (순서: PR번호 → 자재번호 → 자재내역 → 선정업체 → 최근발주일 → 최근발주단가 → 예정단가 → 견적단가 → 절감율 → 경쟁력 → 검토결과)
            document.getElementById('s8_comparisonList').innerHTML = comparisonData.slice(0, 50).map(item => {
                const { pr, quotePrice, estimatedPrice, recentOrderPrice, competitiveness, signal, bgClass } = item;
                
                // 절감율 계산: (예정단가 - 견적단가) / 예정단가 * 100
                // 양수면 절감, 음수면 초과
                const savingsRate = estimatedPrice > 0 ? ((estimatedPrice - quotePrice) / estimatedPrice * 100) : 0;
                const savingsClass = savingsRate >= 0 ? 'text-blue-600' : 'text-red-600';
                const savingsSign = savingsRate >= 0 ? '▼' : '▲';
                
                const orderDate = pr['최근발주일'] || '2025-12-15';
                
                // 검토결과: 실제 검토 데이터 기반 (자동완료는 적정으로 표시)
                let reviewResult;
                let reviewBgClass;
                if (pr['검토결과']) {
                    reviewResult = pr['검토결과'];
                    reviewBgClass = reviewResult === '적정' ? 'bg-blue-100 text-blue-800' :
                                    reviewResult === '재견적' ? 'bg-orange-100 text-orange-800' :
                                    reviewResult === '조건부 승인' ? 'bg-purple-100 text-purple-800' :
                                    'bg-gray-100 text-gray-800';
                } else if (pr['HITL필요']) {
                    reviewResult = '검토 필요';
                    reviewBgClass = 'bg-red-100 text-red-800';
                } else {
                    // 자동완료도 적정으로 표시
                    reviewResult = '적정';
                    reviewBgClass = 'bg-blue-100 text-blue-800';
                }
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">${pr['구매요청'] || '-'}</td>
                        <td class="px-3 py-2 text-xs text-gray-600">${pr['자재번호'] || '-'}</td>
                        <td class="px-3 py-2 text-xs truncate max-w-[100px]" title="${pr['내역'] || ''}">${(pr['내역'] || '-').substring(0, 10)}${(pr['내역']?.length > 10) ? '...' : ''}</td>
                        <td class="px-3 py-2">${pr['매칭업체명'] || '-'}</td>
                        <td class="px-3 py-2 text-center text-xs text-gray-500">${orderDate}</td>
                        <td class="px-3 py-2 text-right">${recentOrderPrice > 0 ? '₩' + recentOrderPrice.toLocaleString() : '-'}</td>
                        <td class="px-3 py-2 text-right">₩${estimatedPrice.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right font-medium">₩${quotePrice.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right font-medium ${savingsClass}">${savingsSign} ${Math.abs(savingsRate).toFixed(1)}%</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${bgClass}">${competitiveness}</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${reviewBgClass}">${reviewResult}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // PO 발행 기능
        // ============================================
        function issuePurchaseOrders() {
            if (!quotationData || quotationData.length === 0) {
                alert('발행할 PO 데이터가 없습니다.');
                return;
            }
            
            // 발행 대상: 승인완료 또는 자동완료 상태인 항목
            const issuableItems = quotationData.filter(pr => 
                pr['처리상태'] === '자동완료' || pr['승인상태'] === '승인완료'
            );
            
            // 발행 대상이 없으면 전체 건수로 표시 (PoC용)
            const totalCount = issuableItems.length > 0 ? issuableItems.length : quotationData.length;
            
            // 경쟁력별 집계
            let excellent = 0, normal = 0, poor = 0;
            let totalAmount = 0;
            
            quotationData.forEach(pr => {
                const quoteStatus = mockQuoteStatus[pr['구매요청']] || { status: 'pending', amount: 0 };
                const quotePrice = quoteStatus.status === 'received' ? quoteStatus.amount : 
                    Math.round((pr['입찰예정가'] || 0) * (0.85 + Math.random() * 0.2));
                const estimatedPrice = pr['입찰예정가'] || 0;
                const recentOrderPrice = pr['최근발주단가'] || 0;
                
                totalAmount += quotePrice;
                
                if (quotePrice <= estimatedPrice) {
                    excellent++;
                } else if (recentOrderPrice > 0 && quotePrice <= recentOrderPrice) {
                    normal++;
                } else {
                    poor++;
                }
            });
            
            // 모달 내용 설정
            document.getElementById('poIssueContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-3xl font-bold text-blue-600">${totalCount}건</p>
                        <p class="text-sm text-blue-700">PO 발행 완료</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div class="bg-green-50 rounded p-2">
                            <p class="font-bold text-green-600">${excellent}건</p>
                            <p class="text-xs text-gray-600">🟢 우수</p>
                        </div>
                        <div class="bg-yellow-50 rounded p-2">
                            <p class="font-bold text-yellow-600">${normal}건</p>
                            <p class="text-xs text-gray-600">🟡 보통</p>
                        </div>
                        <div class="bg-red-50 rounded p-2">
                            <p class="font-bold text-red-600">${poor}건</p>
                            <p class="text-xs text-gray-600">🔴 열위</p>
                        </div>
                    </div>
                    <div class="border-t pt-3">
                        <p class="text-sm text-gray-600">총 발주금액</p>
                        <p class="text-xl font-bold text-gray-800">₩${totalAmount.toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            // 모달 표시
            document.getElementById('poIssueModal').classList.remove('hidden');
        }
        
        function closePoIssueModal() {
            document.getElementById('poIssueModal').classList.add('hidden');
        }

        // ============================================
        // MODALS
        // ============================================
        async function openHitlModal(prId) {
            const pr = quotationData.find(p => p['구매요청'] === prId);
            if (!pr) return;

            document.getElementById('modalPrId').textContent = prId;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h4 class="font-medium text-orange-800 mb-2">📌 검토 사유</h4>
                        <div class="bg-white rounded p-3 space-y-2 text-sm">
                            <div class="flex justify-between"><span>견적단가</span><span class="font-medium">₩${Math.round(pr['견적단가'] || pr['입찰예정가'] * 0.95 || 0).toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>입찰예정가</span><span class="font-medium">₩${(pr['입찰예정가'] || 0).toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>최근발주단가</span><span class="font-medium">₩${Math.round(pr['최근발주단가'] || 0).toLocaleString()}</span></div>
                            <hr>
                            <div class="flex justify-between"><span>단가변동률</span><span class="font-medium ${(pr['단가변동률'] || 0) > 15 ? 'text-red-600' : ''}">${(pr['단가변동률'] || 0).toFixed(1)}%</span></div>
                        </div>
                        <div id="llmRecommendation" class="mt-3 p-3 bg-purple-50 rounded text-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="font-medium text-purple-800">🧠 AI 추천 의견</p>
                                <button onclick="requestLLMRecommendation('${prId}')" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700">
                                    AI 분석 요청
                                </button>
                            </div>
                            <div id="llmContent-${prId}" class="text-gray-700">
                                ${pr['LLM추천'] ? renderLLMRecommendation(pr['LLM추천']) : '<p class="text-gray-500">AI 분석을 요청하면 추천 의견을 제공합니다.</p>'}
                            </div>
                        </div>
                    </div>
                    <div class="border rounded-lg p-4">
                        <h4 class="font-medium mb-3">담당자 결정</h4>
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="radio" name="decision" value="approve" class="mr-2"><span>적정 (진행)</span></label>
                            <label class="flex items-center"><input type="radio" name="decision" value="renegotiate" class="mr-2"><span>재견적 요청</span></label>
                            <label class="flex items-center"><input type="radio" name="decision" value="conditional" class="mr-2" checked><span>조건부 승인</span></label>
                        </div>
                        <div class="mt-4">
                            <label class="text-sm text-gray-600">조건/사유:</label>
                            <textarea id="decisionReason" class="w-full border rounded p-2 mt-1 text-sm" rows="2" placeholder="결정 사유...">품질보증기간 2년 조건 추가 후 진행</textarea>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('hitlModal').classList.remove('hidden');
            document.getElementById('hitlModal').dataset.prId = prId;
        }
        
        // LLM 추천 의견 렌더링
        function renderLLMRecommendation(rec) {
            if (!rec || !rec.추천결정) return '<p class="text-gray-500">분석 결과가 없습니다.</p>';
            
            const decisionColor = rec.추천결정 === '승인' ? 'text-green-700 bg-green-100' : 
                                  rec.추천결정 === '반려' ? 'text-red-700 bg-red-100' : 'text-yellow-700 bg-yellow-100';
            
            return `
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="font-medium">추천:</span>
                        <span class="px-2 py-0.5 rounded text-xs font-medium ${decisionColor}">${rec.추천결정}</span>
                    </div>
                    <p><strong>의견:</strong> ${rec.검토의견 || '-'}</p>
                    ${rec.주요근거?.length ? `<p><strong>근거:</strong> ${rec.주요근거.join(', ')}</p>` : ''}
                    ${rec.위험요소 ? `<p class="text-red-600"><strong>⚠️ 위험:</strong> ${rec.위험요소}</p>` : ''}
                    ${rec.추가조치 ? `<p><strong>추가조치:</strong> ${rec.추가조치}</p>` : ''}
                </div>
            `;
        }
        
        // LLM 추천 요청
        async function requestLLMRecommendation(prId) {
            const contentEl = document.getElementById(`llmContent-${prId}`);
            contentEl.innerHTML = '<p class="text-purple-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI 분석 중...</p>';
            
            try {
                const response = await fetch('/api/llm/hitl-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prId })
                });
                
                const data = await response.json();
                
                if (data.success && data.recommendation) {
                    // 결과 저장
                    const pr = quotationData.find(p => p['구매요청'] === prId);
                    if (pr) pr['LLM추천'] = data.recommendation;
                    
                    contentEl.innerHTML = renderLLMRecommendation(data.recommendation);
                } else if (data.fallback) {
                    contentEl.innerHTML = renderLLMRecommendation(data.fallback);
                } else {
                    contentEl.innerHTML = `<p class="text-red-500">분석 실패: ${data.error || '알 수 없는 오류'}</p>`;
                }
            } catch (error) {
                contentEl.innerHTML = `<p class="text-red-500">오류: ${error.message}</p>`;
            }
        }

        function closeHitlModal() {
            document.getElementById('hitlModal').classList.add('hidden');
        }

        function submitHitlDecision() {
            const prId = document.getElementById('hitlModal').dataset.prId;
            const pr = quotationData.find(p => p['구매요청'] === prId);
            if (pr) {
                // 선택된 결정 가져오기
                const decision = document.querySelector('input[name="decision"]:checked')?.value;
                const reason = document.getElementById('decisionReason')?.value || '';
                
                // 결정에 따른 검토결과 설정
                if (decision === 'approve') {
                    pr['검토결과'] = '적정';
                } else if (decision === 'renegotiate') {
                    pr['검토결과'] = '재견적';
                } else if (decision === 'conditional') {
                    pr['검토결과'] = '조건부 승인';
                }
                
                pr['검토사유'] = reason;
                pr['처리상태'] = '검토완료';
                pr['HITL필요'] = false;
            }
            closeHitlModal();
            renderPRList();
            populateStep7();
            showSuccess('결정 완료', '검토 결과가 저장되었습니다.');
        }

        async function approvePR(prId) {
            try {
                await axios.post(`/api/quotations/${prId}/approve`);
                const pr = quotationData.find(p => p['구매요청'] === prId);
                if (pr) pr['승인상태'] = '승인완료';
                showSuccess('승인 완료', `PR ${prId}가 승인되었습니다.`);
                renderPRList();
                renderDetailView(prId);
            } catch (e) {
                alert('승인 실패: ' + (e.response?.data?.error || e.message));
            }
        }
        
        // ============================================
        // LLM Functions for Step 8 and Email
        // ============================================
        
        // Step 8: 견적 비교 종합 분석
        async function requestQuotationAnalysis() {
            const sectionEl = document.getElementById('llmAnalysisSection');
            const contentEl = document.getElementById('llmAnalysisContent');
            
            sectionEl.classList.remove('hidden');
            contentEl.innerHTML = '<p class="text-purple-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI 종합 분석 중... (10-20초 소요)</p>';
            
            try {
                const response = await fetch('/api/llm/quotation-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success && data.analysis) {
                    contentEl.innerHTML = renderQuotationAnalysis(data);
                } else if (data.fallback) {
                    contentEl.innerHTML = renderQuotationAnalysis(data.fallback);
                } else {
                    contentEl.innerHTML = `<p class="text-red-500">분석 실패: ${data.error || '알 수 없는 오류'}</p>`;
                }
            } catch (error) {
                contentEl.innerHTML = `<p class="text-red-500">오류: ${error.message}</p>`;
            }
        }
        
        function renderQuotationAnalysis(data) {
            const analysis = data.analysis || {};
            const stats = data.statistics || {};
            
            return `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white rounded p-3">
                        <p class="text-xs text-gray-500 mb-1">총 견적 건수</p>
                        <p class="text-xl font-bold">${stats.totalItems || '-'}건</p>
                    </div>
                    <div class="bg-white rounded p-3">
                        <p class="text-xs text-gray-500 mb-1">총 견적 금액</p>
                        <p class="text-xl font-bold">₩${(stats.totalAmount || 0).toLocaleString()}</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-white rounded p-3">
                        <p class="font-medium text-purple-800 mb-1">📋 종합평가</p>
                        <p>${analysis.종합평가 || '-'}</p>
                    </div>
                    
                    <div class="bg-white rounded p-3">
                        <p class="font-medium text-purple-800 mb-1">📊 경쟁력분석</p>
                        <p>${analysis.경쟁력분석 || '-'}</p>
                    </div>
                    
                    ${analysis.위험항목?.length ? `
                    <div class="bg-red-50 rounded p-3">
                        <p class="font-medium text-red-800 mb-1">⚠️ 위험항목</p>
                        <ul class="list-disc list-inside text-sm">
                            ${analysis.위험항목.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    
                    <div class="bg-green-50 rounded p-3">
                        <p class="font-medium text-green-800 mb-1">💰 비용절감기회</p>
                        <p>${analysis.비용절감기회 || '-'}</p>
                    </div>
                </div>
            `;
        }
        
        // 누락 PR 이메일 생성
        async function generateMissingPREmail() {
            const contentEl = document.getElementById('batchEmailContent');
            if (!contentEl) return;
            
            contentEl.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>AI 이메일 생성 중...</p>';
            
            try {
                const response = await fetch('/api/llm/generate-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                const email = data.success ? data.email : data.fallback;
                
                if (email) {
                    contentEl.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-600">제목</label>
                                <input type="text" class="w-full border rounded p-2 mt-1" value="${email.제목 || ''}" readonly>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">중요도: <span class="font-medium">${email.중요도 || '보통'}</span></label>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">본문</label>
                                <div class="border rounded p-3 mt-1 bg-gray-50 text-sm max-h-48 overflow-y-auto">${email.본문 || ''}</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">조치기한: <span class="font-medium">${email.조치기한 || '-'}</span></label>
                            </div>
                            ${email.담당부서?.length ? `
                            <div>
                                <label class="text-sm text-gray-600">담당부서</label>
                                <p class="mt-1">${email.담당부서.join(', ')}</p>
                            </div>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                contentEl.innerHTML = `<p class="text-red-500">오류: ${error.message}</p>`;
            }
        }

        // Email Modals
        function openBatchEmailModal() {
            const invalidPR = processingResults?.invalidPR || [];
            if (invalidPR.length === 0) { alert('발송할 누락 PR이 없습니다.'); return; }
            const grouped = {};
            invalidPR.forEach(pr => {
                const manager = pr['담당자'] || pr['구매요청자'] || '담당자미지정';
                if (!grouped[manager]) grouped[manager] = [];
                grouped[manager].push(pr);
            });
            let managerList = '';
            Object.entries(grouped).forEach(([manager, prs]) => {
                managerList += `<p class="text-sm">• ${manager}: ${prs.length}건</p>`;
            });
            document.getElementById('batchEmailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="font-medium mb-2">발송 대상: ${Object.keys(grouped).length}명</p>
                        ${managerList}
                    </div>
                    <p class="text-gray-600">총 <strong>${invalidPR.length}건</strong>의 누락 PR 안내 메일을 발송합니다.</p>
                    <button onclick="generateMissingPREmail()" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                        🧠 AI로 이메일 내용 생성
                    </button>
                </div>
            `;
            document.getElementById('batchEmailModal').classList.remove('hidden');
        }

        function closeBatchEmailModal() {
            document.getElementById('batchEmailModal').classList.add('hidden');
        }

        function sendBatchEmails() {
            const invalidPR = processingResults?.invalidPR || [];
            const grouped = {};
            invalidPR.forEach(pr => {
                const manager = pr['담당자'] || pr['구매요청자'] || '담당자미지정';
                if (!grouped[manager]) grouped[manager] = [];
                grouped[manager].push(pr);
            });
            invalidPR.forEach((pr, idx) => { sentEmails[idx] = { sentAt: new Date().toISOString() }; });
            closeBatchEmailModal();
            showSuccess('이메일 발송 완료', `${Object.keys(grouped).length}명에게 ${invalidPR.length}건의 메일이 발송되었습니다.`);
        }

        function openEmailPreview(prIndex) {
            const invalidPR = processingResults?.invalidPR || [];
            const pr = invalidPR[prIndex];
            if (!pr) return;
            const manager = pr['담당자'] || pr['구매요청자'] || '담당자미지정';
            document.getElementById('emailPreviewContent').innerHTML = `
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <p class="text-sm"><strong>To:</strong> ${manager}</p>
                        <p class="text-sm"><strong>Subject:</strong> [PR 필수항목 누락] 정보 업데이트 요청</p>
                    </div>
                    <div class="p-4 space-y-3 text-sm">
                        <p>안녕하세요, <strong>${manager}</strong>님</p>
                        <p>아래 구매요청 건에 필수항목이 누락되어 처리가 불가합니다.</p>
                        <div class="bg-gray-50 border rounded p-3">
                            <p><strong>PR번호:</strong> ${pr['구매요청'] || '-'}</p>
                            <p><strong>자재번호:</strong> ${pr['자재번호'] || '-'}</p>
                            <p><strong>누락항목:</strong> <span class="text-red-600">${pr['누락항목'] || '-'}</span></p>
                        </div>
                        <p>감사합니다.<br>구매팀 AI Agent</p>
                    </div>
                </div>
            `;
            document.getElementById('emailPreviewModal').classList.remove('hidden');
        }

        function closeEmailPreviewModal() {
            document.getElementById('emailPreviewModal').classList.add('hidden');
        }

        function showSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        // Final Actions
        async function downloadExcel() {
            try {
                const response = await axios.get('/api/export', { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'PR_PO_Agent_Result.xlsx');
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (e) {
                alert('다운로드 실패: ' + e.message);
            }
        }

        function batchSRMTransfer() {
            const autoCompletePRs = quotationData.filter(p => p['처리상태'] === '자동완료');
            if (!confirm(`${autoCompletePRs.length}건을 SRM으로 일괄 전송하시겠습니까?`)) return;
            showSuccess('SRM 전송 완료', `${autoCompletePRs.length}건이 SRM으로 전송되었습니다. (시뮬레이션)`);
        }
    </script>
</body>
</html>
